<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LockNAC - Gerenciamento de Armários</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            /* Core palette */
            --primary-color: #3B82F6;
            --secondary-color: #10B981;
            --success-color: #22C55E;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --primary-dark: #1D4ED8;
            --danger-dark: #991B1B;

            /* Neutrals */
            --dark-color: #1F2937;
            --light-color: #F3F4F6;
            --text-color: var(--dark-color);
            --muted-color: #6B7280;
            --surface-color: #FFFFFF;
            --bg-color: #F9FAFB;
            --border-color: #E5E7EB;
            --shadow-color: rgba(15, 23, 42, 0.08);

            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;

            /* Misc */
            --focus-ring: rgba(59, 130, 246, 0.25);
            --sidebar-width: 250px;
            --em-uso-border-color: color-mix(in srgb, var(--primary-dark) 82%, black 18%);
            --em-uso-card-bg: color-mix(in srgb, var(--primary-color) 88%, black 12%);
            --em-uso-badge-bg: color-mix(in srgb, var(--primary-color) 18%, white 82%);
            --em-uso-badge-text: color-mix(in srgb, var(--primary-color) 92%, black 8%);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }
        /* Textura de cédula */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.2) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.15) 1px, transparent 1px);
            background-size: 50px 50px, 30px 30px;
            pointer-events: none;
            z-index: -1;
        }
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #014f51, color-mix(in srgb, #000000 75%, #0a5c65));
            color: white;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .sidebar-logo {
            max-width: 150px;
            width: 100%;
            height: auto;
            display: block;
        }
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .sidebar-header p {
            font-size: 0.85rem;
            opacity: 0.8;
            margin: 0;
        }
        .sidebar-menu {
            padding: 15px 0;
            flex: 1;
        }
        .sidebar-menu ul {
            list-style: none;
        }
        .sidebar-menu li {
            padding: 0;
        }
        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        .sidebar-menu a:hover {
            background-color: color-mix(in srgb, white 18%, transparent);
            border-left-color: var(--light-color);
        }
        .sidebar-menu a.active {
            background-color: color-mix(in srgb, white 22%, transparent);
            border-left-color: var(--light-color);
        }
        .sidebar-menu i {
            margin-right: 10px;
            width: 22px;
            text-align: center;
            font-size: 1.05rem;
        }
        .sidebar-footer {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-logout-button {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, border-color 0.3s ease;
        }
        .sidebar-logout-button:hover {
            background: rgba(255,255,255,0.18);
            border-color: rgba(255,255,255,0.35);
            transform: translateY(-1px);
        }
        .sidebar-logout-button i {
            font-size: 1rem;
        }
        /* Main Content */
        .app-shell {
            display: flex;
            width: 100%;
        }
        .hidden {
            display: none !important;
        }
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: all 0.3s;
        }
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid color-mix(in srgb, var(--dark-color) 8%, transparent);
        }
        .header-title h1 {
            font-size: 1.8rem;
            color: var(--dark-color);
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .header-selectors {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            flex-wrap: wrap;
        }
        .selector-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .selector-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        .selector-control {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--surface-color) 0%, color-mix(in srgb, var(--primary-color) 6%, white 94%) 100%);
            min-width: 220px;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            isolation: isolate;
        }
        .selector-control:hover {
            border-color: color-mix(in srgb, var(--primary-color) 60%, white 40%);
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
            transform: translateY(-1px);
        }
        .selector-control.open,
        .selector-control:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--focus-ring);
        }
        .selector-icon {
            color: var(--primary-color);
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .selector-trigger {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--dark-color);
        }
        .selector-trigger:focus {
            outline: none;
        }
        .selector-trigger-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        .selector-trigger-label {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        .selector-trigger-description {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--muted-color);
        }
        .selector-arrow {
            color: var(--muted-color);
            font-size: 0.9rem;
            transition: transform 0.2s ease, color 0.2s ease;
        }
        .selector-control.open .selector-arrow,
        .selector-control:focus-within .selector-arrow,
        .selector-control.open .selector-icon,
        .selector-control:focus-within .selector-icon {
            color: var(--primary-dark);
        }
        .selector-control.open .selector-arrow {
            transform: rotate(180deg);
        }
        .selector-dropdown {
            position: absolute;
            top: calc(100% + 12px);
            left: 0;
            width: 100%;
            background: var(--surface-color);
            border-radius: 16px;
            border: 1px solid color-mix(in srgb, var(--primary-color) 12%, var(--border-color) 88%);
            box-shadow: 0 24px 55px rgba(15, 23, 42, 0.18);
            padding: 12px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-8px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 50;
        }
        .selector-control.open .selector-dropdown {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        .selector-options {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 260px;
            overflow-y: auto;
        }
        .selector-option {
            width: 100%;
        }
        .selector-option-button {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            background: transparent;
            border: none;
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--dark-color);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .selector-option-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px var(--focus-ring);
        }
        .selector-option-button:hover:not(.is-disabled) {
            background: color-mix(in srgb, var(--primary-color) 14%, white 86%);
            transform: translateX(2px);
        }
        .selector-option-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .selector-option-icon,
        .selector-option-bullet {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: color-mix(in srgb, var(--primary-color) 12%, white 88%);
            color: var(--primary-dark);
            font-size: 1rem;
            flex-shrink: 0;
        }
        .selector-option-bullet {
            font-weight: 700;
            text-transform: uppercase;
        }
        .selector-option-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: flex-start;
        }
        .selector-option-label {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .selector-option-description {
            font-size: 0.75rem;
            color: var(--muted-color);
            max-width: 260px;
        }
        .selector-option-check {
            color: var(--primary-dark);
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        .selector-option-button.is-selected {
            background: color-mix(in srgb, var(--primary-color) 18%, white 82%);
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--primary-color) 30%, white 70%);
        }
        .selector-option-button.is-selected .selector-option-check {
            opacity: 1;
        }
        .selector-option-button.is-disabled {
            cursor: not-allowed;
            opacity: 0.55;
        }
        .selector-option-button.is-disabled .selector-option-description {
            color: color-mix(in srgb, var(--muted-color) 64%, white 36%);
        }
        .selector-options::-webkit-scrollbar {
            width: 8px;
        }
        .selector-options::-webkit-scrollbar-track {
            background: color-mix(in srgb, var(--surface-color) 70%, white 30%);
            border-radius: 10px;
        }
        .selector-options::-webkit-scrollbar-thumb {
            background: color-mix(in srgb, var(--primary-color) 45%, white 55%);
            border-radius: 10px;
        }
        .selector-native-input {
            position: absolute;
            inset: 0;
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
        }
        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--dark-color);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* SweetAlert custom form layout */
        .swal-form-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            text-align: left;
        }
        .swal-form-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
            border: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
            border-radius: 10px;
            background-color: color-mix(in srgb, var(--surface-color) 85%, var(--light-color) 15%);
            box-shadow: 0 8px 18px var(--shadow-color);
        }
        .swal-form-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .swal-form-section-title i {
            color: var(--primary-color);
        }
        .swal-form-fields {
            display: grid;
            gap: 12px;
        }
        .swal-form-fields.two-columns {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        .swal-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .swal-form-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        .swal-form-hint {
            font-size: 0.75rem;
            color: var(--muted-color);
            background: color-mix(in srgb, var(--light-color) 70%, white 30%);
            border-radius: 8px;
            padding: 8px 10px;
            line-height: 1.4;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-radius: 999px;
            padding: 6px 10px;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .user-profile:focus-visible,
        .user-profile:hover {
            background-color: color-mix(in srgb, var(--light-color) 78%, white 22%);
            box-shadow: 0 0 0 3px var(--focus-ring);
            outline: none;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
            position: relative;
        }
        .user-avatar.has-image {
            background-color: transparent;
            background-size: cover;
            background-position: center;
            color: transparent;
        }
        .user-avatar.has-image::after {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.12);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .user-profile:hover .user-avatar.has-image::after,
        .user-profile:focus-visible .user-avatar.has-image::after {
            opacity: 1;
        }
        .user-details {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }
        .user-details strong {
            font-size: 0.95rem;
            color: var(--dark-color);
        }
        .user-details span {
            font-size: 0.8rem;
            color: var(--muted-color);
        }
        .avatar-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.28);
            z-index: 1200;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding: 100px 40px 40px;
        }
        .avatar-modal {
            width: min(320px, 100%);
            background: var(--surface-color);
            border-radius: 16px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }
        .avatar-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .avatar-modal-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        .avatar-modal-close {
            background: none;
            border: none;
            color: var(--muted-color);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .avatar-modal-close:hover,
        .avatar-modal-close:focus-visible {
            background-color: color-mix(in srgb, var(--light-color) 70%, white 30%);
            color: var(--primary-dark);
            outline: none;
        }
        .avatar-modal-description {
            font-size: 0.85rem;
            color: var(--muted-color);
            line-height: 1.4;
        }
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
            gap: 12px;
        }
        .avatar-option {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            border: 2px solid transparent;
            padding: 0;
            overflow: hidden;
            background: color-mix(in srgb, var(--light-color) 85%, white 15%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .avatar-option img,
        .avatar-option span {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .avatar-option span {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.6rem;
            color: var(--dark-color);
        }
        .avatar-option:hover,
        .avatar-option:focus-visible {
            transform: translateY(-2px);
            box-shadow: 0 12px 18px rgba(15, 23, 42, 0.15);
            outline: none;
        }
        .avatar-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
        }
        .avatar-custom {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .avatar-custom label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        .avatar-custom-control {
            display: flex;
            gap: 8px;
        }
        .avatar-custom-control input[type="url"] {
            flex: 1;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 8px 10px;
            font-size: 0.85rem;
            color: var(--text-color);
            background-color: var(--surface-color);
        }
        .avatar-custom-control input[type="url"]:focus {
            outline: 2px solid var(--focus-ring);
            outline-offset: 1px;
        }
        .avatar-custom-control input[type="url"].invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.15);
        }
        .avatar-apply-button {
            border: none;
            background: var(--primary-color);
            color: white;
            padding: 8px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .avatar-apply-button:hover,
        .avatar-apply-button:focus-visible {
            background: var(--primary-dark);
            transform: translateY(-1px);
            outline: none;
        }
        .avatar-modal.hidden,
        .avatar-modal-backdrop.hidden {
            display: none;
        }
        .login-wrapper {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top, rgba(14, 116, 144, 0.12), transparent 60%),
                linear-gradient(135deg, #eef5fb 0%, #e2f2f7 100%);
            padding: 20px;
            z-index: 2000;
        }
        .login-card {
            width: min(420px, 100%);
            background: #ffffff;
            border-radius: 22px;
            padding: 40px 36px;
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.15);
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .login-card h2 {
            font-size: 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #2563eb;
        }
        .login-card h3 {
            font-size: 1.35rem;
            font-weight: 700;
            color: #0f172a;
        }
        .login-card img {
            width: 160px;
            align-self: center;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 14px;
            text-align: left;
        }
        .login-form label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #1e293b;
        }
        .login-form input {
            width: 100%;
            border-radius: 14px;
            border: 1px solid #cbd5f5;
            padding: 12px 14px;
            font-size: 0.95rem;
            background-color: #f8fafc;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .login-form input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            background-color: #ffffff;
        }
        .login-form button {
            margin-top: 8px;
            width: 100%;
            border: none;
            border-radius: 14px;
            padding: 12px 14px;
            background: linear-gradient(135deg, #2563eb, #0ea5e9);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .login-form button:hover {
            transform: translateY(-1px);
            box-shadow: 0 15px 30px rgba(37, 99, 235, 0.25);
        }
        .login-feedback {
            font-size: 0.85rem;
            text-align: left;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.02);
            color: #0f172a;
            min-height: 36px;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            box-sizing: border-box;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .login-feedback::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: currentColor;
            opacity: 0;
            transform: scale(0.6);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .login-feedback.is-loading {
            color: #2563eb;
        }
        .login-feedback.is-loading::before {
            opacity: 1;
            animation: pulse 0.8s ease-in-out infinite;
            background: linear-gradient(135deg, #2563eb, #38bdf8);
        }
        .login-feedback.is-error {
            color: #b91c1c;
            background: rgba(239, 68, 68, 0.08);
        }
        .login-feedback.is-error::before {
            opacity: 1;
            transform: scale(1);
        }
        .login-feedback.is-success {
            color: #047857;
            background: rgba(16, 185, 129, 0.12);
        }
        .login-feedback.is-success::before {
            opacity: 1;
            transform: scale(1);
            background: linear-gradient(135deg, #10b981, #34d399);
        }
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.45; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.45; }
        }
        .login-help {
            font-size: 0.85rem;
            color: #64748b;
        }
        .checkbox-grid {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            margin-top: 4px;
        }
        .checkbox-grid label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 10px;
            background-color: color-mix(in srgb, var(--light-color) 90%, white 10%);
            border: 1px solid color-mix(in srgb, var(--border-color) 80%, white 20%);
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        .checkbox-grid input {
            accent-color: var(--primary-color);
        }
        /* Cards Hero */
        .cards-hero {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: var(--surface-color);
            color: var(--dark-color);
            border-radius: 14px;
            box-shadow: 0 12px 28px var(--shadow-color);
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 18px 36px var(--shadow-color);
        }
        .card.livre {
            border-top: 4px solid var(--success-color);
        }
        .card.em-uso {
            border-top: 4px solid var(--em-uso-border-color);
            background: var(--em-uso-card-bg);
            color: var(--light-color);
        }
        .card.proximo {
            border-top: 4px solid var(--warning-color);
        }
        .card.vencido {
            border-top: 4px solid var(--danger-color);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        .card-icon {
            font-size: 1.6rem;
            color: var(--primary-color);
        }
        .card.livre .card-icon   { color: var(--success-color); }
        .card.em-uso .card-icon  { color: var(--light-color); }
        .card.proximo .card-icon { color: var(--warning-color); }
        .card.vencido .card-icon { color: var(--danger-color); }
        .card-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        .card-description {
            font-size: 0.9rem;
            color: var(--muted-color);
        }
        .card.em-uso .card-title,
        .card.em-uso .card-value {
            color: var(--light-color);
        }
        .card.em-uso .card-description {
            color: color-mix(in srgb, white 65%, transparent);
        }
        /* Filtros */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        /* Tabela de Armários */
        .armarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .armario-card {
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 12px 28px var(--shadow-color);
            padding: 18px;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid var(--success-color);
        }
        .armario-card.em-uso {
            border-left-color: var(--em-uso-border-color);
            background: var(--em-uso-card-bg);
            color: var(--light-color);
            box-shadow: 0 14px 32px color-mix(in srgb, var(--primary-color) 30%, transparent);
        }
        .armario-card.proximo {
            border-left-color: var(--warning-color);
        }
        .armario-card.vencido {
            border-left-color: var(--danger-color);
        }
        .armario-card:hover {
            box-shadow: 0 18px 36px var(--shadow-color);
            transform: translateY(-4px);
        }
        .armario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .armario-number {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--dark-color);
        }
        .armario-card.em-uso .armario-number {
            color: var(--light-color);
        }
        .armario-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-livre {
            background-color: color-mix(in srgb, var(--success-color) 18%, transparent);
            color: var(--success-color);
        }
        .status-em-uso {
            background-color: var(--em-uso-badge-bg);
            color: var(--em-uso-badge-text);
        }
        .armario-card.em-uso .status-em-uso {
            background-color: color-mix(in srgb, var(--surface-color) 18%, transparent);
            color: var(--light-color);
        }
        .status-proximo {
            background-color: color-mix(in srgb, var(--warning-color) 20%, transparent);
            color: var(--warning-color);
        }
        .status-vencido {
            background-color: color-mix(in srgb, var(--danger-color) 18%, transparent);
            color: var(--danger-color);
        }
        .armario-details {
            font-size: 0.9rem;
            color: var(--muted-color);
        }
        .armario-card.em-uso .armario-details {
            color: color-mix(in srgb, white 88%, transparent);
        }
        .armario-details p {
            margin-bottom: 5px;
        }
        .armario-unidade {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-color);
            background-color: color-mix(in srgb, var(--primary-color) 16%, transparent);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 14px;
        }
        .armario-unidade .label {
            color: var(--dark-color);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 0.75rem;
            display: block;
        }
        .armario-unidade .value {
            display: block;
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-top: 2px;
        }
        /* Tabelas de dados */
        .data-table {
            background-color: var(--surface-color);
            border-radius: 14px;
            box-shadow: 0 12px 28px var(--shadow-color);
            overflow: hidden;
            border: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
        }
        .table-header {
            padding: 18px 24px;
            background-color: color-mix(in srgb, var(--light-color) 75%, white 25%);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
        }
        th {
            background-color: color-mix(in srgb, var(--light-color) 85%, white 15%);
            font-weight: 600;
            color: var(--dark-color);
        }
        tr:hover {
            background-color: color-mix(in srgb, var(--light-color) 65%, white 35%);
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-edit {
            background-color: var(--warning-color);
            color: white;
        }
        .btn-delete {
            background-color: var(--danger-color);
            color: white;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 24px 48px var(--shadow-color);
            border: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
        }
        .modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted-color);
            transition: color 0.2s ease;
        }
        .modal-close:hover {
            color: var(--dark-color);
        }
        .modal-body {
            padding: 20px;
        }
        .modal-large .modal-content {
            max-width: 960px;
        }
        .modal-full {
            align-items: stretch;
            padding: 30px 10px;
        }
        .modal-full .modal-content {
            width: 100%;
            max-width: 1100px;
            height: 100%;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }
        .modal-scrollable {
            overflow-y: auto;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 18px 22px;
            border-top: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
            background: color-mix(in srgb, var(--light-color) 85%, white 15%);
        }
        .modal-actions .btn-primary {
            min-width: 140px;
        }
        /* Termo Wizard */
        .wizard-card {
            background: var(--surface-color);
            border-radius: 18px;
            box-shadow: 0 20px 40px var(--shadow-color);
            border: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .wizard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 22px 28px;
            border-bottom: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
            background: linear-gradient(180deg, color-mix(in srgb, var(--light-color) 55%, white 45%), var(--light-color));
        }
        .wizard-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        .wizard-subtitle {
            font-size: 0.9rem;
            color: var(--muted-color);
            margin-top: 4px;
        }
        .wizard-progress {
            min-width: 260px;
        }
        .wizard-progress-bar {
            width: 100%;
            height: 10px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--light-color) 70%, white 30%);
            overflow: hidden;
            box-shadow: inset 0 1px 2px color-mix(in srgb, var(--dark-color) 8%, transparent);
        }
        .wizard-progress-bar span {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--primary-color), color-mix(in srgb, var(--primary-color) 55%, white 45%));
            transition: width 0.4s ease;
        }
        .wizard-progress-label {
            text-align: right;
            font-size: 0.85rem;
            color: var(--muted-color);
            margin-top: 6px;
        }
        .wizard-body {
            flex: 1;
            overflow-y: auto;
            padding: 26px;
            background: color-mix(in srgb, var(--light-color) 80%, white 20%);
        }
        .wizard-step {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        .wizard-step.active {
            display: block;
            opacity: 1;
            transform: none;
        }
        .wizard-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(12, 1fr);
        }
        .wizard-col-12 { grid-column: span 12; }
        .wizard-col-8 { grid-column: span 8; }
        .wizard-col-6 { grid-column: span 6; }
        .wizard-col-4 { grid-column: span 4; }
        @media (max-width: 900px) {
            .wizard-progress { min-width: 200px; }
            .wizard-col-8,
            .wizard-col-6,
            .wizard-col-4 { grid-column: span 12; }
        }
        .wizard-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .wizard-field label {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .wizard-required::after {
            content: ' *';
            color: var(--danger-color);
        }
        .wizard-input,
        .wizard-textarea,
        .wizard-select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            font: inherit;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .wizard-textarea {
            min-height: 110px;
            resize: vertical;
        }
        .wizard-input:focus,
        .wizard-textarea:focus,
        .wizard-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--focus-ring);
        }
        .wizard-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--primary-color) 16%, transparent);
            color: color-mix(in srgb, var(--primary-color) 70%, black 30%);
            border: 1px solid color-mix(in srgb, var(--primary-color) 35%, transparent);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .wizard-inline {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .wizard-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid color-mix(in srgb, var(--primary-color) 25%, transparent);
            background: color-mix(in srgb, var(--primary-color) 12%, transparent);
            font-size: 0.9rem;
        }
        .wizard-chip input {
            transform: scale(1.1);
        }
        .wizard-hint {
            font-size: 0.8rem;
            color: var(--muted-color);
        }
        .wizard-volumes-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .wizard-signature-area {
            border: 1px dashed color-mix(in srgb, var(--primary-color) 35%, transparent);
            padding: 14px;
            border-radius: 12px;
            background: color-mix(in srgb, var(--primary-color) 12%, transparent);
        }
        .wizard-signature-canvas {
            width: 100%;
            height: 160px;
            background: #fff;
            border: 1px solid color-mix(in srgb, var(--primary-color) 35%, transparent);
            border-radius: 10px;
            cursor: crosshair;
            touch-action: none;
        }
        .final-signature-dialog .wizard-signature-area {
            padding: 16px;
        }
        .final-signature-dialog .wizard-signature-canvas {
            min-height: 240px;
            height: 240px;
        }
        .wizard-signature-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 8px;
        }
        .wizard-signature-hint {
            font-size: 0.75rem;
            color: #5b6b86;
            margin-top: 6px;
        }
        .final-signature-dialog {
            text-align: left;
        }
        .final-signature-dialog p {
            margin-bottom: 12px;
            color: #4b5563;
        }
        .final-signature-dialog strong {
            color: #0b1324;
        }
        .final-signature-dialog .wizard-field {
            margin-top: 12px;
        }
        .swal2-popup.swal2-final-signature {
            width: min(90vw, 720px) !important;
            max-width: none !important;
        }
        .swal2-popup.swal2-final-signature .final-signature-dialog {
            width: 100%;
        }
        .wizard-volume-item {
            border: 1px dashed color-mix(in srgb, var(--primary-color) 35%, transparent);
            border-radius: 12px;
            padding: 12px;
            background: color-mix(in srgb, var(--primary-color) 10%, transparent);
        }
        .wizard-volume-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: minmax(100px, 150px) 1fr auto;
            align-items: flex-end;
        }
        .wizard-volume-col {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .wizard-volume-col label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--muted-color);
        }
        .wizard-volume-actions {
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
        }
        .wizard-volume-actions .btn {
            padding: 10px 14px;
            border-radius: 10px;
        }
        .wizard-error {
            font-size: 0.8rem;
            color: var(--danger-color);
            display: none;
        }
        .wizard-field.invalid .wizard-error {
            display: block;
        }
        @media (max-width: 720px) {
            .wizard-volume-grid {
                grid-template-columns: 1fr;
            }
            .wizard-volume-actions {
                justify-content: flex-start;
            }
        }
        .wizard-actions {
            padding: 20px 28px;
            border-top: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
            background: var(--surface-color);
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        .wizard-actions .btn {
            border-radius: 12px;
            padding: 12px 18px;
            font-weight: 600;
        }
        .btn-ghost {
            background: transparent;
            color: var(--primary-color);
            border: 1px dashed color-mix(in srgb, var(--primary-color) 45%, transparent);
        }
        /* Movimentações */
        .movimentacoes-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .movimentacao-item {
            border: 1px dashed color-mix(in srgb, var(--primary-color) 30%, transparent);
            border-radius: 12px;
            padding: 12px 14px;
            background: color-mix(in srgb, var(--primary-color) 10%, transparent);
        }
        .movimentacao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .movimentacao-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--muted-color);
        }
        .info-box {
            background: color-mix(in srgb, var(--primary-color) 14%, transparent);
            border: 1px solid color-mix(in srgb, var(--primary-color) 32%, transparent);
            border-radius: 12px;
            padding: 12px 14px;
            margin-top: 12px;
            font-size: 0.9rem;
            color: color-mix(in srgb, var(--primary-color) 80%, black 20%);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .field-hint {
            font-size: 0.8rem;
            color: var(--muted-color);
            margin-top: 4px;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: var(--surface-color);
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--focus-ring);
            outline: none;
        }
        .form-static {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: color-mix(in srgb, var(--light-color) 70%, white 30%);
            font-size: 0.95rem;
            color: var(--muted-color);
        }
        .form-static.is-warning {
            background-color: color-mix(in srgb, var(--warning-color) 18%, white 82%);
            border-color: color-mix(in srgb, var(--warning-color) 42%, var(--border-color) 58%);
            color: color-mix(in srgb, var(--warning-color) 65%, black 35%);
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn.btn-disabled {
            opacity: 0.55;
            cursor: not-allowed;
            pointer-events: auto;
        }
        .btn.btn-disabled:hover {
            transform: none;
            box-shadow: none;
        }
        .btn-loading {
            opacity: 0.85;
            pointer-events: none;
            padding-right: 36px;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-bottom-color: transparent;
            animation: spin 0.6s linear infinite;
            transform: translateY(-50%);
        }
        .swal-button-loading {
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .swal-button-spinner {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-bottom-color: transparent;
            animation: spin 0.6s linear infinite;
        }
        .swal-button-text {
            font-weight: 600;
        }
        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 12px 24px color-mix(in srgb, var(--primary-color) 45%, transparent);
        }
        .status-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            background-color: rgba(59, 130, 246, 0.12);
            color: var(--primary-color);
        }
        .status-label.aplicado {
            background-color: rgba(16, 185, 129, 0.14);
            color: var(--secondary-color);
        }
        .status-label.pendente {
            background-color: rgba(245, 158, 11, 0.14);
            color: var(--warning-color);
        }
        .status-label.andamento {
            background-color: rgba(59, 130, 246, 0.14);
            color: var(--primary-color);
        }
        .text-muted {
            color: var(--muted-color);
        }
        .loading-state {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px;
            color: var(--muted-color);
            font-weight: 500;
        }
        .loading-spinner {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            border-right-color: transparent;
            border-bottom-color: transparent;
            animation: spin 0.6s linear infinite;
        }
        .global-loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.38);
            backdrop-filter: blur(1.5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }
        .global-loading-overlay.is-active {
            display: flex;
        }
        .global-loading-content {
            background: var(--surface-color);
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
            border-radius: 20px;
            padding: 28px 36px;
            min-width: 260px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            text-align: center;
            color: var(--dark-color);
            font-weight: 500;
        }
        .global-loading-spinner {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 3px solid color-mix(in srgb, var(--primary-color) 72%, white 28%);
            border-right-color: transparent;
            border-bottom-color: transparent;
            animation: spin 0.75s linear infinite;
        }
        .liberacao-progress {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            text-align: left;
            width: 100%;
        }
        .liberacao-step {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            border-radius: 14px;
            background: rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(15, 23, 42, 0.08);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            width: 100%;
        }
        .liberacao-step.is-active {
            border-color: color-mix(in srgb, var(--primary-color) 65%, white 35%);
            background: color-mix(in srgb, var(--primary-color) 12%, white 88%);
        }
        .liberacao-step.is-complete {
            border-color: color-mix(in srgb, var(--success-color) 68%, white 32%);
            background: color-mix(in srgb, var(--success-color) 18%, white 82%);
        }
        .liberacao-step.is-error {
            border-color: color-mix(in srgb, var(--danger-color) 70%, white 30%);
            background: color-mix(in srgb, var(--danger-color) 16%, white 84%);
        }
        .liberacao-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: color-mix(in srgb, var(--primary-color) 16%, white 84%);
            color: color-mix(in srgb, var(--primary-color) 75%, black 25%);
            position: relative;
        }
        .liberacao-step.is-active .liberacao-step-icon {
            background: color-mix(in srgb, var(--primary-color) 22%, white 78%);
            color: color-mix(in srgb, var(--primary-dark) 76%, white 24%);
        }
        .liberacao-step.is-complete .liberacao-step-icon {
            background: color-mix(in srgb, var(--success-color) 72%, white 28%);
            color: white;
        }
        .liberacao-step.is-error .liberacao-step-icon {
            background: color-mix(in srgb, var(--danger-dark) 82%, white 18%);
            color: white;
        }
        .liberacao-step-spinner {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-bottom-color: transparent;
            animation: spin 0.6s linear infinite;
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .liberacao-step.is-active .liberacao-step-spinner {
            display: block;
        }
        .liberacao-step-icon i {
            display: none;
            font-size: 16px;
        }
        .liberacao-step.is-complete .liberacao-step-spinner,
        .liberacao-step.is-error .liberacao-step-spinner {
            display: none;
        }
        .liberacao-step.is-complete .liberacao-step-icon .fa-check,
        .liberacao-step.is-error .liberacao-step-icon .fa-circle-exclamation {
            display: inline;
        }
        .liberacao-step-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: color-mix(in srgb, var(--dark-color) 88%, black 12%);
        }
        .liberacao-step-subtitle {
            font-size: 0.8rem;
            color: color-mix(in srgb, var(--muted-color) 85%, black 15%);
            margin-top: 2px;
        }
        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--primary-color) 85%, var(--primary-dark) 15%);
            box-shadow: 0 18px 32px color-mix(in srgb, var(--primary-color) 35%, transparent);
        }
        .btn-secondary {
            background-color: color-mix(in srgb, var(--dark-color) 65%, white 35%);
            color: white;
            box-shadow: 0 12px 24px color-mix(in srgb, var(--dark-color) 25%, transparent);
        }
        .btn-secondary:hover {
            background-color: color-mix(in srgb, var(--dark-color) 75%, black 25%);
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            box-shadow: 0 12px 24px color-mix(in srgb, var(--danger-color) 35%, transparent);
        }
        .btn-danger:hover {
            background-color: color-mix(in srgb, var(--danger-color) 85%, var(--danger-dark) 15%);
        }
        /* Notificações */
        .notification-panel {
            display: none;
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            background-color: var(--surface-color);
            border-radius: 14px;
            box-shadow: 0 18px 40px var(--shadow-color);
            border: 1px solid color-mix(in srgb, var(--dark-color) 6%, transparent);
            z-index: 1500;
        }
        .notification-header {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 14px 18px;
            border-bottom: 1px solid color-mix(in srgb, var(--dark-color) 5%, transparent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }
        .notification-icon.warning {
            background-color: var(--warning-color);
        }
        .notification-icon.danger {
            background-color: var(--danger-color);
        }
        .notification-content {
            flex: 1;
        }
        .notification-title {
            font-weight: 500;
            margin-bottom: 3px;
        }
        .notification-time {
            font-size: 0.8rem;
            color: var(--muted-color);
        }
        /* Páginas */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Responsividade */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                overflow: visible;
            }
            .sidebar-header h2, .sidebar-header p, .sidebar-menu span {
                display: none;
            }
            .sidebar-menu a {
                text-align: center;
                padding: 15px 10px;
            }
            .sidebar-menu i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            .main-content {
                margin-left: 70px;
            }
        }
        @media (max-width: 768px) {
            .cards-hero {
                grid-template-columns: 1fr 1fr;
            }
            .armarios-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 576px) {
            .cards-hero {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 14px;
            }
            .header-actions {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            .header-selectors {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .selector-group {
                width: 100%;
            }
            .selector-control {
                width: 100%;
                min-width: 0;
            }
            .notification-bell {
                align-self: flex-end;
            }
            .user-profile {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div id="login-container" class="login-wrapper">
        <div class="login-card">
            <h2>ACESSO RESTRITO</h2>
            <img src="https://i.ibb.co/hxbRMNvV/logo-HUC.jpg" alt="Logo Hospital Universitário do Ceará" loading="lazy">
            <h3>LockNAC - Gerenciamento de Armários</h3>
            <form id="login-form" class="login-form" novalidate>
                <div>
                    <label for="login-usuario">Usuário</label>
                    <input type="text" id="login-usuario" autocomplete="username" placeholder="Digite seu usuário" required>
                </div>
                <div>
                    <label for="login-senha">Senha</label>
                    <input type="password" id="login-senha" autocomplete="current-password" required>
                </div>
                <button type="submit" id="login-submit">Entrar</button>
            </form>
            <div id="login-feedback" class="login-feedback" role="status" aria-live="polite"></div>
            <div class="login-help">Precisa de ajuda com o acesso?</div>
        </div>
    </div>
    <div id="app-shell" class="app-shell hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">LockNAC</div>
                <p>Hospital Universitário do Ceará</p>
            </div>
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                    <li><a href="#" data-page="visitantes"><i class="fas fa-user-clock"></i> <span>Visitantes</span></a></li>
                    <li><a href="#" data-page="acompanhantes"><i class="fas fa-user-friends"></i> <span>Acompanhantes</span></a></li>
                    <li><a href="#" data-page="historico-visitantes"><i class="fas fa-history"></i> <span>Histórico Visitantes</span></a></li>
                    <li><a href="#" data-page="historico-acompanhantes"><i class="fas fa-history"></i> <span>Histórico Acompanhantes</span></a></li>
                    <li><a href="#" data-page="termo-responsabilidade"><i class="fas fa-file-signature"></i> <span>Termo de Responsabilidade</span></a></li>
                    <li><a href="#" data-page="cadastro-armarios"><i class="fas fa-archive"></i> <span>Cadastro de Armários</span></a></li>
                    <li><a href="#" data-page="cadastro-unidades"><i class="fas fa-hospital"></i> <span>Cadastro de Unidades</span></a></li>
                    <li><a href="#" data-page="usuarios"><i class="fas fa-users"></i> <span>Usuários</span></a></li>
                    <li><a href="#" data-page="logs"><i class="fas fa-clipboard-list"></i> <span>LOGS</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <button type="button" id="logout-button" class="sidebar-logout-button">
                    <i class="fas fa-right-from-bracket" aria-hidden="true"></i>
                    <span>Sair</span>
                </button>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>Dashboard</h1>
            </div>
            <div class="header-actions">
                <div class="header-selectors">
                    <div class="selector-group">
                        <label for="profile-select">Perfil</label>
                        <div class="selector-control" data-selector>
                            <i class="fas fa-users selector-icon" aria-hidden="true"></i>
                            <button type="button" class="selector-trigger" id="profile-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                                <div class="selector-trigger-text">
                                    <span class="selector-trigger-label">Perfil geral</span>
                                    <span class="selector-trigger-description">Visão consolidada do atendimento</span>
                                </div>
                                <span class="selector-arrow" aria-hidden="true"><i class="fas fa-angle-down"></i></span>
                            </button>
                            <div class="selector-dropdown" role="listbox" aria-labelledby="profile-select-trigger"></div>
                            <select id="profile-select" class="selector-input" aria-hidden="true" tabindex="-1">
                                <option value="geral" selected data-icon="fas fa-chart-line" data-description="Visão consolidada do atendimento">Perfil geral</option>
                                <option value="visitante" data-icon="fas fa-id-badge" data-description="Gestão completa dos visitantes">Visitantes</option>
                                <option value="acompanhante" data-icon="fas fa-people-roof" data-description="Acompanhamento dedicado aos pacientes">Acompanhantes</option>
                            </select>
                        </div>
                    </div>
                    <div class="selector-group">
                        <label for="unit-select">Unidade</label>
                        <div class="selector-control" data-selector>
                            <i class="fas fa-building selector-icon" aria-hidden="true"></i>
                            <button type="button" class="selector-trigger" id="unit-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                                <div class="selector-trigger-text">
                                    <span class="selector-trigger-label">Todas as unidades</span>
                                    <span class="selector-trigger-description">Visualização geral por setor</span>
                                </div>
                                <span class="selector-arrow" aria-hidden="true"><i class="fas fa-angle-down"></i></span>
                            </button>
                            <div class="selector-dropdown" role="listbox" aria-labelledby="unit-select-trigger"></div>
                            <select id="unit-select" class="selector-input" aria-hidden="true" tabindex="-1">
                                <option value="todas" data-icon="fas fa-layer-group" data-description="Visualização geral por setor">Todas as unidades</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="notification-bell" id="notification-bell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">0</span>
                </div>
                <div class="user-profile" id="header-user-profile" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="avatar-modal" aria-expanded="false">
                    <div class="user-avatar" id="header-user-avatar">--</div>
                    <div class="user-details">
                        <strong id="header-user-name">Usuário</strong>
                        <span id="header-user-role">Perfil geral</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Páginas -->
        <div id="pages-container">
            <!-- Dashboard -->
            <div class="page active" id="dashboard">
                <!-- Cards Hero -->
                <div class="cards-hero">
                    <div class="card em-uso">
                        <div class="card-header">
                            <div class="card-title">Em uso</div>
                            <div class="card-icon"><i class="fas fa-user-clock"></i></div>
                        </div>
                        <div class="card-value" id="em-uso-count">0</div>
                        <div class="card-description">Armários ocupados</div>
                    </div>
                    <div class="card livre">
                        <div class="card-header">
                            <div class="card-title">Livres</div>
                            <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                        </div>
                        <div class="card-value" id="livres-count">0</div>
                        <div class="card-description">Armários disponíveis</div>
                    </div>
                    <div class="card proximo">
                        <div class="card-header">
                            <div class="card-title">Próximo do horário</div>
                            <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                        <div class="card-value" id="proximo-count">0</div>
                        <div class="card-description">Armários prestes a vencer</div>
                    </div>
                    <div class="card vencido">
                        <div class="card-header">
                            <div class="card-title">Vencidos</div>
                            <div class="card-icon"><i class="fas fa-times-circle"></i></div>
                        </div>
                        <div class="card-value" id="vencidos-count">0</div>
                        <div class="card-description">Armários com tempo excedido</div>
                    </div>
                </div>
                <!-- Filtros -->
                <div class="filters">
                    <button class="filter-btn active" data-filter="todos">Todos</button>
                    <button class="filter-btn" data-filter="livre">Livre</button>
                    <button class="filter-btn" data-filter="em-uso">Em uso</button>
                    <button class="filter-btn" data-filter="proximo">Próximo do horário</button>
                    <button class="filter-btn" data-filter="vencido">Vencido</button>
                </div>
                <!-- Tabela de Armários -->
                <div class="armarios-grid" id="armarios-container">
                    <!-- Os armários serão carregados aqui via JavaScript -->
                </div>
            </div>
            <!-- Visitantes -->
            <div class="page" id="visitantes">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Armários de Visitantes</h3>
                        <button class="btn btn-primary" id="btn-novo-visitante">
                            <i class="fas fa-plus"></i> Novo Cadastro
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="tabela-visitantes">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Unidade</th>
                                    <th>Status</th>
                                    <th>Visitante</th>
                                    <th>Paciente</th>
                                    <th>Leito</th>
                                    <th>Volumes</th>
                                    <th>Hora Início</th>
                                    <th>Previsão Saída</th>
                                    <th>WhatsApp</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Acompanhantes -->
            <div class="page" id="acompanhantes">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Armários de Acompanhantes</h3>
                        <button class="btn btn-primary" id="btn-novo-acompanhante">
                            <i class="fas fa-plus"></i> Novo Cadastro
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="tabela-acompanhantes">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Unidade</th>
                                    <th>Status</th>
                                    <th>Acompanhante</th>
                                    <th>Paciente</th>
                                    <th>Leito</th>
                                    <th>Volumes</th>
                                    <th>Hora Início</th>
                                    <th>WhatsApp</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Histórico Visitantes -->
            <div class="page" id="historico-visitantes">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Histórico de Visitantes</h3>
                    </div>
                    <div class="table-container">
                        <table id="tabela-historico-visitantes">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Armário</th>
                                    <th>Visitante</th>
                                    <th>Paciente</th>
                                    <th>Leito</th>
                                    <th>Volumes</th>
                                    <th>Hora Início</th>
                                    <th>Hora Fim</th>
                                    <th>WhatsApp</th>
                                    <th>Status</th>
                                    <th>Usuário</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Histórico Acompanhantes -->
            <div class="page" id="historico-acompanhantes">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Histórico de Acompanhantes</h3>
                    </div>
                    <div class="table-container">
                        <table id="tabela-historico-acompanhantes">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Armário</th>
                                    <th>Acompanhante</th>
                                    <th>Paciente</th>
                                    <th>Leito</th>
                                    <th>Volumes</th>
                                    <th>Hora Início</th>
                                    <th>Hora Fim</th>
                                    <th>WhatsApp</th>
                                    <th>Status</th>
                                    <th>Usuário</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Termo de Responsabilidade -->
            <div class="page" id="termo-responsabilidade">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Termos de Responsabilidade</h3>
                        <p style="color:#5b6b86; font-size:0.9rem;">Consulte termos aplicados e pendentes dos armários de acompanhantes em uso.</p>
                    </div>
                    <div class="table-container">
                        <table id="tabela-termos">
                            <thead>
                                <tr>
                                    <th>Armário</th>
                                    <th>Acompanhante</th>
                                    <th>Paciente</th>
                                    <th>Status</th>
                                    <th>Aplicado em</th>
                                    <th>Movimentações</th>
                                    <th>PDF</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Cadastro de Armários -->
            <div class="page" id="cadastro-armarios">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Cadastro de Armários</h3>
                        <button class="btn btn-primary" id="btn-novo-armario">
                            <i class="fas fa-plus"></i> Novo Armário
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="tabela-cadastro-armarios">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Número</th>
                                    <th>Tipo</th>
                                    <th>Unidade</th>
                                    <th>Localização</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Cadastro de Unidades -->
            <div class="page" id="cadastro-unidades">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Cadastro de Unidades</h3>
                        <button class="btn btn-primary" id="btn-nova-unidade">
                            <i class="fas fa-plus"></i> Nova Unidade
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="tabela-unidades">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Unidade</th>
                                    <th>Status</th>
                                    <th>Armários cadastrados</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Usuários -->
            <div class="page" id="usuarios">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Usuários do Sistema</h3>
                        <button class="btn btn-primary" id="btn-novo-usuario">
                            <i class="fas fa-plus"></i> Novo Usuário
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="tabela-usuarios">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Matrícula</th>
                                    <th>Perfil</th>
                                    <th>Visitantes</th>
                                    <th>Acompanhantes</th>
                                    <th>Unidades</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- LOGS -->
            <div class="page" id="logs">
                <div class="data-table">
                    <div class="table-header">
                        <h3>Logs do Sistema</h3>
                    </div>
                    <div class="table-container">
                        <table id="tabela-logs">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Cadastro de Armário -->
    <div class="modal" id="armario-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Cadastrar Armário</div>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="armario-form">
                    <div class="form-group">
                        <label for="nome-visitante">Nome do Visitante</label>
                        <input type="text" id="nome-visitante" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="nome-paciente">Nome do Paciente</label>
                        <input type="text" id="nome-paciente" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="leito">Leito</label>
                        <input type="text" id="leito" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="whatsapp-contato">WhatsApp</label>
                        <input type="tel" id="whatsapp-contato" class="form-control" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label for="volumes">Quantidade de Volumes</label>
                        <input type="number" id="volumes" class="form-control" min="1" required>
                    </div>
                    <div class="form-group" id="hora-prevista-group">
                        <label for="hora-prevista">Hora Prevista de Saída</label>
                        <input type="time" id="hora-prevista" class="form-control" required>
                        <div class="field-hint">Horário preenchido automaticamente para 1 hora após o cadastro.</div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="btn-cancelar">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-salvar">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal para Cadastro de Usuário -->
    <div class="modal" id="usuario-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="usuario-modal-title">Cadastrar Usuário</div>
                <button class="modal-close" id="usuario-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="usuario-form">
                    <div class="form-group">
                        <label for="usuario-nome">Nome Completo</label>
                        <input type="text" id="usuario-nome" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="usuario-email">Matrícula</label>
                        <input type="text" id="usuario-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="usuario-senha">Senha</label>
                        <input type="text" id="usuario-senha" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="usuario-perfil">Perfil</label>
                        <select id="usuario-perfil" class="form-control" required>
                            <option value="usuario">Usuário</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="usuario-status">Status</label>
                        <select id="usuario-status" class="form-control" required>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="form-group" id="acessos-group">
                        <label>Acessos</label>
                        <div>
                            <input type="checkbox" id="acesso-visitantes" checked>
                            <label for="acesso-visitantes">Visitantes</label>
                        </div>
                        <div>
                            <input type="checkbox" id="acesso-acompanhantes" checked>
                            <label for="acesso-acompanhantes">Acompanhantes</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Unidades com acesso</label>
                        <div id="usuario-unidades" class="checkbox-grid"></div>
                        <div class="field-hint">Selecione as unidades que o usuário pode visualizar.</div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="usuario-btn-cancelar">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="usuario-btn-salvar">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal Termo de Responsabilidade -->
    <div class="modal modal-full" id="termo-modal">
        <div class="modal-content modal-scrollable">
            <div class="wizard-card" id="termo-card">
                <div class="wizard-header">
                    <div>
                        <div class="wizard-title">Termo de responsabilidade do armário <span id="termo-armario"></span></div>
                        <div class="wizard-subtitle">Preencha os dados do acompanhante e do paciente antes de aplicar o termo.</div>
                    </div>
                    <div class="wizard-progress">
                        <div class="wizard-progress-bar"><span id="termo-progress"></span></div>
                        <div class="wizard-progress-label" id="termo-progress-label">Passo 1 de 3</div>
                    </div>
                    <button class="modal-close" id="termo-modal-close" type="button">&times;</button>
                </div>
                <div class="wizard-body">
                    <form id="termo-form" autocomplete="off">
                        <div class="wizard-step active" data-step="0">
                            <div class="wizard-grid">
                                <div class="wizard-col-12"><div class="wizard-badge">Dados do paciente</div></div>
                                <div class="wizard-col-8">
                                    <div class="wizard-field">
                                        <label for="termo-paciente" class="wizard-required">Nome do paciente</label>
                                        <input type="text" id="termo-paciente" class="wizard-input" required>
                                        <div class="wizard-error">Informe o nome completo do paciente.</div>
                                    </div>
                                </div>
                                <div class="wizard-col-4">
                                    <div class="wizard-field">
                                        <label for="termo-prontuario" class="wizard-required">Prontuário</label>
                                        <input type="text" id="termo-prontuario" class="wizard-input" required>
                                        <div class="wizard-error">Informe o número do prontuário.</div>
                                    </div>
                                </div>
                                <div class="wizard-col-4">
                                    <div class="wizard-field">
                                        <label for="termo-nascimento" class="wizard-required">Data de nascimento</label>
                                        <input type="date" id="termo-nascimento" class="wizard-input" required>
                                        <div class="wizard-error">Informe a data de nascimento.</div>
                                    </div>
                                </div>
                                <div class="wizard-col-4">
                                    <div class="wizard-field">
                                        <label for="termo-setor" class="wizard-required">Setor de internação</label>
                                        <select id="termo-setor" class="wizard-input" required>
                                            <option value="">Selecione o setor</option>
                                        </select>
                                        <div class="wizard-error">Informe o setor.</div>
                                    </div>
                                </div>
                                <div class="wizard-col-4">
                                    <div class="wizard-field">
                                        <label for="termo-leito" class="wizard-required">Leito</label>
                                        <input type="text" id="termo-leito" class="wizard-input" required>
                                        <div class="wizard-error">Informe o leito.</div>
                                    </div>
                                </div>
                                <div class="wizard-col-12">
                                    <div class="wizard-field">
                                        <label class="wizard-required">Paciente consciente/orientado e responsável pelos pertences?</label>
                                        <div class="wizard-inline">
                                            <label class="wizard-chip"><input type="radio" name="termo-consciente" value="Sim" required> Sim</label>
                                            <label class="wizard-chip"><input type="radio" name="termo-consciente" value="Não"> Não</label>
                                        </div>
                                        <div class="wizard-error">Selecione uma opção.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="wizard-step" data-step="1">
                            <div class="wizard-grid">
                                <div class="wizard-col-12"><div class="wizard-badge">Responsável pelo armário</div></div>
                                <div class="wizard-col-8">
                                    <div class="wizard-field">
                                        <label for="termo-resp-nome" class="wizard-required">Nome do acompanhante</label>
                                        <input type="text" id="termo-resp-nome" class="wizard-input" required>
                                        <div class="wizard-error">Informe o nome do acompanhante.</div>
                                    </div>
                                </div>
                                <div class="wizard-col-4">
                                    <div class="wizard-field">
                                        <label for="termo-resp-telefone">Telefone(s)</label>
                                        <input type="tel" id="termo-resp-telefone" class="wizard-input" placeholder="(00) 00000-0000">
                                    </div>
                                </div>
                                <div class="wizard-col-6">
                                    <div class="wizard-field">
                                        <label for="termo-resp-doc">Documento (RG ou CPF)</label>
                                        <input type="text" id="termo-resp-doc" class="wizard-input" placeholder="000.000.000-00">
                                    </div>
                                </div>
                                <div class="wizard-col-6">
                                    <div class="wizard-field">
                                        <label for="termo-resp-parentesco">Grau de parentesco</label>
                                        <input type="text" id="termo-resp-parentesco" class="wizard-input" placeholder="Ex.: Filho(a)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="wizard-step" data-step="2">
                            <div class="wizard-grid">
                                <div class="wizard-col-12"><div class="wizard-badge">Orientações e ciência</div></div>
                                <div class="wizard-col-12">
                                    <div class="wizard-field">
                                        <label class="wizard-required">Confirma ciência das orientações?</label>
                                        <div class="wizard-inline" style="align-items:flex-start;">
                                            <label class="wizard-chip" style="align-items:flex-start;">
                                                <input type="checkbox" id="termo-ori1" required>
                                                <span>Seus pertences estão sob sua guarda e responsabilidade.</span>
                                            </label>
                                        </div>
                                        <div class="wizard-inline" style="align-items:flex-start;">
                                            <label class="wizard-chip" style="align-items:flex-start;">
                                                <input type="checkbox" id="termo-ori2" required>
                                                <span>Em piora clínica, os pertences serão recolhidos e protocolados no NAC.</span>
                                            </label>
                                        </div>
                                        <div class="wizard-inline" style="align-items:flex-start;">
                                            <label class="wizard-chip" style="align-items:flex-start;">
                                                <input type="checkbox" id="termo-ori3" required>
                                                <span>Após 15 dias da alta/transferência, itens não retirados poderão ser descartados conforme normas.</span>
                                            </label>
                                        </div>
                                        <div class="wizard-error">É necessário marcar todas as caixas de ciência.</div>
                                    </div>
                                </div>
                                <div class="wizard-col-12">
                                    <div class="wizard-field" id="termo-volumes-field">
                                        <label class="wizard-required">Quantidade e descrição de bolsas/pacotes</label>
                                        <div class="wizard-volumes-list" id="termo-volumes-list"></div>
                                        <div class="wizard-inline" style="margin-top: 8px; align-items: center;">
                                            <button type="button" class="btn btn-ghost" id="termo-add-volume">+ Adicionar volume</button>
                                            <span class="wizard-hint">Informe a quantidade e descreva cada volume guardado.</span>
                                        </div>
                                        <datalist id="termo-itens-sugestoes">
                                            <option value="Mochila"></option>
                                            <option value="Bolsa"></option>
                                            <option value="Sacola reutilizável"></option>
                                            <option value="Sacola plástica"></option>
                                            <option value="Mala pequena"></option>
                                            <option value="Mala de rodinhas"></option>
                                            <option value="Frasqueira"></option>
                                            <option value="Caixa organizadora"></option>
                                            <option value="Envelope com documentos"></option>
                                            <option value="Notebook"></option>
                                            <option value="Tablet"></option>
                                            <option value="Celular"></option>
                                            <option value="Carregador"></option>
                                            <option value="Chaveiro"></option>
                                            <option value="Carteira"></option>
                                            <option value="Outros itens"></option>
                                        </datalist>
                                        <div class="wizard-error">Informe ao menos um volume com quantidade e descrição.</div>
                                    </div>
                                </div>
                                <div class="wizard-col-12">
                                    <div class="wizard-field">
                                        <label class="wizard-required">Assinatura do responsável (etapa inicial)</label>
                                        <div class="wizard-signature-area">
                                            <canvas id="termo-signature-canvas" class="wizard-signature-canvas"></canvas>
                                            <div class="wizard-signature-actions">
                                                <button type="button" class="btn btn-secondary" id="termo-signature-clear">Limpar assinatura</button>
                                            </div>
                                            <div class="wizard-signature-hint">Solicite que o responsável assine dentro da área indicada.</div>
                                        </div>
                                        <div class="wizard-error">A assinatura é obrigatória.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="wizard-actions">
                    <button type="button" class="btn btn-ghost" id="termo-btn-voltar">Voltar</button>
                    <div style="display:flex; gap:10px;">
                        <button type="button" class="btn btn-secondary" id="termo-btn-cancelar">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="termo-btn-avancar">Avançar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Movimentações -->
    <div class="modal modal-large" id="movimentacao-modal">
        <div class="modal-content modal-scrollable">
            <div class="modal-header">
                <div class="modal-title" id="movimentacao-modal-title">Movimentações</div>
                <button class="modal-close" id="movimentacao-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    Registre entradas e saídas de objetos do armário sempre que ocorrer qualquer movimentação.
                </div>
                <div class="movimentacoes-list" id="movimentacoes-list"></div>
                <form id="movimentacao-form">
                    <div class="form-group">
                        <label for="mov-tipo">Tipo de movimentação</label>
                        <select id="mov-tipo" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="entrada">Entrada de pertences</option>
                            <option value="saida">Saída de pertences</option>
                            <option value="conferencia">Conferência</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mov-descricao">Descrição</label>
                        <textarea id="mov-descricao" class="form-control" rows="3" required placeholder="Descreva brevemente o que ocorreu"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Responsável pelo registro</label>
                        <div class="form-static" id="mov-responsavel-info">Será preenchido automaticamente com seu usuário.</div>
                    </div>
                    <div class="form-group" style="display:flex; gap:12px;">
                        <div style="flex:1;">
                            <label for="mov-data">Data</label>
                            <input type="date" id="mov-data" class="form-control" required>
                        </div>
                        <div style="flex:1;">
                            <label for="mov-hora">Hora</label>
                            <input type="time" id="mov-hora" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-actions" style="justify-content:flex-start;">
                        <button type="submit" class="btn btn-primary">Adicionar movimentação</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Painel de Notificações -->
    <div class="notification-panel" id="notification-panel">
        <div class="notification-header">
            Notificações
        </div>
        <div class="notification-list">
            <div class="notification-item">
                <div class="notification-icon danger">
                    <i class="fas fa-exclamation"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Armário V-15 vencido</div>
                    <div class="notification-time">Há 5 minutos</div>
                </div>
            </div>
            <div class="notification-item">
                <div class="notification-icon danger">
                    <i class="fas fa-exclamation"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Armário V-32 vencido</div>
                    <div class="notification-time">Há 12 minutos</div>
                </div>
            </div>
            <div class="notification-item">
                <div class="notification-icon warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Armário A-07 próximo do horário</div>
                    <div class="notification-time">Há 2 minutos</div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div class="avatar-modal-backdrop hidden" id="avatar-modal-backdrop" aria-hidden="true">
        <div class="avatar-modal hidden" id="avatar-modal" role="dialog" aria-modal="true" aria-labelledby="avatar-modal-title">
            <div class="avatar-modal-header">
                <h3 class="avatar-modal-title" id="avatar-modal-title">Escolher avatar</h3>
                <button type="button" class="avatar-modal-close" id="avatar-modal-close" aria-label="Fechar seleção de avatar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="avatar-modal-description">Selecione uma imagem abaixo ou informe a URL de uma foto para personalizar seu perfil.</p>
            <div class="avatar-grid" id="avatar-options" role="listbox" aria-label="Avatares sugeridos"></div>
            <div class="avatar-custom">
                <label for="avatar-url">Usar URL personalizada</label>
                <div class="avatar-custom-control">
                    <input type="url" id="avatar-url" name="avatar-url" placeholder="https://exemplo.com/minha-foto.jpg" autocomplete="off">
                    <button type="button" class="avatar-apply-button" id="avatar-url-apply">Aplicar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="global-loading-overlay" id="global-loading-overlay" role="status" aria-live="assertive" aria-hidden="true">
        <div class="global-loading-content">
            <span class="global-loading-spinner" aria-hidden="true"></span>
            <span id="global-loading-text">Processando...</span>
        </div>
    </div>
    <script>
        // URL do Google Apps Script - ATUALIZE COM SUA URL
        const SCRIPT_URL = 'https://script.google.com/a/macros/isgh.org.br/s/AKfycbzbGb6sQR1auYsyTB-kwPos7Cd7swLuTUDiAzzpwTPW2cj76ykYzKYgBDXA-g5ef7pbpw/exec';
        // Estado da aplicação
        function criarEstadoInicial() {
            return {
                perfilAtual: 'geral',
                unidadeAtual: 'todas',
                filtroAtual: 'todos',
                paginaAtual: 'dashboard',
                armarios: [],
                armariosCarregados: false,
                cadastroArmarios: [],
                unidades: [],
                setores: [],
                notificacoes: [],
                termos: {},
                movimentacoes: {},
                usuarios: [],
                logs: [],
                carregamentoTermosId: 0,
                autenticado: false,
                usuarioAutenticado: null
            };
        }
        let estado = criarEstadoInicial();
        const STORAGE_KEYS = {
            sessaoUsuario: 'locknac_sessao_usuario'
        };
        const SESSAO_TTL_MS = 1000 * 60 * 60 * 8; // 8 horas
        const AVATAR_OPTIONS = [
            {
                id: 'avatar-none',
                label: 'Sem imagem',
                initials: '🙂',
                background: 'linear-gradient(135deg, #e5e7eb, #f9fafb)',
                textColor: '#1f2937'
            },
            {
                id: 'avatar-astronaut',
                label: 'Astronauta',
                url: 'https://api.dicebear.com/7.x/bottts-neutral/png?seed=Astronauta&backgroundColor=1f2937'
            },
            {
                id: 'avatar-guardiao',
                label: 'Guardião',
                url: 'https://api.dicebear.com/7.x/adventurer-neutral/png?seed=Guardiao&backgroundColor=f9fafb'
            },
            {
                id: 'avatar-exploradora',
                label: 'Exploradora',
                url: 'https://api.dicebear.com/7.x/croodles-neutral/png?seed=Exploradora&backgroundColor=f2f2f2'
            },
            {
                id: 'avatar-raposa',
                label: 'Raposa',
                url: 'https://api.dicebear.com/7.x/lorelei-neutral/png?seed=Raposa&backgroundColor=fee2e2'
            },
            {
                id: 'avatar-robotica',
                label: 'Robótica',
                url: 'https://api.dicebear.com/7.x/bottts/png?seed=Robotica&backgroundColor=dbebff'
            }
        ];
        let armazenamentoLocalDisponivel;
        function obterArmazenamentoLocal() {
            if (armazenamentoLocalDisponivel !== undefined) {
                return armazenamentoLocalDisponivel;
            }
            try {
                if (typeof window !== 'undefined' && window.localStorage) {
                    const chaveTeste = '__locknac_sessao_teste__';
                    window.localStorage.setItem(chaveTeste, '1');
                    window.localStorage.removeItem(chaveTeste);
                    armazenamentoLocalDisponivel = window.localStorage;
                    return armazenamentoLocalDisponivel;
                }
            } catch (erro) {
                console.warn('Armazenamento local indisponível:', erro);
            }
            armazenamentoLocalDisponivel = null;
            return armazenamentoLocalDisponivel;
        }
        function salvarSessaoUsuario(usuario) {
            const storage = obterArmazenamentoLocal();
            if (!storage) return;
            try {
                const dados = {
                    usuario,
                    atualizadoEm: Date.now()
                };
                storage.setItem(STORAGE_KEYS.sessaoUsuario, JSON.stringify(dados));
            } catch (erro) {
                console.warn('Não foi possível salvar a sessão do usuário:', erro);
            }
        }
        function restaurarSessaoUsuario() {
            const storage = obterArmazenamentoLocal();
            if (!storage) return null;
            try {
                const dadosBrutos = storage.getItem(STORAGE_KEYS.sessaoUsuario);
                if (!dadosBrutos) {
                    return null;
                }
                const dados = JSON.parse(dadosBrutos);
                if (!dados || !dados.usuario) {
                    return null;
                }
                if (dados.atualizadoEm && (Date.now() - dados.atualizadoEm) > SESSAO_TTL_MS) {
                    storage.removeItem(STORAGE_KEYS.sessaoUsuario);
                    return null;
                }
                return dados.usuario;
            } catch (erro) {
                console.warn('Falha ao restaurar sessão do usuário:', erro);
                try {
                    storage.removeItem(STORAGE_KEYS.sessaoUsuario);
                } catch (erroRemocao) {
                    console.warn('Não foi possível limpar sessão inválida:', erroRemocao);
                }
                return null;
            }
        }
        function limparSessaoUsuario() {
            const storage = obterArmazenamentoLocal();
            if (!storage) return;
            try {
                storage.removeItem(STORAGE_KEYS.sessaoUsuario);
            } catch (erro) {
                console.warn('Não foi possível limpar a sessão do usuário:', erro);
            }
        }
        function persistirSessaoAtual() {
            if (estado.autenticado && estado.usuarioAutenticado) {
                const usuarioAtual = {
                    ...estado.usuarioAutenticado,
                    unidades: normalizarListaDeUnidades(estado.usuarioAutenticado.unidades)
                };
                salvarSessaoUsuario(usuarioAtual);
            } else {
                limparSessaoUsuario();
            }
        }
        function popularAvataresPadrao() {
            if (!elementos.avatarOptions) {
                return;
            }
            elementos.avatarOptions.innerHTML = '';
            AVATAR_OPTIONS.forEach(option => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'avatar-option';
                button.dataset.avatarId = option.id;
                button.dataset.avatarUrl = option.url ? option.url.toString() : '';
                button.setAttribute('aria-label', option.label);
                button.setAttribute('role', 'option');
                button.setAttribute('aria-selected', 'false');
                if (option.url) {
                    const img = document.createElement('img');
                    img.src = option.url;
                    img.alt = option.label;
                    img.loading = 'lazy';
                    button.appendChild(img);
                } else {
                    const span = document.createElement('span');
                    span.textContent = option.initials || '';
                    if (option.background) {
                        span.style.background = option.background;
                    }
                    if (option.textColor) {
                        span.style.color = option.textColor;
                    }
                    button.appendChild(span);
                }
                elementos.avatarOptions.appendChild(button);
            });
        }
        function obterAvatarAtualUrl() {
            const usuario = obterUsuarioAutenticado();
            return usuario && usuario.avatarUrl ? usuario.avatarUrl.toString().trim() : '';
        }
        function sincronizarSelecaoAvatar() {
            if (!elementos.avatarOptions) {
                return;
            }
            const atual = obterAvatarAtualUrl();
            const botoes = elementos.avatarOptions.querySelectorAll('.avatar-option');
            botoes.forEach(botao => {
                const valor = botao.dataset.avatarUrl || '';
                const selecionado = valor ? valor === atual : !atual;
                botao.classList.toggle('selected', selecionado);
                botao.setAttribute('aria-selected', selecionado ? 'true' : 'false');
            });
        }
        function avatarModalAberto() {
            return elementos.avatarModal && !elementos.avatarModal.classList.contains('hidden');
        }
        function abrirModalAvatar() {
            if (!elementos.avatarModal || !elementos.avatarModalBackdrop) {
                return;
            }
            elementos.avatarModalBackdrop.classList.remove('hidden');
            elementos.avatarModal.classList.remove('hidden');
            elementos.avatarModalBackdrop.setAttribute('aria-hidden', 'false');
            if (elementos.headerUserProfile) {
                elementos.headerUserProfile.setAttribute('aria-expanded', 'true');
            }
            sincronizarSelecaoAvatar();
            requestAnimationFrame(() => {
                const selecionado = elementos.avatarOptions?.querySelector('.avatar-option.selected');
                const alvo = selecionado || elementos.avatarOptions?.querySelector('.avatar-option');
                alvo?.focus();
            });
        }
        function fecharModalAvatar({ focusTrigger = true } = {}) {
            if (!elementos.avatarModal || !elementos.avatarModalBackdrop) {
                return;
            }
            elementos.avatarModal.classList.add('hidden');
            elementos.avatarModalBackdrop.classList.add('hidden');
            elementos.avatarModalBackdrop.setAttribute('aria-hidden', 'true');
            if (elementos.headerUserProfile) {
                elementos.headerUserProfile.setAttribute('aria-expanded', 'false');
                if (focusTrigger) {
                    elementos.headerUserProfile.focus();
                }
            }
            if (elementos.avatarUrlInput) {
                elementos.avatarUrlInput.value = '';
                elementos.avatarUrlInput.classList.remove('invalid');
                elementos.avatarUrlInput.removeAttribute('aria-invalid');
            }
        }
        function aplicarAvatarUsuario(url) {
            if (!estado.autenticado || !estado.usuarioAutenticado) {
                fecharModalAvatar({ focusTrigger: false });
                return;
            }
            const normalizado = (url || '').toString().trim();
            if (normalizado) {
                estado.usuarioAutenticado.avatarUrl = normalizado;
            } else if (estado.usuarioAutenticado.avatarUrl) {
                delete estado.usuarioAutenticado.avatarUrl;
            }
            atualizarCabecalhoUsuario();
            persistirSessaoAtual();
            sincronizarSelecaoAvatar();
            fecharModalAvatar();
        }
        function aplicarAvatarPersonalizado() {
            if (!elementos.avatarUrlInput) {
                return;
            }
            const valor = elementos.avatarUrlInput.value.trim();
            if (!valor) {
                elementos.avatarUrlInput.classList.add('invalid');
                elementos.avatarUrlInput.setAttribute('aria-invalid', 'true');
                elementos.avatarUrlInput.focus();
                return;
            }
            try {
                const urlValida = new URL(valor);
                elementos.avatarUrlInput.classList.remove('invalid');
                elementos.avatarUrlInput.removeAttribute('aria-invalid');
                const urlFinal = urlValida.toString();
                elementos.avatarUrlInput.value = '';
                aplicarAvatarUsuario(urlFinal);
            } catch (erro) {
                elementos.avatarUrlInput.classList.add('invalid');
                elementos.avatarUrlInput.setAttribute('aria-invalid', 'true');
                elementos.avatarUrlInput.focus();
            }
        }
        // Elementos DOM
        const elementos = {
            loginContainer: document.getElementById('login-container'),
            appShell: document.getElementById('app-shell'),
            loginForm: document.getElementById('login-form'),
            loginUsuario: document.getElementById('login-usuario'),
            loginSenha: document.getElementById('login-senha'),
            loginSubmit: document.getElementById('login-submit'),
            loginFeedback: document.getElementById('login-feedback'),
            profileSelect: document.getElementById('profile-select'),
            unitSelect: document.getElementById('unit-select'),
            notificationBell: document.getElementById('notification-bell'),
            notificationPanel: document.getElementById('notification-panel'),
            notificationBadge: document.querySelector('.notification-badge'),
            armariosContainer: document.getElementById('armarios-container'),
            armarioModal: document.getElementById('armario-modal'),
            usuarioModal: document.getElementById('usuario-modal'),
            modalTitle: document.getElementById('modal-title'),
            armarioForm: document.getElementById('armario-form'),
            usuarioForm: document.getElementById('usuario-form'),
            usuarioModalTitle: document.getElementById('usuario-modal-title'),
            usuarioSenha: document.getElementById('usuario-senha'),
            usuarioStatus: document.getElementById('usuario-status'),
            usuarioUnidades: document.getElementById('usuario-unidades'),
            modalClose: document.getElementById('modal-close'),
            usuarioModalClose: document.getElementById('usuario-modal-close'),
            btnCancelar: document.getElementById('btn-cancelar'),
            usuarioBtnCancelar: document.getElementById('usuario-btn-cancelar'),
            nomeVisitanteLabel: document.querySelector("label[for='nome-visitante']"),
            horaPrevistaInput: document.getElementById('hora-prevista'),
            horaPrevistaGroup: document.getElementById('hora-prevista-group'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            cardsCount: {
                livres: document.getElementById('livres-count'),
                emUso: document.getElementById('em-uso-count'),
                proximo: document.getElementById('proximo-count'),
                vencidos: document.getElementById('vencidos-count')
            },
            pages: document.querySelectorAll('.page'),
            menuLinks: document.querySelectorAll('.sidebar-menu a[data-page]'),
            headerUserProfile: document.getElementById('header-user-profile'),
            headerUserAvatar: document.getElementById('header-user-avatar'),
            headerUserName: document.getElementById('header-user-name'),
            headerUserRole: document.getElementById('header-user-role'),
            avatarModal: document.getElementById('avatar-modal'),
            avatarModalBackdrop: document.getElementById('avatar-modal-backdrop'),
            avatarModalClose: document.getElementById('avatar-modal-close'),
            avatarOptions: document.getElementById('avatar-options'),
            avatarUrlInput: document.getElementById('avatar-url'),
            avatarUrlApply: document.getElementById('avatar-url-apply'),
            globalLoadingOverlay: document.getElementById('global-loading-overlay'),
            globalLoadingText: document.getElementById('global-loading-text'),
            termoModal: document.getElementById('termo-modal'),
            termoForm: document.getElementById('termo-form'),
            termoSetor: document.getElementById('termo-setor'),
            termoModalClose: document.getElementById('termo-modal-close'),
            termoBtnVoltar: document.getElementById('termo-btn-voltar'),
            termoBtnAvancar: document.getElementById('termo-btn-avancar'),
            termoBtnCancelar: document.getElementById('termo-btn-cancelar'),
            termoProgress: document.getElementById('termo-progress'),
            termoProgressLabel: document.getElementById('termo-progress-label'),
            termoArmario: document.getElementById('termo-armario'),
            termoVolumesList: document.getElementById('termo-volumes-list'),
            termoAddVolume: document.getElementById('termo-add-volume'),
            termoVolumesField: document.getElementById('termo-volumes-field'),
            termoAssinaturaCanvas: document.getElementById('termo-signature-canvas'),
            termoAssinaturaClear: document.getElementById('termo-signature-clear'),
            tabelaTermos: document.getElementById('tabela-termos'),
            tabelaTermosBody: document.querySelector('#tabela-termos tbody'),
            movimentacaoModal: document.getElementById('movimentacao-modal'),
            movimentacaoModalClose: document.getElementById('movimentacao-modal-close'),
            movimentacoesList: document.getElementById('movimentacoes-list'),
            movimentacaoForm: document.getElementById('movimentacao-form'),
            movimentacaoModalTitle: document.getElementById('movimentacao-modal-title'),
            movTipo: document.getElementById('mov-tipo'),
            movDescricao: document.getElementById('mov-descricao'),
            movResponsavelInfo: document.getElementById('mov-responsavel-info'),
            movData: document.getElementById('mov-data'),
            movHora: document.getElementById('mov-hora'),
            btnNovaUnidade: document.getElementById('btn-nova-unidade'),
            tabelaUnidades: document.getElementById('tabela-unidades'),
            tabelaUnidadesBody: document.querySelector('#tabela-unidades tbody'),
            tabelaUsuarios: document.getElementById('tabela-usuarios'),
            tabelaUsuariosBody: document.querySelector('#tabela-usuarios tbody'),
            logoutButton: document.getElementById('logout-button')
        };
        popularAvataresPadrao();
        sincronizarSelecaoAvatar();
        const customSelectorInstances = new WeakMap();
        const customSelectorStore = new Set();
        const paginasRestritasUsuario = new Set(['cadastro-armarios', 'cadastro-unidades', 'usuarios', 'logs']);
        let aplicacaoInicializada = false;
        let loginInicializado = false;
        let eventosInicializados = false;
        function aprimorarSeletoresCabecalho() {
            document.querySelectorAll('.selector-control .selector-input').forEach(select => criarSelectorPersonalizado(select));
        }
        function criarSelectorPersonalizado(select) {
            if (!select) return;
            const control = select.closest('.selector-control');
            if (!control) return;
            if (customSelectorInstances.has(select)) {
                atualizarSelectorPersonalizado(select);
                return;
            }
            const trigger = control.querySelector('.selector-trigger');
            const dropdown = control.querySelector('.selector-dropdown');
            if (!trigger || !dropdown) return;
            const labelEl = trigger.querySelector('.selector-trigger-label');
            const descriptionEl = trigger.querySelector('.selector-trigger-description');
            dropdown.innerHTML = '';
            const optionsList = document.createElement('ul');
            optionsList.className = 'selector-options';
            optionsList.setAttribute('role', 'presentation');
            dropdown.appendChild(optionsList);
            select.classList.add('selector-native-input');
            select.setAttribute('tabindex', '-1');
            select.setAttribute('aria-hidden', 'true');
            const instance = {
                select,
                control,
                trigger,
                dropdown,
                optionsList,
                labelEl,
                descriptionEl,
                optionButtons: new Map()
            };
            customSelectorInstances.set(select, instance);
            customSelectorStore.add(instance);
            control.addEventListener('focusout', event => {
                if (!control.contains(event.relatedTarget)) {
                    control.classList.remove('open');
                    trigger.setAttribute('aria-expanded', 'false');
                }
            });
            trigger.addEventListener('click', () => toggleSelectorDropdown(instance));
            trigger.addEventListener('keydown', event => handleTriggerKeydown(event, instance));
            optionsList.addEventListener('click', event => handleOptionClick(event, instance));
            optionsList.addEventListener('keydown', event => handleOptionKeydown(event, instance));
            select.addEventListener('change', () => sincronizarTriggerComSelect(instance));
            popularOpcoesPersonalizadas(instance);
            sincronizarTriggerComSelect(instance);
        }
        function atualizarSelectorPersonalizado(select) {
            const instance = customSelectorInstances.get(select);
            if (!instance) {
                criarSelectorPersonalizado(select);
                return;
            }
            popularOpcoesPersonalizadas(instance);
            sincronizarTriggerComSelect(instance);
        }
        function popularOpcoesPersonalizadas(instance) {
            const { select, optionsList, optionButtons } = instance;
            optionButtons.clear();
            optionsList.innerHTML = '';
            Array.from(select.options).forEach(option => {
                const item = document.createElement('li');
                item.className = 'selector-option';
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'selector-option-button';
                button.dataset.value = option.value;
                button.setAttribute('role', 'option');
                button.tabIndex = -1;
                if (option.disabled) {
                    button.disabled = true;
                    button.classList.add('is-disabled');
                    button.setAttribute('aria-disabled', 'true');
                }
                const content = document.createElement('div');
                content.className = 'selector-option-content';
                const iconWrapper = document.createElement('span');
                const iconClass = option.dataset.icon;
                if (iconClass) {
                    iconWrapper.className = 'selector-option-icon';
                    iconWrapper.innerHTML = `<i class="${iconClass}"></i>`;
                } else {
                    iconWrapper.className = 'selector-option-bullet';
                    iconWrapper.textContent = (option.textContent || '').trim().charAt(0) || '?';
                }
                const textWrapper = document.createElement('div');
                textWrapper.className = 'selector-option-text';
                const label = document.createElement('span');
                label.className = 'selector-option-label';
                label.textContent = option.textContent;
                textWrapper.appendChild(label);
                if (option.dataset.description) {
                    const description = document.createElement('span');
                    description.className = 'selector-option-description';
                    description.textContent = option.dataset.description;
                    textWrapper.appendChild(description);
                }
                content.appendChild(iconWrapper);
                content.appendChild(textWrapper);
                button.appendChild(content);
                const check = document.createElement('span');
                check.className = 'selector-option-check';
                check.innerHTML = '<i class="fas fa-check"></i>';
                button.appendChild(check);
                item.appendChild(button);
                optionsList.appendChild(item);
                optionButtons.set(option.value, button);
            });
            sincronizarTriggerComSelect(instance);
        }
        function sincronizarTriggerComSelect(instance) {
            const { select, labelEl, descriptionEl, optionButtons } = instance;
            const selectedOption = select.options[select.selectedIndex];
            const labelTexto = selectedOption ? selectedOption.textContent : 'Selecionar';
            if (labelEl) labelEl.textContent = labelTexto;
            if (descriptionEl) {
                const descricao = selectedOption?.dataset?.description || '';
                descriptionEl.textContent = descricao;
                descriptionEl.hidden = !descricao;
            }
            optionButtons.forEach((button, value) => {
                const isSelected = selectedOption && value === selectedOption.value;
                button.classList.toggle('is-selected', Boolean(isSelected));
                button.setAttribute('aria-selected', isSelected ? 'true' : 'false');
            });
        }
        function toggleSelectorDropdown(instance, forceState) {
            const { control, trigger } = instance;
            const isOpen = control.classList.contains('open');
            const shouldOpen = typeof forceState === 'boolean' ? forceState : !isOpen;
            if (shouldOpen) {
                fecharTodosSeletores(instance);
                control.classList.add('open');
                trigger.setAttribute('aria-expanded', 'true');
                focarOpcaoSelecionada(instance);
            } else {
                control.classList.remove('open');
                trigger.setAttribute('aria-expanded', 'false');
            }
        }
        function fecharTodosSeletores(exceto) {
            customSelectorStore.forEach(instance => {
                if (instance !== exceto) {
                    instance.control.classList.remove('open');
                    instance.trigger.setAttribute('aria-expanded', 'false');
                }
            });
        }
        function handleOptionClick(event, instance) {
            const button = event.target.closest('.selector-option-button');
            if (!button || button.disabled) return;
            selecionarValorPersonalizado(instance, button.dataset.value);
        }
        function selecionarValorPersonalizado(instance, value) {
            const { select } = instance;
            const valorAtual = select.value;
            if (valorAtual !== value) {
                select.value = value;
                select.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
                sincronizarTriggerComSelect(instance);
            }
            toggleSelectorDropdown(instance, false);
            instance.trigger.focus();
        }
        function handleOptionKeydown(event, instance) {
            const button = event.target.closest('.selector-option-button');
            if (!button) return;
            switch (event.key) {
                case 'ArrowDown':
                case 'ArrowRight':
                    event.preventDefault();
                    focarProximaOpcao(instance, button, 1);
                    break;
                case 'ArrowUp':
                case 'ArrowLeft':
                    event.preventDefault();
                    focarProximaOpcao(instance, button, -1);
                    break;
                case 'Home':
                    event.preventDefault();
                    focarExtremaOpcao(instance, 'first');
                    break;
                case 'End':
                    event.preventDefault();
                    focarExtremaOpcao(instance, 'last');
                    break;
                case 'Enter':
                case ' ':
                    event.preventDefault();
                    if (!button.disabled) {
                        selecionarValorPersonalizado(instance, button.dataset.value);
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    toggleSelectorDropdown(instance, false);
                    instance.trigger.focus();
                    break;
            }
        }
        function handleTriggerKeydown(event, instance) {
            if (['ArrowDown', 'ArrowUp', 'Enter', ' '].includes(event.key)) {
                event.preventDefault();
                toggleSelectorDropdown(instance, true);
                focarOpcaoSelecionada(instance, event.key === 'ArrowUp');
            } else if (event.key === 'Escape') {
                toggleSelectorDropdown(instance, false);
            }
        }
        function focarProximaOpcao(instance, currentButton, direction) {
            const buttons = Array.from(instance.optionsList.querySelectorAll('.selector-option-button:not(.is-disabled)'));
            if (!buttons.length) return;
            const indexAtual = buttons.indexOf(currentButton);
            const novoIndice = (indexAtual + direction + buttons.length) % buttons.length;
            buttons[novoIndice]?.focus();
        }
        function focarExtremaOpcao(instance, posicao) {
            const buttons = Array.from(instance.optionsList.querySelectorAll('.selector-option-button:not(.is-disabled)'));
            if (!buttons.length) return;
            const target = posicao === 'last' ? buttons[buttons.length - 1] : buttons[0];
            target.focus();
        }
        function focarOpcaoSelecionada(instance, preferirUltima = false) {
            requestAnimationFrame(() => {
                const selectedOption = instance.select.options[instance.select.selectedIndex];
                const selectedButton = selectedOption ? instance.optionButtons.get(selectedOption.value) : null;
                const buttons = Array.from(instance.optionsList.querySelectorAll('.selector-option-button:not(.is-disabled)'));
                if (selectedButton && !selectedButton.disabled) {
                    selectedButton.focus();
                } else if (buttons.length) {
                    const alvo = preferirUltima ? buttons[buttons.length - 1] : buttons[0];
                    alvo.focus();
                }
            });
        }
        document.addEventListener('click', event => {
            const control = event.target.closest('.selector-control');
            customSelectorStore.forEach(instance => {
                if (instance.control !== control) {
                    instance.control.classList.remove('open');
                    instance.trigger.setAttribute('aria-expanded', 'false');
                }
            });
        });
        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') {
                customSelectorStore.forEach(instance => {
                    if (instance.control.classList.contains('open')) {
                        const shouldReturnFocus = instance.control.contains(document.activeElement);
                        instance.control.classList.remove('open');
                        instance.trigger.setAttribute('aria-expanded', 'false');
                        if (shouldReturnFocus) {
                            instance.trigger.focus();
                        }
                    }
                });
            }
        });
        const normalizarTexto = (valor) => (valor ?? '').toString().trim().toLowerCase();
        const normalizarIdentificador = (valor) => (valor ?? '').toString().trim();
        function montarIdentificadoresArmario(armario) {
            if (!armario) {
                return null;
            }
            const idPlanilha = armario.idPlanilha !== undefined && armario.idPlanilha !== null
                ? armario.idPlanilha.toString().trim()
                : '';
            const numeroArmario = normalizarIdentificador(armario.numero);
            const tipo = armario.tipo || '';
            return { idPlanilha, numeroArmario, tipo };
        }
        function montarPayloadTermo(armario, extras = {}) {
            const identificadores = montarIdentificadoresArmario(armario) || { idPlanilha: '', numeroArmario: '', tipo: '' };
            return {
                armarioId: identificadores.idPlanilha,
                numeroArmario: identificadores.numeroArmario,
                tipo: identificadores.tipo,
                ...extras
            };
        }
        function montarPayloadAcaoArmario(armario, extras = {}) {
            const identificadores = montarIdentificadoresArmario(armario) || { idPlanilha: '', numeroArmario: '', tipo: '' };
            return {
                id: identificadores.idPlanilha,
                armarioId: identificadores.idPlanilha,
                numeroArmario: identificadores.numeroArmario,
                tipo: identificadores.tipo,
                usuarioResponsavel: obterDescricaoResponsavelAtual(),
                ...extras
            };
        }
        function extrairIdDataset(elemento) {
            if (!elemento || !elemento.dataset) {
                return '';
            }
            const bruto = elemento.dataset.id;
            return bruto === undefined || bruto === null ? '' : normalizarIdentificador(bruto);
        }
        function obterUsuarioAutenticado() {
            return estado.usuarioAutenticado || null;
        }
        function obterDataHoraLocalPadrao() {
            const agora = new Date();
            const offset = agora.getTimezoneOffset();
            const local = new Date(agora.getTime() - offset * 60000);
            const isoLocal = local.toISOString();
            return {
                data: isoLocal.slice(0, 10),
                hora: isoLocal.slice(11, 16)
            };
        }
        function obterDescricaoResponsavelAtual() {
            const usuario = obterUsuarioAutenticado();
            if (!usuario) {
                return '';
            }
            const nome = (usuario.nome || '').toString().trim();
            const matricula = (usuario.matricula || '').toString().trim();
            const login = (usuario.usuario || '').toString().trim();
            const partes = [];
            if (nome) {
                partes.push(nome);
            }
            if (matricula) {
                partes.push(matricula);
            } else if (login && !partes.includes(login)) {
                partes.push(login);
            }
            return partes.join(' - ') || nome || matricula || login;
        }
        function atualizarResponsavelMovimentacaoInfo() {
            if (!elementos.movResponsavelInfo) {
                return;
            }
            const descricao = obterDescricaoResponsavelAtual();
            if (descricao) {
                elementos.movResponsavelInfo.textContent = descricao;
                elementos.movResponsavelInfo.classList.remove('is-warning');
            } else {
                elementos.movResponsavelInfo.textContent = 'Faça login para registrar movimentações.';
                elementos.movResponsavelInfo.classList.add('is-warning');
            }
        }
        function perfilAtualEhAdmin() {
            const usuario = obterUsuarioAutenticado();
            return usuario ? normalizarTexto(usuario.perfil) === 'admin' : false;
        }
        function normalizarListaDeUnidades(unidades) {
            if (!unidades) return [];
            if (Array.isArray(unidades)) {
                return unidades
                    .map(valor => (valor ?? '').toString().trim())
                    .filter(valor => valor);
            }
            if (typeof unidades === 'string') {
                const texto = unidades.toString().trim();
                if (!texto) {
                    return [];
                }
                if ((texto.startsWith('[') && texto.endsWith(']')) || (texto.startsWith('{') && texto.endsWith('}'))) {
                    try {
                        const convertido = JSON.parse(texto);
                        return normalizarListaDeUnidades(convertido);
                    } catch (erro) {
                        console.warn('Falha ao interpretar unidades como JSON:', erro);
                    }
                }
                const separador = texto.includes(';') || texto.includes(',') ? /[;,]/ : null;
                if (separador) {
                    return texto.split(separador).map(valor => valor.trim()).filter(valor => valor);
                }
                return [texto];
            }
            if (typeof unidades === 'object') {
                const valores = [];
                Object.keys(unidades).forEach(chave => {
                    const valor = unidades[chave];
                    if (Array.isArray(valor)) {
                        valores.push(...valor);
                    } else if (valor !== undefined && valor !== null) {
                        valores.push(valor);
                    }
                });
                return normalizarListaDeUnidades(valores);
            }
            return [(unidades ?? '').toString().trim()].filter(valor => valor);
        }
        function obterIdsPermitidos() {
            const usuario = obterUsuarioAutenticado();
            if (!usuario) {
                return [];
            }
            const unidadesNormalizadas = normalizarListaDeUnidades(usuario.unidades);
            if (perfilAtualEhAdmin() || unidadesNormalizadas.some(valor => normalizarTexto(valor) === 'all')) {
                return null;
            }
            return unidadesNormalizadas;
        }
        function obterUnidadesPermitidas() {
            const idsPermitidos = obterIdsPermitidos();
            if (idsPermitidos === null) {
                return estado.unidades.slice();
            }
            if (!idsPermitidos.length) {
                return [];
            }
            return estado.unidades.filter(unidade => idsPermitidos.includes(String(unidade.id)));
        }
        function usuarioPodeVerUnidade(unidadeReferencia) {
            const idsPermitidos = obterIdsPermitidos();
            if (idsPermitidos === null) {
                return true;
            }
            if (!idsPermitidos.length) {
                return false;
            }
            const referencia = (unidadeReferencia ?? '').toString().trim();
            if (!referencia) {
                return false;
            }
            if (idsPermitidos.includes(referencia)) {
                return true;
            }
            const referenciaNormalizada = normalizarTexto(referencia);
            const unidadeEncontrada = estado.unidades.find(unidade => {
                const nomeNormalizado = normalizarTexto(unidade.nome);
                return nomeNormalizado === referenciaNormalizada || String(unidade.id) === referencia;
            });
            if (!unidadeEncontrada) {
                return false;
            }
            return idsPermitidos.includes(String(unidadeEncontrada.id));
        }
        function filtrarListaPorPermissao(lista, extrator) {
            if (!Array.isArray(lista)) return [];
            return lista.filter(item => usuarioPodeVerUnidade(extrator ? extrator(item) : item));
        }
        function usuarioTemAcessoPagina(pagina) {
            if (!estado.autenticado) return false;
            if (perfilAtualEhAdmin()) return true;
            return !paginasRestritasUsuario.has(pagina);
        }
        function gerarIniciais(nome) {
            if (!nome) return '--';
            const partes = nome.trim().split(/\s+/).filter(Boolean);
            if (partes.length >= 2) {
                return (partes[0][0] + partes[partes.length - 1][0]).toUpperCase();
            }
            const unica = partes[0];
            return unica.slice(0, Math.min(2, unica.length)).toUpperCase();
        }
        function normalizarListaSetores(setores) {
            const lista = Array.isArray(setores) ? setores : [];
            const vistos = new Set();
            const resultado = [];
            lista.forEach(item => {
                const texto = (item ?? '').toString().trim();
                if (!texto) {
                    return;
                }
                const chave = normalizarTexto(texto);
                if (vistos.has(chave)) {
                    return;
                }
                vistos.add(chave);
                resultado.push(texto);
            });
            return resultado.sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));
        }
        function atualizarOpcoesSetorTermo(lista = estado.setores) {
            const select = elementos.termoSetor;
            if (!select) {
                return;
            }
            const valorAtual = select.value;
            const setoresValidos = normalizarListaSetores(lista);
            select.innerHTML = '';
            const opcaoPadrao = document.createElement('option');
            opcaoPadrao.value = '';
            opcaoPadrao.textContent = 'Selecione o setor';
            select.appendChild(opcaoPadrao);
            setoresValidos.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = setor;
                select.appendChild(option);
            });
            if (valorAtual) {
                garantirOpcaoSetor(valorAtual);
                select.value = valorAtual;
            } else {
                select.value = '';
            }
        }
        function garantirOpcaoSetor(setor) {
            const select = elementos.termoSetor;
            if (!select) {
                return;
            }
            const texto = (setor ?? '').toString().trim();
            if (!texto) {
                return;
            }
            const chaveTexto = normalizarTexto(texto);
            const existe = Array.from(select.options).some(opt => normalizarTexto(opt.value) === chaveTexto);
            if (!existe) {
                const option = document.createElement('option');
                option.value = texto;
                option.textContent = texto;
                select.appendChild(option);
            }
        }
        function definirSetorTermo(valor) {
            const select = elementos.termoSetor;
            if (!select) {
                return;
            }
            const texto = (valor ?? '').toString().trim();
            if (!texto) {
                select.value = '';
                return;
            }
            garantirOpcaoSetor(texto);
            select.value = texto;
        }
        function obterDescricaoUnidades(unidadesLista) {
            const lista = normalizarListaDeUnidades(unidadesLista);
            if (!lista.length) {
                return 'Nenhuma';
            }
            if (lista.some(valor => normalizarTexto(valor) === 'all')) {
                return 'Todas';
            }
            const nomes = lista.map(id => {
                const unidade = estado.unidades.find(item => String(item.id) === String(id));
                return unidade ? unidade.nome : `ID ${id}`;
            });
            return nomes.join(', ');
        }
        function atualizarCabecalhoUsuario() {
            if (!elementos.headerUserName || !elementos.headerUserAvatar || !elementos.headerUserRole) {
                return;
            }
            const usuario = obterUsuarioAutenticado();
            if (!usuario) {
                elementos.headerUserName.textContent = 'Usuário';
                elementos.headerUserRole.textContent = '';
                elementos.headerUserAvatar.textContent = '--';
                elementos.headerUserAvatar.style.backgroundImage = '';
                elementos.headerUserAvatar.classList.remove('has-image');
                atualizarResponsavelMovimentacaoInfo();
                return;
            }
            const nomeLimpo = (usuario.nome || 'Usuário').toString().trim();
            elementos.headerUserName.textContent = nomeLimpo;
            elementos.headerUserRole.textContent = perfilAtualEhAdmin() ? 'Administrador' : 'Usuário';
            const avatarUrl = usuario.avatarUrl ? usuario.avatarUrl.toString().trim() : '';
            if (avatarUrl) {
                elementos.headerUserAvatar.style.backgroundImage = `url("${avatarUrl.replace(/"/g, '\\"')}")`;
                elementos.headerUserAvatar.classList.add('has-image');
                elementos.headerUserAvatar.textContent = '';
            } else {
                elementos.headerUserAvatar.style.backgroundImage = '';
                elementos.headerUserAvatar.classList.remove('has-image');
                elementos.headerUserAvatar.textContent = gerarIniciais(nomeLimpo);
            }
            sincronizarSelecaoAvatar();
            atualizarResponsavelMovimentacaoInfo();
        }
        function aplicarPermissoesMenu() {
            if (!elementos.menuLinks) return;
            elementos.menuLinks.forEach(link => {
                const pagina = link.dataset.page;
                const permitido = usuarioTemAcessoPagina(pagina);
                link.parentElement.style.display = permitido ? '' : 'none';
            });
            const botoesRestritos = [
                document.getElementById('btn-novo-armario'),
                document.getElementById('btn-nova-unidade'),
                document.getElementById('btn-novo-usuario')
            ];
            botoesRestritos.forEach(botao => {
                if (!botao) return;
                botao.style.display = perfilAtualEhAdmin() ? '' : 'none';
            });
            if (!usuarioTemAcessoPagina(estado.paginaAtual)) {
                estado.paginaAtual = 'dashboard';
                navegarParaPagina('dashboard');
            }
        }
        const termoSteps = Array.from(document.querySelectorAll('#termo-form .wizard-step'));
        let termoPassoAtual = 0;
        let termoArmarioAtual = null;
        let termoPreCadastro = null;
        let termoCadastroArmario = null;
        let movimentacaoArmarioAtual = null;
        let movimentacaoEmProgresso = false;
        let termoAssinaturaDesenhada = false;
        let termoDesenhandoAssinatura = false;
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            atualizarOpcoesSetorTermo();
            atualizarResponsavelMovimentacaoInfo();
            inicializarLogin();
        });
        function aguardar(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function executarCarregamentoSeguro(descricao, acao) {
            try {
                const resultado = await acao();
                const sucesso = resultado !== false;
                if (!sucesso) {
                    console.warn(`Carregamento concluído sem sucesso (${descricao}).`);
                }
                return { sucesso, descricao };
            } catch (erro) {
                console.error(`Erro ao executar carregamento (${descricao}):`, erro);
                return { sucesso: false, descricao, erro };
            }
        }
        function criarErroChamadaGoogle(mensagemUsuario, detalhes) {
            const erro = new Error(detalhes || mensagemUsuario);
            erro.mensagemUsuario = mensagemUsuario;
            return erro;
        }
        // Função para chamar o Google Apps Script
        async function callGoogleScript(action, data = {}, opcoes = {}) {
            const tentativasConfiguradas = Number.isFinite(opcoes.tentativas) && opcoes.tentativas > 0
                ? Math.floor(opcoes.tentativas)
                : 3;
            const intervaloBaseConfigurado = Number.isFinite(opcoes.intervaloInicial) && opcoes.intervaloInicial > 0
                ? opcoes.intervaloInicial
                : 400;
            const entradas = [];
            Object.keys(data || {}).forEach(key => {
                const valor = data[key];
                if (valor === undefined || valor === null) {
                    entradas.push([key, '']);
                } else if (valor instanceof Date) {
                    entradas.push([key, valor.toISOString()]);
                } else if (typeof valor === 'object') {
                    try {
                        entradas.push([key, JSON.stringify(valor)]);
                    } catch (erroJSON) {
                        console.error(`Erro ao serializar campo ${key} da ação ${action}:`, erroJSON);
                        entradas.push([key, '']);
                    }
                } else {
                    entradas.push([key, valor]);
                }
            });

            let atraso = intervaloBaseConfigurado;
            const maxTentativas = Math.max(1, tentativasConfiguradas);

            for (let tentativa = 1; tentativa <= maxTentativas; tentativa++) {
                try {
                    const formData = new FormData();
                    formData.append('action', action);
                    entradas.forEach(([chave, valor]) => formData.append(chave, valor));

                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const mensagem = `Erro ${response.status} ao comunicar com o servidor (ação: ${action})`;
                        console.error(mensagem);
                        throw criarErroChamadaGoogle(mensagem, mensagem);
                    }

                    const textoResposta = await response.text();
                    if (!textoResposta) {
                        const mensagem = `Resposta vazia do servidor (ação: ${action})`;
                        console.error(mensagem);
                        throw criarErroChamadaGoogle(mensagem, mensagem);
                    }

                    try {
                        return JSON.parse(textoResposta);
                    } catch (parseError) {
                        console.error(`Falha ao interpretar a resposta da ação ${action}:`, parseError, textoResposta);
                        const mensagem = `Resposta inválida do servidor (ação: ${action})`;
                        throw criarErroChamadaGoogle(mensagem, parseError && parseError.message ? parseError.message : mensagem);
                    }
                } catch (erro) {
                    const ultimaTentativa = tentativa === maxTentativas;
                    console.error(`Erro ao chamar Google Script (ação: ${action}, tentativa ${tentativa}/${maxTentativas}):`, erro);
                    if (ultimaTentativa) {
                        const mensagemUsuario = erro && erro.mensagemUsuario ? erro.mensagemUsuario : 'Erro de conexão com o servidor';
                        mostrarErro(mensagemUsuario);
                        const mensagemDetalhada = erro && erro.message ? erro.message : mensagemUsuario;
                        return { success: false, error: mensagemDetalhada, _erroNotificado: true };
                    }
                    await aguardar(atraso);
                    atraso = Math.min(atraso * 1.8, 2000);
                }
            }

            mostrarErro('Erro de conexão com o servidor');
            return { success: false, error: 'Erro de conexão com o servidor', _erroNotificado: true };
        }
        async function inicializarAplicacao() {
            if (aplicacaoInicializada) {
                await carregarDadosIniciais();
                atualizarCabecalhoUsuario();
                aplicarPermissoesMenu();
                carregarDadosTabelas();
                persistirSessaoAtual();
                return;
            }
            aplicacaoInicializada = true;
            aprimorarSeletoresCabecalho();
            inicializarCanvasAssinatura();
            inicializarEventos();
            await carregarDadosIniciais();
            atualizarCabecalhoUsuario();
            aplicarPermissoesMenu();
            carregarDadosTabelas();
            persistirSessaoAtual();
        }
        function atualizarFeedbackLogin(tipo, mensagem = '') {
            if (!elementos.loginFeedback) {
                return;
            }
            const classes = ['is-loading', 'is-error', 'is-success'];
            elementos.loginFeedback.classList.remove(...classes);
            elementos.loginFeedback.textContent = mensagem || '';
            if (tipo && classes.includes(`is-${tipo}`)) {
                elementos.loginFeedback.classList.add(`is-${tipo}`);
            }
        }
        function inicializarLogin() {
            if (typeof loginInicializado !== 'undefined' && loginInicializado) {
                return;
            }
            loginInicializado = true;
            const sessaoRestaurada = restaurarSessaoUsuario();
            if (sessaoRestaurada && !estado.autenticado) {
                const usuarioRestaurado = {
                    ...sessaoRestaurada
                };
                usuarioRestaurado.perfil = (usuarioRestaurado.perfil || 'usuario').toString().trim().toLowerCase();
                usuarioRestaurado.unidades = normalizarListaDeUnidades(usuarioRestaurado.unidades);
                estado.usuarioAutenticado = usuarioRestaurado;
                estado.autenticado = true;
                persistirSessaoAtual();
                if (elementos.loginContainer) {
                    elementos.loginContainer.classList.add('hidden');
                }
                if (elementos.appShell) {
                    elementos.appShell.classList.remove('hidden');
                }
                atualizarCabecalhoUsuario();
                aplicarPermissoesMenu();
                inicializarAplicacao().catch(erro => {
                    console.error('Erro ao inicializar aplicação após restaurar sessão:', erro);
                });
            }
            if (!elementos.loginForm) {
                return;
            }
            elementos.loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const usuarioLogin = elementos.loginUsuario?.value.trim();
                const senha = elementos.loginSenha?.value.trim();
                atualizarFeedbackLogin();
                if (!usuarioLogin || !senha) {
                    atualizarFeedbackLogin('error', 'Informe usuário e senha.');
                    return;
                }
                const finalizarLoading = iniciarLoadingBotao(elementos.loginSubmit);
                atualizarFeedbackLogin('loading', 'Validando credenciais...');
                try {
                    const resultado = await callGoogleScript('autenticarUsuario', { usuario: usuarioLogin, matricula: usuarioLogin, senha });
                    if (!resultado.success) {
                        atualizarFeedbackLogin('error', resultado.error || 'Credenciais inválidas.');
                        return;
                    }
                    const usuarioAutenticado = resultado.usuario || {};
                    usuarioAutenticado.perfil = (usuarioAutenticado.perfil || 'usuario').toString().trim().toLowerCase();
                    usuarioAutenticado.unidades = normalizarListaDeUnidades(usuarioAutenticado.unidades);
                    estado.usuarioAutenticado = usuarioAutenticado;
                    estado.autenticado = true;
                    persistirSessaoAtual();
                    elementos.loginSenha.value = '';
                    atualizarFeedbackLogin('success', 'Login realizado com sucesso!');
                    if (elementos.loginContainer) {
                        elementos.loginContainer.classList.add('hidden');
                    }
                    if (elementos.appShell) {
                        elementos.appShell.classList.remove('hidden');
                    }
                    atualizarCabecalhoUsuario();
                    aplicarPermissoesMenu();
                    await inicializarAplicacao();
                } catch (error) {
                    console.error('Erro ao autenticar usuário:', error);
                    atualizarFeedbackLogin('error', 'Não foi possível realizar o login. Tente novamente.');
                } finally {
                    finalizarLoading();
                }
            });
        }
        function realizarLogout() {
            estado = criarEstadoInicial();
            aplicacaoInicializada = false;
            limparSessaoUsuario();
            atualizarFeedbackLogin();
            atualizarCabecalhoUsuario();
            atualizarOpcoesSetorTermo();
            if (elementos.loginUsuario) {
                elementos.loginUsuario.value = '';
            }
            if (elementos.loginSenha) {
                elementos.loginSenha.value = '';
            }
            if (elementos.loginContainer) {
                elementos.loginContainer.classList.remove('hidden');
            }
            if (elementos.appShell) {
                elementos.appShell.classList.add('hidden');
            }
            if (elementos.notificationPanel) {
                elementos.notificationPanel.style.display = 'none';
            }
            if (elementos.notificationBadge) {
                elementos.notificationBadge.textContent = '0';
            }
            if (elementos.profileSelect) {
                elementos.profileSelect.value = 'geral';
                atualizarSelectorPersonalizado(elementos.profileSelect);
            }
            if (elementos.unitSelect) {
                elementos.unitSelect.value = 'todas';
                atualizarSelectorPersonalizado(elementos.unitSelect);
            }
            if (elementos.filterBtns) {
                elementos.filterBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === 'todos');
                });
            }
            if (elementos.menuLinks) {
                elementos.menuLinks.forEach(link => link.classList.remove('active'));
            }
            const dashboardLink = document.querySelector('.sidebar-menu a[data-page="dashboard"]');
            if (dashboardLink) {
                dashboardLink.classList.add('active');
            }
            if (elementos.pages) {
                elementos.pages.forEach(page => page.classList.remove('active'));
            }
            const dashboardPage = document.getElementById('dashboard');
            if (dashboardPage) {
                dashboardPage.classList.add('active');
            }
            const headerTitle = document.querySelector('.header-title h1');
            if (headerTitle) {
                headerTitle.textContent = 'Dashboard';
            }
            termoPassoAtual = 0;
            termoArmarioAtual = null;
            movimentacaoArmarioAtual = null;
            termoAssinaturaDesenhada = false;
            termoDesenhandoAssinatura = false;
            fecharModalArmario();
            fecharModalUsuario();
            fecharTermoModal();
            fecharMovimentacaoModal();
            fecharModalAvatar({ focusTrigger: false });
        }
        async function carregarDadosIniciais() {
            if (!estado.autenticado) {
                return;
            }
            try {
                const resultado = await callGoogleScript('verificarInicializacao');
                if (!resultado.success || !resultado.inicializado) {
                    await callGoogleScript('inicializarPlanilha');
                }

                const carregamentoUnidades = await executarCarregamentoSeguro('carregar unidades', carregarUnidades);
                const carregamentoSetores = await executarCarregamentoSeguro('carregar setores', carregarSetores);
                const demaisCarregamentos = await Promise.all([
                    executarCarregamentoSeguro('carregar armários', () => carregarArmarios({ forcarAtualizacao: true })),
                    executarCarregamentoSeguro('carregar usuários', carregarUsuarios),
                    executarCarregamentoSeguro('carregar estatísticas', carregarEstatisticas),
                    executarCarregamentoSeguro('carregar notificações', carregarNotificacoes)
                ]);

                const resultados = [carregamentoUnidades, carregamentoSetores, ...demaisCarregamentos];
                const houveSucesso = resultados.some(item => item.sucesso);

                if (!houveSucesso) {
                    mostrarErro('Erro ao carregar dados do sistema');
                    return;
                }

                const falhasParciais = resultados.filter(item => !item.sucesso);
                if (falhasParciais.length) {
                    console.warn('Falha ao carregar parte dos dados:', falhasParciais.map(item => item.descricao));
                }

                atualizarInterface();
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                mostrarErro('Erro ao carregar dados do sistema');
            }
        }
        async function carregarArmarios({ forcarAtualizacao = false } = {}) {
            if (!estado.autenticado) {
                return false;
            }
            if (!forcarAtualizacao && estado.armariosCarregados) {
                return true;
            }

            const resultado = await callGoogleScript('getArmarios', {
                tipo: 'todos'
            });

            if (resultado.success) {
                const armariosProcessados = (resultado.data || []).map(armario => ({
                    ...armario,
                    id: normalizarIdentificador(armario.id),
                    idPlanilha: armario.idPlanilha !== undefined && armario.idPlanilha !== null
                        ? armario.idPlanilha.toString().trim()
                        : '',
                    numero: normalizarIdentificador(armario.numero),
                    unidade: armario.unidade ? armario.unidade.trim() : ''
                }));
                estado.armarios = filtrarListaPorPermissao(armariosProcessados, item => item.unidade);
                estado.armariosCarregados = true;
                atualizarResumoDashboardLocal();
                return true;
            }

            estado.armariosCarregados = false;
            return false;
        }
        async function carregarUnidades() {
            if (!estado.autenticado) {
                return false;
            }
            const resultado = await callGoogleScript('getUnidades');
            if (resultado.success) {
                estado.unidades = resultado.data.map(unidade => ({
                    ...unidade,
                    nome: unidade.nome ? unidade.nome.trim() : ''
                }));
                atualizarSeletoresUnidade();
                if (estado.unidadeAtual !== 'todas' && !usuarioPodeVerUnidade(estado.unidadeAtual)) {
                    estado.unidadeAtual = 'todas';
                }
                return true;
            }
            return false;
        }
        async function carregarSetores() {
            if (!estado.autenticado) {
                estado.setores = [];
                atualizarOpcoesSetorTermo();
                return true;
            }
            const resultado = await callGoogleScript('getSetores');
            if (resultado.success) {
                const setores = normalizarListaSetores(resultado.data);
                estado.setores = setores;
                atualizarOpcoesSetorTermo(setores);
                return true;
            }
            return false;
        }
        async function carregarUsuarios() {
            if (!estado.autenticado || !perfilAtualEhAdmin()) {
                estado.usuarios = [];
                return true;
            }
            const resultado = await callGoogleScript('getUsuarios');
            if (resultado.success) {
                estado.usuarios = (resultado.data || []).map(usuario => ({
                    ...usuario,
                    unidades: normalizarListaDeUnidades(usuario.unidades)
                }));
                return true;
            }
            return false;
        }
        async function carregarEstatisticas() {
            atualizarResumoDashboardLocal();
            return true;
        }
        async function carregarNotificacoes() {
            if (!estado.autenticado) {
                estado.notificacoes = [];
                return true;
            }
            const resultado = await callGoogleScript('getNotificacoes');
            if (resultado.success) {
                estado.notificacoes = resultado.data;
                if (elementos.notificationBadge) {
                    elementos.notificationBadge.textContent = estado.notificacoes.length;
                }
                atualizarPainelNotificacoes();
                return true;
            }
            return false;
        }
        function sincronizarDadosArmariosEmSegundoPlano({
            recarregarArmarios = true,
            recarregarEstatisticas = true,
            recarregarTabelas = true,
            recarregarArmariosNasTabelas = true
        } = {}) {
            const tarefas = [];
            if (recarregarArmarios) {
                tarefas.push(carregarArmarios({ forcarAtualizacao: true }));
            }
            if (recarregarEstatisticas) {
                tarefas.push(carregarEstatisticas());
            }
            Promise.allSettled(tarefas)
                .then(() => {
                    if (recarregarTabelas) {
                        return carregarDadosTabelas({ recarregarArmarios: recarregarArmariosNasTabelas });
                    }
                    return null;
                })
                .catch(erro => {
                    console.error('Erro na sincronização em segundo plano:', erro);
                })
                .finally(() => {
                    atualizarResumoDashboardLocal();
                    atualizarInterface();
                });
        }
        function aguardarProximoFrame() {
            return new Promise(resolve => {
                if (typeof requestAnimationFrame === 'function') {
                    requestAnimationFrame(() => resolve());
                } else {
                    setTimeout(resolve, 16);
                }
            });
        }
        function restaurarDesenhoCanvas(canvas, dataUrl) {
            if (!canvas || !dataUrl) return;
            const ctx = canvas.getContext('2d');
            const imagem = new Image();
            imagem.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(imagem, 0, 0, canvas.width, canvas.height);
            };
            imagem.src = dataUrl.startsWith('data:') ? dataUrl : `data:image/png;base64,${dataUrl}`;
        }
        function inicializarCanvasAssinatura() {
            if (elementos.termoAssinaturaCanvas) {
                const assinaturaTermoExistente = termoAssinaturaDesenhada
                    ? elementos.termoAssinaturaCanvas.toDataURL('image/png')
                    : null;
                const rectTermo = elementos.termoAssinaturaCanvas.getBoundingClientRect();
                if (rectTermo.width && rectTermo.height) {
                    elementos.termoAssinaturaCanvas.width = rectTermo.width;
                    elementos.termoAssinaturaCanvas.height = rectTermo.height;
                }
                const ctxTermo = elementos.termoAssinaturaCanvas.getContext('2d');
                ctxTermo.lineWidth = 2;
                ctxTermo.lineCap = 'round';
                ctxTermo.lineJoin = 'round';
                ctxTermo.strokeStyle = '#0b1324';
                if (assinaturaTermoExistente) {
                    restaurarDesenhoCanvas(elementos.termoAssinaturaCanvas, assinaturaTermoExistente);
                }
            }
        }
        function debounce(fn, delay = 200) {
            let timeoutId;
            return function(...args) {
                const contexto = this;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(contexto, args), delay);
            };
        }
        function iniciarLoadingBotao(botao) {
            if (!botao) return () => {};
            const inicio = Date.now();
            const duracaoMinima = 180;
            botao.classList.add('btn-loading');
            botao.disabled = true;
            return () => {
                const encerrar = () => {
                    botao.classList.remove('btn-loading');
                    botao.disabled = false;
                };
                const decorrido = Date.now() - inicio;
                if (decorrido < duracaoMinima) {
                    setTimeout(encerrar, duracaoMinima - decorrido);
                } else {
                    encerrar();
                }
            };
        }
        function mostrarOverlayCarregamento(mensagem = 'Processando...') {
            if (!elementos.globalLoadingOverlay || !elementos.globalLoadingText) {
                return () => {};
            }
            const overlay = elementos.globalLoadingOverlay;
            const texto = elementos.globalLoadingText;
            texto.textContent = mensagem;
            overlay.classList.add('is-active');
            overlay.setAttribute('aria-hidden', 'false');
            const inicio = Date.now();
            return () => {
                const encerrar = () => {
                    overlay.classList.remove('is-active');
                    overlay.setAttribute('aria-hidden', 'true');
                };
                const decorrido = Date.now() - inicio;
                if (decorrido < 150) {
                    setTimeout(encerrar, 150 - decorrido);
                } else {
                    encerrar();
                }
            };
        }
        async function atualizarDadosPosOperacao(mensagemCarregamento = 'Atualizando informações...', posAtualizacaoLocal) {
            const finalizarOverlay = mostrarOverlayCarregamento(mensagemCarregamento);
            try {
                const [resultadoArmarios, resultadoEstatisticas] = await Promise.allSettled([
                    carregarArmarios({ forcarAtualizacao: true }),
                    carregarEstatisticas()
                ]);

                if (resultadoArmarios.status === 'rejected') {
                    console.error('Erro ao recarregar armários após operação:', resultadoArmarios.reason);
                } else if (resultadoArmarios.status === 'fulfilled' && resultadoArmarios.value === false) {
                    console.warn('Recarregamento de armários não pôde ser concluído após a operação.');
                }

                if (resultadoEstatisticas.status === 'rejected') {
                    console.error('Erro ao atualizar estatísticas após operação:', resultadoEstatisticas.reason);
                }

                if (typeof posAtualizacaoLocal === 'function') {
                    try {
                        posAtualizacaoLocal({ resultadoArmarios, resultadoEstatisticas });
                    } catch (erroAtualizacaoLocal) {
                        console.error('Erro ao aplicar atualização local pós-operação:', erroAtualizacaoLocal);
                    }
                }

                atualizarInterface();
                try {
                    await carregarDadosTabelas();
                } catch (erroCarregarTabelas) {
                    console.error('Erro ao recarregar dados das tabelas após operação:', erroCarregarTabelas);
                }
            } finally {
                finalizarOverlay();
            }
        }
        function configurarBotaoAcao(botao, acao) {
            if (!botao) return;
            botao.addEventListener('click', async (event) => {
                const finalizar = iniciarLoadingBotao(event.currentTarget);
                try {
                    await acao();
                } finally {
                    finalizar();
                }
            });
        }
        function mostrarErro(mensagem) {
            Swal.fire({
                title: 'Erro',
                text: mensagem,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
        function mostrarSucesso(mensagem) {
            Swal.fire({
                title: 'Sucesso!',
                text: mensagem,
                icon: 'success',
                confirmButtonText: 'OK'
            });
        }
        function notificarErroPadrao(resultado, mensagemPadrao = 'Ocorreu um erro inesperado') {
            if (!resultado || resultado._erroNotificado) {
                return;
            }
            const mensagem = resultado.error || mensagemPadrao;
            mostrarErro(mensagem);
        }
        function calcularHoraPrevistaSaida() {
            const agora = new Date();
            agora.setHours(agora.getHours() + 1);
            const horas = String(agora.getHours()).padStart(2, '0');
            const minutos = String(agora.getMinutes()).padStart(2, '0');
            return `${horas}:${minutos}`;
        }
        // Configuração de eventos
        function inicializarEventos() {
            if (eventosInicializados) {
                return;
            }
            eventosInicializados = true;
            // Seletor de perfil
            if (elementos.profileSelect) {
                elementos.profileSelect.addEventListener('change', async function() {
                    estado.perfilAtual = this.value;
                    await carregarArmarios();
                    atualizarResumoDashboardLocal();
                    atualizarInterface();
                    carregarDadosTabelas();
                });
            }
            if (elementos.unitSelect) {
                elementos.unitSelect.addEventListener('change', async function() {
                    estado.unidadeAtual = this.value;
                    await carregarArmarios();
                    atualizarResumoDashboardLocal();
                    atualizarInterface();
                    carregarDadosTabelas();
                });
            }
            // Notificações
            if (elementos.notificationBell) {
                elementos.notificationBell.addEventListener('click', function() {
                    elementos.notificationPanel.style.display =
                        elementos.notificationPanel.style.display === 'block' ? 'none' : 'block';
                });
            }
            if (elementos.headerUserProfile) {
                elementos.headerUserProfile.addEventListener('click', () => {
                    if (avatarModalAberto()) {
                        fecharModalAvatar({ focusTrigger: false });
                    } else {
                        abrirModalAvatar();
                    }
                });
                elementos.headerUserProfile.addEventListener('keydown', event => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        abrirModalAvatar();
                    }
                });
            }
            if (elementos.avatarModalClose) {
                elementos.avatarModalClose.addEventListener('click', () => fecharModalAvatar());
            }
            if (elementos.avatarModalBackdrop) {
                elementos.avatarModalBackdrop.addEventListener('click', event => {
                    if (event.target === elementos.avatarModalBackdrop) {
                        fecharModalAvatar();
                    }
                });
            }
            if (elementos.avatarOptions) {
                elementos.avatarOptions.addEventListener('click', event => {
                    const botao = event.target.closest('.avatar-option');
                    if (!botao) {
                        return;
                    }
                    event.preventDefault();
                    aplicarAvatarUsuario(botao.dataset.avatarUrl || '');
                });
                elementos.avatarOptions.addEventListener('keydown', event => {
                    if (event.key !== 'Enter' && event.key !== ' ') {
                        return;
                    }
                    const botao = event.target.closest('.avatar-option');
                    if (!botao) {
                        return;
                    }
                    event.preventDefault();
                    aplicarAvatarUsuario(botao.dataset.avatarUrl || '');
                });
            }
            if (elementos.avatarUrlApply) {
                elementos.avatarUrlApply.addEventListener('click', aplicarAvatarPersonalizado);
            }
            if (elementos.avatarUrlInput) {
                elementos.avatarUrlInput.addEventListener('keydown', event => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        aplicarAvatarPersonalizado();
                    }
                });
                elementos.avatarUrlInput.addEventListener('input', () => {
                    elementos.avatarUrlInput.classList.remove('invalid');
                    elementos.avatarUrlInput.removeAttribute('aria-invalid');
                });
            }
            // Fechar modais
            elementos.modalClose.addEventListener('click', fecharModalArmario);
            elementos.usuarioModalClose.addEventListener('click', fecharModalUsuario);
            elementos.btnCancelar.addEventListener('click', fecharModalArmario);
            elementos.usuarioBtnCancelar.addEventListener('click', fecharModalUsuario);
            // Filtros
            elementos.filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    elementos.filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    estado.filtroAtual = this.dataset.filter;
                    renderizarArmarios();
                });
            });
            // Formulários
            elementos.armarioForm.addEventListener('submit', function(e) {
                e.preventDefault();
                salvarArmario();
            });
            elementos.usuarioForm.addEventListener('submit', function(e) {
                e.preventDefault();
                salvarUsuario();
            });
            // Navegação do menu
            elementos.menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.dataset.page;
                    if (!targetPage) {
                        return;
                    }
                    navegarParaPagina(targetPage);
                });
            });
            if (elementos.logoutButton) {
                elementos.logoutButton.addEventListener('click', realizarLogout);
            }
            // Botões de ação
            configurarBotaoAcao(document.getElementById('btn-novo-visitante'), () => abrirModalNovoArmario('visitante'));
            configurarBotaoAcao(document.getElementById('btn-novo-acompanhante'), () => abrirModalNovoArmario('acompanhante'));
            configurarBotaoAcao(document.getElementById('btn-novo-armario'), () => abrirModalNovoArmarioFisico());
            configurarBotaoAcao(document.getElementById('btn-novo-usuario'), () => abrirModalNovoUsuario());
            configurarBotaoAcao(elementos.btnNovaUnidade, () => abrirModalNovaUnidade());
            // Termo de responsabilidade
            elementos.termoBtnVoltar.addEventListener('click', () => navegarPassoTermo(-1));
            elementos.termoBtnAvancar.addEventListener('click', avancarOuAplicarTermo);
            elementos.termoBtnCancelar.addEventListener('click', fecharTermoModal);
            elementos.termoModalClose.addEventListener('click', fecharTermoModal);
            if (elementos.termoAddVolume) {
                elementos.termoAddVolume.addEventListener('click', () => {
                    const novoVolume = adicionarVolumeTermo();
                    novoVolume?.querySelector('.termo-volume-qty')?.focus();
                });
            }
            if (elementos.termoVolumesList) {
                elementos.termoVolumesList.addEventListener('click', evento => {
                    const botao = evento.target.closest('.btn-remove-volume');
                    if (!botao) return;
                    const item = botao.closest('.wizard-volume-item');
                    removerVolumeTermo(item);
                });
                elementos.termoVolumesList.addEventListener('input', () => {
                    elementos.termoVolumesField?.classList.remove('invalid');
                });
            }
            if (elementos.termoAssinaturaClear) {
                elementos.termoAssinaturaClear.addEventListener('click', () => {
                    limparAssinaturaTermo();
                });
            }
            if (elementos.termoAssinaturaCanvas) {
                elementos.termoAssinaturaCanvas.addEventListener('pointerdown', iniciarAssinaturaTermo);
                elementos.termoAssinaturaCanvas.addEventListener('pointermove', desenharAssinaturaTermo);
                elementos.termoAssinaturaCanvas.addEventListener('pointerup', finalizarAssinaturaTermo);
                elementos.termoAssinaturaCanvas.addEventListener('pointerleave', finalizarAssinaturaTermo);
                elementos.termoAssinaturaCanvas.addEventListener('pointercancel', finalizarAssinaturaTermo);
            }
            window.addEventListener('resize', debounce(() => {
                inicializarCanvasAssinatura();
            }, 150));
            // Movimentações
            elementos.movimentacaoModalClose.addEventListener('click', fecharMovimentacaoModal);
            elementos.movimentacaoForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const botao = elementos.movimentacaoForm.querySelector('button[type="submit"]');
                const finalizarLoading = iniciarLoadingBotao(botao);
                try {
                    await salvarMovimentacao();
                } finally {
                    finalizarLoading();
                }
            });
            // Tabela de termos
            elementos.tabelaTermos.addEventListener('click', tratarAcaoTermo);
            if (elementos.tabelaUnidadesBody) {
                elementos.tabelaUnidadesBody.addEventListener('click', tratarAcaoUnidade);
            }
            const tabelaVisitantes = document.querySelector('#tabela-visitantes');
            if (tabelaVisitantes) {
                tabelaVisitantes.addEventListener('click', async (evento) => {
                    const alvo = evento.target.closest('[data-action]');
                    if (!alvo) return;
                    const id = extrairIdDataset(alvo);
                    if (!id) return;
                    const acao = alvo.dataset.action;
                    let finalizarLoading = () => {};
                    if (alvo.tagName === 'BUTTON') {
                        finalizarLoading = iniciarLoadingBotao(alvo);
                    }
                    try {
                        switch (acao) {
                            case 'usar':
                                usarArmario(id);
                                break;
                            case 'liberar':
                                if ((alvo.dataset.tipo || '').toLowerCase() === 'visitante') {
                                    await confirmarLiberacaoVisitante(id);
                                } else {
                                    await confirmarLiberacaoAcompanhante(id);
                                }
                                break;
                            default:
                                break;
                        }
                    } finally {
                        finalizarLoading();
                    }
                });
            }
            const tabelaAcompanhantes = document.querySelector('#tabela-acompanhantes');
            if (tabelaAcompanhantes) {
                tabelaAcompanhantes.addEventListener('click', async (evento) => {
                    const alvo = evento.target.closest('[data-action]');
                    if (!alvo) return;
                    const id = extrairIdDataset(alvo);
                    if (!id) return;
                    const acao = alvo.dataset.action;
                    let finalizarLoading = () => {};
                    if (alvo.tagName === 'BUTTON') {
                        finalizarLoading = iniciarLoadingBotao(alvo);
                    }
                    try {
                        switch (acao) {
                            case 'usar':
                                usarArmario(id);
                                break;
                            case 'liberar':
                                await confirmarLiberacaoAcompanhante(id);
                                break;
                            case 'mov':
                                await abrirMovimentacoes(id);
                                break;
                            case 'termo':
                                await abrirTermoWizard(id);
                                break;
                            default:
                                break;
                        }
                    } finally {
                        finalizarLoading();
                    }
                });
            }
            if (elementos.tabelaUsuariosBody) {
                elementos.tabelaUsuariosBody.addEventListener('click', tratarAcaoUsuario);
            }
            if (elementos.usuarioUnidades) {
                elementos.usuarioUnidades.addEventListener('change', tratarAlteracaoUnidadeUsuario);
            }
            // Fechar notificações ao clicar fora
            document.addEventListener('click', function(e) {
                if (!elementos.notificationBell.contains(e.target) &&
                    !elementos.notificationPanel.contains(e.target)) {
                    elementos.notificationPanel.style.display = 'none';
                }
            });
            document.addEventListener('keydown', event => {
                if (event.key === 'Escape' && avatarModalAberto()) {
                    fecharModalAvatar();
                }
            });
        }
        // Navegação entre páginas
        function navegarParaPagina(pagina) {
            if (!usuarioTemAcessoPagina(pagina)) {
                mostrarErro('Você não tem permissão para acessar esta área.');
                return;
            }
            // Atualizar menu ativo
            elementos.menuLinks.forEach(link => link.classList.remove('active'));
            const linkAlvo = document.querySelector(`[data-page="${pagina}"]`);
            if (!linkAlvo) {
                return;
            }
            linkAlvo.classList.add('active');

            // Atualizar página ativa
            elementos.pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pagina).classList.add('active');

            // Atualizar título
            const pageTitle = linkAlvo.querySelector('span')?.textContent || '';
            document.querySelector('.header-title h1').textContent = pageTitle;

            estado.paginaAtual = pagina;

            // Carregar dados específicos da página
            carregarDadosTabelas();
        }
        // Atualizar interface baseada no perfil
        function atualizarInterface() {
            // Renderizar armários
            if (estado.paginaAtual === 'dashboard') {
                renderizarArmarios();
            }
        }
        // Renderizar lista de armários no dashboard
        function renderizarArmarios() {
            elementos.armariosContainer.innerHTML = '';
            const perfil = estado.perfilAtual;
            const unidadeFiltro = estado.unidadeAtual;
            const perfilNormalizado = normalizarTexto(perfil);
            const unidadeFiltroNormalizado = normalizarTexto(unidadeFiltro);
            let armariosParaExibir = estado.armarios.filter(a => {
                const tipoNormalizado = normalizarTexto(a.tipo);
                const correspondePerfil = perfilNormalizado === 'geral' || perfilNormalizado === 'todos' || tipoNormalizado === perfilNormalizado;
                const correspondeUnidade = unidadeFiltroNormalizado === 'todas' ||
                    normalizarTexto(a.unidade) === unidadeFiltroNormalizado;
                return correspondePerfil && correspondeUnidade;
            });
            // Aplicar filtro
            if (estado.filtroAtual !== 'todos') {
                armariosParaExibir = armariosParaExibir.filter(a => a.status === estado.filtroAtual);
            }
            armariosParaExibir.forEach(armario => {
                const card = document.createElement('div');
                card.className = `armario-card ${armario.status}`;
                card.dataset.id = armario.id;
                let detailsHTML = '';
                if (armario.status === 'livre') {
                    detailsHTML += '<p>Disponível para uso</p>';
                } else {
                    detailsHTML += `
                        <p><strong>${armario.tipo === 'acompanhante' ? 'Acompanhante' : 'Visitante'}:</strong> ${armario.nomeVisitante}</p>
                        <p><strong>Paciente:</strong> ${armario.nomePaciente}</p>
                        <p><strong>Leito:</strong> ${armario.leito}</p>
                        <p><strong>Volumes:</strong> ${armario.volumes}</p>
                        ${armario.whatsapp ? `<p><strong>WhatsApp:</strong> ${armario.whatsapp}</p>` : ''}
                        <p><strong>Início:</strong> ${armario.horaInicio}</p>
                        ${armario.horaPrevista ? `<p><strong>Previsão:</strong> ${armario.horaPrevista}</p>` : ''}
                        ${armario.tipo === 'acompanhante' ? `<p><strong>Termo:</strong> ${formatarStatusTermo(armario.termoStatus)}</p>` : ''}
                    `;
                }
                card.innerHTML = `
                    <div class="armario-header">
                        <div class="armario-number">${armario.numero}</div>
                        <div class="armario-status status-${armario.status}">
                            ${armario.status === 'livre' ? 'Livre' :
                              armario.status === 'em-uso' ? 'Em uso' :
                              armario.status === 'proximo' ? 'Próximo' : 'Vencido'}
                        </div>
                    </div>
                    <div class="armario-details">
                        ${detailsHTML}
                    </div>
                `;
                card.addEventListener('click', () => abrirModalArmario(armario));
                elementos.armariosContainer.appendChild(card);
            });
        }

        function atualizarResumoDashboardLocal() {
            const totais = {
                livres: 0,
                emUso: 0,
                proximo: 0,
                vencidos: 0
            };

            const perfilFiltro = normalizarTexto(estado.perfilAtual);
            const unidadeFiltro = normalizarTexto(estado.unidadeAtual);

            estado.armarios.forEach(armario => {
                const tipoNormalizado = normalizarTexto(armario.tipo);
                const unidadeNormalizada = normalizarTexto(armario.unidade);

                if (perfilFiltro !== 'geral' && perfilFiltro !== 'todos' && tipoNormalizado !== perfilFiltro) {
                    return;
                }

                if (unidadeFiltro !== 'todas' && unidadeNormalizada !== unidadeFiltro) {
                    return;
                }

                switch (armario.status) {
                    case 'livre':
                        totais.livres += 1;
                        break;
                    case 'em-uso':
                        totais.emUso += 1;
                        break;
                    case 'proximo':
                        totais.proximo += 1;
                        break;
                    case 'vencido':
                        totais.vencidos += 1;
                        break;
                    default:
                        break;
                }
            });

            elementos.cardsCount.livres.textContent = totais.livres;
            elementos.cardsCount.emUso.textContent = totais.emUso;
            elementos.cardsCount.proximo.textContent = totais.proximo;
            elementos.cardsCount.vencidos.textContent = totais.vencidos;
        }

        function atualizarArmarioLocal(id, atualizacoes) {
            const indice = estado.armarios.findIndex(armario => armario.id === id);
            if (indice === -1) {
                return null;
            }

            const armarioAtualizado = {
                ...estado.armarios[indice],
                ...atualizacoes
            };

            estado.armarios[indice] = armarioAtualizado;
            return armarioAtualizado;
        }

        function garantirArmarioLiberadoLocal(id, metodo, confirmacao) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                return false;
            }

            const atualizacoes = {};
            let precisaAtualizar = false;
            const statusNormalizado = normalizarTexto(armario.status);
            const tipoNormalizado = normalizarTexto(armario.tipo);
            const termoStatusNormalizado = normalizarTexto(armario.termoStatus);

            if (statusNormalizado !== 'livre') {
                Object.assign(atualizacoes, {
                    status: 'livre',
                    nomeVisitante: '',
                    nomePaciente: '',
                    leito: '',
                    volumes: '',
                    whatsapp: '',
                    horaInicio: '',
                    horaPrevista: ''
                });
                precisaAtualizar = true;
            }

            if (tipoNormalizado === 'acompanhante') {
                if (!armario.termoFinalizado) {
                    atualizacoes.termoFinalizado = true;
                    precisaAtualizar = true;
                }
                if (armario.termoAplicado) {
                    atualizacoes.termoAplicado = false;
                    precisaAtualizar = true;
                }
                if (termoStatusNormalizado !== 'finalizado') {
                    atualizacoes.termoStatus = 'finalizado';
                    precisaAtualizar = true;
                }

                const termoAtualizado = { ...(armario.termoInfo || {}) };
                let atualizouTermo = false;

                if (!termoAtualizado.finalizadoEm) {
                    termoAtualizado.finalizadoEm = new Date().toISOString();
                    atualizouTermo = true;
                }

                if (metodo && termoAtualizado.metodoFinal !== metodo) {
                    termoAtualizado.metodoFinal = metodo;
                    atualizouTermo = true;
                }

                if (metodo === 'cpf' && confirmacao && termoAtualizado.cpfConfirmacao !== confirmacao) {
                    termoAtualizado.cpfConfirmacao = confirmacao;
                    atualizouTermo = true;
                }

                if (normalizarTexto(termoAtualizado.status) !== 'finalizado') {
                    termoAtualizado.status = 'Finalizado';
                    atualizouTermo = true;
                }

                if (!armario.termoInfo || atualizouTermo) {
                    atualizacoes.termoInfo = termoAtualizado;
                    precisaAtualizar = true;
                }
            }

            if (!precisaAtualizar) {
                return false;
            }

            return Boolean(atualizarArmarioLocal(id, atualizacoes));
        }
        // Carregar dados nas tabelas
        async function carregarDadosTabelas(opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            const unidadeFiltro = estado.unidadeAtual;
            try {
                // Carregar dados específicos da página atual
                switch(estado.paginaAtual) {
                    case 'visitantes':
                        await carregarTabelaVisitantes(unidadeFiltro, { recarregarArmarios });
                        break;
                    case 'acompanhantes':
                        await carregarTabelaAcompanhantes(unidadeFiltro, { recarregarArmarios });
                        break;
                    case 'historico-visitantes':
                        await carregarHistoricoVisitantes();
                        break;
                    case 'historico-acompanhantes':
                        await carregarHistoricoAcompanhantes();
                        break;
                    case 'termo-responsabilidade':
                        await carregarTabelaTermos({ recarregarArmarios });
                        break;
                    case 'cadastro-armarios':
                        await carregarCadastroArmarios(unidadeFiltro);
                        break;
                    case 'cadastro-unidades':
                        renderizarTabelaUnidades();
                        break;
                    case 'usuarios':
                        await carregarTabelaUsuarios();
                        break;
                    case 'logs':
                        await carregarTabelaLogs();
                        break;
                }
            } catch (error) {
                console.error('Erro ao carregar dados da tabela:', error);
                mostrarErro('Erro ao carregar dados');
            }
        }
        async function carregarTabelaVisitantes(unidadeFiltro, opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            const tbodyVisitantes = document.querySelector('#tabela-visitantes tbody');
            if (!tbodyVisitantes) return;
            if (recarregarArmarios || !estado.armariosCarregados) {
                await carregarArmarios();
            }
            tbodyVisitantes.innerHTML = '';
            const filtroNormalizado = normalizarTexto(unidadeFiltro);
            const armariosVisitantes = estado.armarios
                .filter(armario => normalizarTexto(armario.tipo) === 'visitante')
                .filter(a => filtroNormalizado === 'todas' || normalizarTexto(a.unidade) === filtroNormalizado)
                .filter(a => usuarioPodeVerUnidade(a.unidade));
            if (!armariosVisitantes.length) {
                tbodyVisitantes.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum armário encontrado.</td></tr>';
                return;
            }
            armariosVisitantes.forEach(armario => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${armario.numero}</td>
                    <td>${armario.unidade || '-'}</td>
                    <td><span class="armario-status status-${armario.status}">${formatarStatusArmario(armario.status)}</span></td>
                    <td>${armario.nomeVisitante || '-'}</td>
                    <td>${armario.nomePaciente || '-'}</td>
                    <td>${armario.leito || '-'}</td>
                    <td>${armario.volumes || '-'}</td>
                    <td>${armario.horaInicio || '-'}</td>
                    <td>${armario.horaPrevista || '-'}</td>
                    <td>${armario.whatsapp || '-'}</td>
                    <td>
                        ${armario.status !== 'livre'
                            ? `<button class="btn-small btn-danger" data-action="liberar" data-id="${armario.id}" data-tipo="visitante">Liberar</button>`
                            : `<button class="btn-small btn-primary" data-action="usar" data-id="${armario.id}">Usar</button>`
                        }
                    </td>
                `;
                tbodyVisitantes.appendChild(tr);
            });
        }
        async function carregarTabelaAcompanhantes(unidadeFiltro, opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            const tbodyAcompanhantes = document.querySelector('#tabela-acompanhantes tbody');
            if (!tbodyAcompanhantes) return;
            if (recarregarArmarios || !estado.armariosCarregados) {
                await carregarArmarios();
            }
            tbodyAcompanhantes.innerHTML = '';
            const filtroNormalizado = normalizarTexto(unidadeFiltro);
            const armariosAcompanhantes = estado.armarios
                .filter(armario => normalizarTexto(armario.tipo) === 'acompanhante')
                .filter(a => filtroNormalizado === 'todas' || normalizarTexto(a.unidade) === filtroNormalizado)
                .filter(a => usuarioPodeVerUnidade(a.unidade));
            if (!armariosAcompanhantes.length) {
                tbodyAcompanhantes.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum armário encontrado.</td></tr>';
                return;
            }
            armariosAcompanhantes.forEach(armario => {
                const tr = document.createElement('tr');
                const statusArmarioNormalizado = normalizarTexto(armario.status);
                const statusTermoNormalizado = normalizarTexto(armario.termoStatus);
                const botoesTermo = statusArmarioNormalizado !== 'livre'
                    ? (statusTermoNormalizado === 'pendente'
                        ? `<button class="btn-small btn-primary" data-action="termo" data-id="${armario.id}">Aplicar termo</button>`
                        : '')
                    : '';
                tr.innerHTML = `
                    <td>${armario.numero}</td>
                    <td>${armario.unidade || '-'}</td>
                    <td><span class="armario-status status-${armario.status}">${formatarStatusArmario(armario.status)}</span></td>
                    <td>${armario.nomeVisitante || '-'}</td>
                    <td>${armario.nomePaciente || '-'}</td>
                    <td>${armario.leito || '-'}</td>
                    <td>${armario.volumes || '-'}</td>
                    <td>${armario.horaInicio || '-'}</td>
                    <td>${armario.whatsapp || '-'}</td>
                    <td>
                        ${statusArmarioNormalizado !== 'livre'
                            ? `<button class="btn-small btn-danger" data-action="liberar" data-id="${armario.id}" data-tipo="acompanhante">Liberar</button>
                               <button class="btn-small btn-edit" data-action="mov" data-id="${armario.id}">Movimentações</button>
                               ${botoesTermo}`
                            : `<button class="btn-small btn-primary" data-action="usar" data-id="${armario.id}">Usar</button>`
                        }
                    </td>
                `;
                tbodyAcompanhantes.appendChild(tr);
            });
        }
        async function carregarHistoricoVisitantes() {
            const tbody = document.querySelector('#tabela-historico-visitantes tbody');
            if (!tbody) return;
            const resultado = await callGoogleScript('getHistorico', { tipo: 'visitante' });
            if (!resultado.success) return;
            tbody.innerHTML = '';
            const registros = (resultado.data || []).filter(item => usuarioPodeVerUnidade(item.unidade));
            if (!registros.length) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum registro encontrado.</td></tr>';
                return;
            }
            registros.forEach(historico => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarData(historico.data)}</td>
                    <td>${historico.armario}</td>
                    <td>${historico.nome}</td>
                    <td>${historico.paciente}</td>
                    <td>${historico.leito}</td>
                    <td>${historico.volumes}</td>
                    <td>${historico.horaInicio}</td>
                    <td>${historico.horaFim}</td>
                    <td>${historico.whatsapp || '-'}</td>
                    <td>${historico.status}</td>
                    <td>${historico.usuario || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function carregarHistoricoAcompanhantes() {
            const tbody = document.querySelector('#tabela-historico-acompanhantes tbody');
            if (!tbody) return;
            const resultado = await callGoogleScript('getHistorico', { tipo: 'acompanhante' });
            if (!resultado.success) return;
            tbody.innerHTML = '';
            const registros = (resultado.data || []).filter(item => usuarioPodeVerUnidade(item.unidade));
            if (!registros.length) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum registro encontrado.</td></tr>';
                return;
            }
            registros.forEach(historico => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarData(historico.data)}</td>
                    <td>${historico.armario}</td>
                    <td>${historico.nome}</td>
                    <td>${historico.paciente}</td>
                    <td>${historico.leito}</td>
                    <td>${historico.volumes}</td>
                    <td>${historico.horaInicio}</td>
                    <td>${historico.horaFim}</td>
                    <td>${historico.whatsapp || '-'}</td>
                    <td>${historico.status}</td>
                    <td>${historico.usuario || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function carregarTabelaTermos(opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            if (!elementos.tabelaTermosBody) return;

            const carregamentoId = ++estado.carregamentoTermosId;
            const tbody = elementos.tabelaTermosBody;
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:16px; color:#5b6b86;">Carregando termos...</td></tr>';

            if (recarregarArmarios || !estado.armariosCarregados) {
                await carregarArmarios();
            }
            if (estado.carregamentoTermosId !== carregamentoId) return;

            if (!estado.armariosCarregados) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:16px; color:#c0392b;">Erro ao carregar termos.</td></tr>';
                return;
            }

            const armariosComTermo = estado.armarios
                .filter(a => normalizarTexto(a.tipo) === 'acompanhante')
                .filter(a => {
                    const statusArmario = normalizarTexto(a.status);
                    const statusTermo = normalizarTexto(a.termoStatus);
                    return statusArmario !== 'livre' || statusTermo === 'finalizado';
                })
                .sort((a, b) => {
                    const peso = (valor) => {
                        if (!valor.termoInfo) return 0;
                        return valor.termoStatus === 'finalizado' ? 2 : 1;
                    };
                    const pesoA = peso(a);
                    const pesoB = peso(b);
                    if (pesoA === pesoB) {
                        return new Date(b.dataRegistro || 0) - new Date(a.dataRegistro || 0);
                    }
                    return pesoA - pesoB;
                });

            if (!armariosComTermo.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:16px; color:#5b6b86;">Nenhum termo ativo ou pendente no momento.</td></tr>';
                return;
            }

            const linhas = [];

            for (const armario of armariosComTermo) {
                const termoInfo = armario.termoInfo || null;
                const statusTermoNormalizado = normalizarTexto(armario.termoStatus);
                const finalizado = statusTermoNormalizado === 'finalizado';
                const emAndamento = statusTermoNormalizado === 'em andamento';
                const movResultado = await callGoogleScript('getMovimentacoes', montarPayloadTermo(armario));
                if (estado.carregamentoTermosId !== carregamentoId) return;

                const numMovimentacoes = movResultado.success ? movResultado.data.length : 0;
                const aplicadoEm = finalizado
                    ? formatarData(termoInfo?.finalizadoEm || termoInfo?.aplicadoEm)
                    : termoInfo?.aplicadoEm ? formatarData(termoInfo.aplicadoEm) : '-';
                const statusClasse = finalizado ? 'aplicado' : emAndamento ? 'andamento' : 'pendente';
                const statusTexto = finalizado ? 'Finalizado' : emAndamento ? 'Em andamento' : 'Pendente';
                const pdfDisponivel = finalizado && termoInfo?.pdfUrl;
                const pdfColuna = pdfDisponivel
                    ? `<a href="#" class="btn-small btn-primary" data-action="ver-pdf" data-id="${armario.id}">Ver PDF</a>`
                    : '<span class="text-muted">Indisponível</span>';
                const botoesAcao = finalizado
                    ? `
                        <button class="btn-small btn-primary" data-action="ver" data-id="${armario.id}">Ver termo</button>
                        <button class="btn-small btn-edit" data-action="mov" data-id="${armario.id}">Movimentações</button>
                    `
                    : emAndamento
                        ? `
                        <button class="btn-small btn-primary" data-action="ver" data-id="${armario.id}">Ver termo</button>
                        <button class="btn-small btn-edit" data-action="mov" data-id="${armario.id}">Movimentações</button>
                        <button class="btn-small btn-danger" data-action="encerrar" data-id="${armario.id}">Encerrar</button>
                    `
                        : `
                        <button class="btn-small btn-primary" data-action="aplicar" data-id="${armario.id}">Aplicar termo</button>
                        <button class="btn-small btn-edit" data-action="mov" data-id="${armario.id}">Movimentações</button>
                        <button class="btn-small btn-danger" data-action="encerrar" data-id="${armario.id}">Encerrar</button>
                    `;

                linhas.push(`
                    <tr>
                        <td>${armario.numero}</td>
                        <td>${armario.nomeVisitante || '-'}</td>
                        <td>${armario.nomePaciente || '-'}</td>
                        <td><span class="status-label ${statusClasse}">${statusTexto}</span></td>
                        <td>${aplicadoEm}</td>
                        <td>${numMovimentacoes} registro(s)</td>
                        <td>${pdfColuna}</td>
                        <td>${botoesAcao}</td>
                    </tr>
                `);
            }

            if (estado.carregamentoTermosId !== carregamentoId) return;
            tbody.innerHTML = linhas.join('');
        }

        async function carregarCadastroArmarios(unidadeFiltro) {
            const tbody = document.querySelector('#tabela-cadastro-armarios tbody');
            if (!tbody) return;
            const resultado = await callGoogleScript('getCadastroArmarios');
            if (!resultado.success) return;
            tbody.innerHTML = '';
            const filtroNormalizado = normalizarTexto(unidadeFiltro);
            estado.cadastroArmarios = resultado.data.map(armario => ({
                ...armario,
                unidade: armario.unidade ? armario.unidade.trim() : ''
            }));
            const armariosFiltrados = estado.cadastroArmarios
                .filter(armario => filtroNormalizado === 'todas' || normalizarTexto(armario.unidade) === filtroNormalizado)
                .filter(armario => usuarioPodeVerUnidade(armario.unidade));
            if (!armariosFiltrados.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum armário cadastrado para esta unidade.</td></tr>';
                return;
            }
            armariosFiltrados.forEach(armario => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${armario.id}</td>
                    <td>${armario.numero}</td>
                    <td>${armario.tipo === 'visitante' ? 'Visitante' : 'Acompanhante'}</td>
                    <td>${armario.unidade || '-'}</td>
                    <td>${armario.localizacao || '-'}</td>
                    <td>${armario.status}</td>
                    <td>
                        <button class="btn-small btn-edit">Editar</button>
                        <button class="btn-small btn-danger">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function carregarTabelaUsuarios() {
            const tbody = elementos.tabelaUsuariosBody;
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!perfilAtualEhAdmin()) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:12px; color:#c0392b;">Apenas administradores podem visualizar os usuários.</td></tr>';
                return;
            }
            if (!estado.usuarios.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum usuário cadastrado.</td></tr>';
                return;
            }
            estado.usuarios.forEach(usuario => {
                const tr = document.createElement('tr');
                const perfilDescricao = usuario.perfil === 'admin' ? 'Administrador' : 'Usuário';
                const unidadesDescricao = obterDescricaoUnidades(usuario.unidades);
                const statusDescricao = normalizarTexto(usuario.status) === 'ativo' ? 'Ativo' : 'Inativo';
                tr.innerHTML = `
                    <td>${usuario.id}</td>
                    <td>${usuario.nome}</td>
                    <td>${usuario.email}</td>
                    <td>${perfilDescricao}</td>
                    <td>${usuario.acessoVisitantes ? 'Sim' : 'Não'}</td>
                    <td>${usuario.acessoAcompanhantes ? 'Sim' : 'Não'}</td>
                    <td>${unidadesDescricao}</td>
                    <td>${statusDescricao}</td>
                    <td>
                        <button class="btn-small btn-edit" data-acao-usuario="editar" data-id="${usuario.id}">Editar</button>
                        <button class="btn-small btn-danger" data-acao-usuario="excluir" data-id="${usuario.id}">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function renderizarOpcoesUnidadesFormulario(selecionadas = []) {
            if (!elementos.usuarioUnidades) return;
            const selecionadasNormalizadas = normalizarListaDeUnidades(selecionadas);
            const incluiTodas = selecionadasNormalizadas.some(valor => normalizarTexto(valor) === 'all');
            const unidadesDisponiveis = estado.unidades.slice();
            if (!unidadesDisponiveis.length) {
                elementos.usuarioUnidades.innerHTML = '<span class="field-hint">Cadastre unidades antes de atribuir acessos.</span>';
                return;
            }
            const partes = [];
            if (perfilAtualEhAdmin()) {
                partes.push(`<label><input type="checkbox" value="all" ${incluiTodas ? 'checked' : ''}> Todas as unidades</label>`);
            }
            unidadesDisponiveis.forEach(unidade => {
                const id = String(unidade.id);
                const checked = !incluiTodas && selecionadasNormalizadas.includes(id) ? 'checked' : '';
                const disabled = incluiTodas ? 'disabled' : '';
                partes.push(`<label><input type="checkbox" value="${id}" ${checked} ${disabled}> ${unidade.nome}</label>`);
            });
            elementos.usuarioUnidades.innerHTML = partes.join('');
        }
        function obterUnidadesSelecionadasFormulario() {
            if (!elementos.usuarioUnidades) return [];
            const selecionados = Array.from(elementos.usuarioUnidades.querySelectorAll('input[type="checkbox"]:checked'))
                .map(input => input.value);
            if (selecionados.includes('all')) {
                return ['all'];
            }
            return selecionados;
        }
        function tratarAlteracaoUnidadeUsuario(evento) {
            const input = evento.target;
            if (!input || input.type !== 'checkbox') return;
            if (input.value === 'all') {
                const marcarTodas = input.checked;
                elementos.usuarioUnidades.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.value !== 'all') {
                        checkbox.checked = false;
                        checkbox.disabled = marcarTodas;
                    }
                });
            } else {
                const todas = elementos.usuarioUnidades.querySelector('input[type="checkbox"][value="all"]');
                if (todas && todas.checked) {
                    todas.checked = false;
                    elementos.usuarioUnidades.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        }
        function tratarAcaoUsuario(evento) {
            const botao = evento.target.closest('[data-acao-usuario]');
            if (!botao) return;
            const id = parseInt(botao.dataset.id, 10);
            if (Number.isNaN(id)) return;
            const acao = botao.dataset.acaoUsuario;
            if (acao === 'editar') {
                abrirModalEditarUsuario(id);
            } else if (acao === 'excluir') {
                confirmarExclusaoUsuario(id, botao);
            }
        }
        function abrirModalEditarUsuario(id) {
            if (!perfilAtualEhAdmin()) {
                mostrarErro('Apenas administradores podem editar usuários.');
                return;
            }
            const usuario = estado.usuarios.find(u => Number(u.id) === Number(id));
            if (!usuario) {
                mostrarErro('Usuário não encontrado.');
                return;
            }
            elementos.usuarioForm.reset();
            elementos.usuarioForm.dataset.id = String(id);
            if (elementos.usuarioModalTitle) {
                elementos.usuarioModalTitle.textContent = 'Editar Usuário';
            }
            document.getElementById('usuario-nome').value = usuario.nome || '';
            document.getElementById('usuario-email').value = usuario.email || '';
            if (elementos.usuarioSenha) {
                elementos.usuarioSenha.value = usuario.senha || '';
            }
            if (elementos.usuarioStatus) {
                elementos.usuarioStatus.value = usuario.status || 'ativo';
            }
            document.getElementById('usuario-perfil').value = usuario.perfil || 'usuario';
            document.getElementById('acesso-visitantes').checked = Boolean(usuario.acessoVisitantes);
            document.getElementById('acesso-acompanhantes').checked = Boolean(usuario.acessoAcompanhantes);
            renderizarOpcoesUnidadesFormulario(usuario.unidades);
            elementos.usuarioModal.style.display = 'flex';
        }
        async function confirmarExclusaoUsuario(id, botao) {
            if (!perfilAtualEhAdmin()) {
                mostrarErro('Apenas administradores podem excluir usuários.');
                return;
            }
            const usuario = estado.usuarios.find(u => Number(u.id) === Number(id));
            if (!usuario) {
                mostrarErro('Usuário não encontrado.');
                return;
            }
            const resultado = await Swal.fire({
                title: 'Excluir usuário',
                text: `Deseja remover ${usuario.nome}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, excluir',
                cancelButtonText: 'Cancelar'
            });
            if (!resultado.isConfirmed) {
                return;
            }
            const finalizar = botao ? iniciarLoadingBotao(botao) : () => {};
            try {
                const resposta = await callGoogleScript('excluirUsuario', { id });
                if (resposta.success) {
                    await carregarUsuarios();
                    carregarTabelaUsuarios();
                    mostrarSucesso('Usuário excluído com sucesso');
                } else {
                    notificarErroPadrao(resposta);
                }
            } finally {
                finalizar();
            }
        }
        async function carregarTabelaLogs() {
            const tbody = document.querySelector('#tabela-logs tbody');
            if (!tbody) return;
            const resultado = await callGoogleScript('getLogs');
            if (!resultado.success) return;
            tbody.innerHTML = '';
            resultado.data.forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarDataHora(log.dataHora)}</td>
                    <td>${log.usuario}</td>
                    <td>${log.acao}</td>
                    <td>${log.detalhes}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        function atualizarSeletoresUnidade() {
            if (!elementos.unitSelect) return;
            const valorAtual = (estado.unidadeAtual || 'todas').toString().trim();
            const valorAtualNormalizado = normalizarTexto(valorAtual);
            const unidadesDisponiveis = obterUnidadesPermitidas();
            const deveIncluirOpcaoTodas = perfilAtualEhAdmin() || obterIdsPermitidos() === null;
            const opcoes = unidadesDisponiveis.map(unidade => {
                const nomeLimpo = (unidade.nome || '').trim();
                const desativada = unidade.status !== 'ativa';
                const label = desativada ? `${nomeLimpo} (inativa)` : nomeLimpo;
                const descricao = desativada ? 'Unidade temporariamente indisponível' : 'Filtrar por este setor';
                return `<option value="${nomeLimpo}" ${desativada ? 'disabled' : ''} data-icon="fas fa-location-dot" data-description="${descricao}">${label}</option>`;
            }).join('');
            const opcaoTodas = `<option value="todas" data-icon="fas fa-layer-group" data-description="Visualização geral por setor">Todas as unidades</option>`;
            elementos.unitSelect.innerHTML = `${deveIncluirOpcaoTodas ? opcaoTodas : ''}${opcoes}`;
            const opcaoCorrespondente = Array.from(elementos.unitSelect.options)
                .find(option => normalizarTexto(option.value) === valorAtualNormalizado);
            if (opcaoCorrespondente) {
                elementos.unitSelect.value = opcaoCorrespondente.value;
                estado.unidadeAtual = opcaoCorrespondente.value;
            } else {
                if (!deveIncluirOpcaoTodas && unidadesDisponiveis.length) {
                    const primeiraUnidade = (unidadesDisponiveis[0].nome || '').trim();
                    elementos.unitSelect.value = primeiraUnidade;
                    estado.unidadeAtual = primeiraUnidade;
                } else {
                    elementos.unitSelect.value = 'todas';
                    estado.unidadeAtual = 'todas';
                }
            }
            atualizarSelectorPersonalizado(elementos.unitSelect);
        }
        function renderizarTabelaUnidades() {
            if (!elementos.tabelaUnidadesBody) return;
            elementos.tabelaUnidadesBody.innerHTML = '';
            estado.unidades.forEach(unidade => {
                const nomeLimpo = (unidade.nome || '').trim();
                const totalArmarios = (estado.cadastroArmarios || [])
                    .filter(armario => normalizarTexto(armario.unidade) === normalizarTexto(nomeLimpo)).length;
                const statusClasse = unidade.status === 'ativa' ? 'status-livre' : 'status-vencido';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${unidade.id}</td>
                    <td>${nomeLimpo}</td>
                    <td><span class="armario-status ${statusClasse}">${unidade.status === 'ativa' ? 'Ativa' : 'Inativa'}</span></td>
                    <td>${totalArmarios}</td>
                    <td>
                        <button class="btn-small btn-primary" data-acao-unidade="filtrar" data-unidade="${nomeLimpo}">Ver armários</button>
                        <button class="btn-small ${unidade.status === 'ativa' ? 'btn-edit' : 'btn-secondary'}" data-acao-unidade="alternar" data-unidade="${nomeLimpo}">${unidade.status === 'ativa' ? 'Desativar' : 'Ativar'}</button>
                    </td>
                `;
                elementos.tabelaUnidadesBody.appendChild(tr);
            });
        }
        function tratarAcaoUnidade(evento) {
            const botao = evento.target.closest('button[data-acao-unidade]');
            if (!botao) return;
            const unidade = botao.dataset.unidade;
            const acao = botao.dataset.acaoUnidade;
            if (acao === 'filtrar') {
                selecionarUnidade(unidade);
                navegarParaPagina('cadastro-armarios');
            } else if (acao === 'alternar') {
                alternarStatusUnidade(unidade);
            }
        }
        function selecionarUnidade(unidade) {
            const valorLimpo = (unidade || '').toString().trim();
            const alvoNormalizado = normalizarTexto(valorLimpo) || 'todas';
            estado.unidadeAtual = valorLimpo || 'todas';
            if (elementos.unitSelect) {
                const opcaoCorrespondente = Array.from(elementos.unitSelect.options)
                    .find(option => normalizarTexto(option.value) === alvoNormalizado);
                if (opcaoCorrespondente) {
                    elementos.unitSelect.value = opcaoCorrespondente.value;
                    estado.unidadeAtual = opcaoCorrespondente.value;
                } else {
                    elementos.unitSelect.value = 'todas';
                    estado.unidadeAtual = 'todas';
                }
                atualizarSelectorPersonalizado(elementos.unitSelect);
            }
            atualizarInterface();
            carregarDadosTabelas();
        }
        async function alternarStatusUnidade(nome) {
            const alvoNormalizado = normalizarTexto(nome);
            const unidade = estado.unidades.find(u => normalizarTexto(u.nome) === alvoNormalizado);
            if (!unidade) return;
            const resultado = await callGoogleScript('alternarStatusUnidade', { nome: unidade.nome });
            if (resultado.success) {
                unidade.status = unidade.status === 'ativa' ? 'inativa' : 'ativa';
                const nomeExibicao = unidade.nome;
                if (unidade.status === 'inativa' && normalizarTexto(estado.unidadeAtual) === normalizarTexto(nomeExibicao)) {
                    estado.unidadeAtual = 'todas';
                }
                atualizarSeletoresUnidade();
                renderizarTabelaUnidades();
                carregarDadosTabelas();
                atualizarInterface();
                await Swal.fire({
                    title: 'Unidade atualizada',
                    text: `A unidade ${nomeExibicao} agora está ${unidade.status === 'ativa' ? 'ativa' : 'inativa'}.`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                notificarErroPadrao(resultado);
            }
        }
        async function abrirModalNovaUnidade() {
            const { value: nomeUnidade, isConfirmed } = await Swal.fire({
                title: 'Nova Unidade',
                input: 'text',
                inputLabel: 'Nome da unidade',
                inputPlaceholder: 'Ex.: NAC Eletiva',
                showCancelButton: true,
                confirmButtonText: 'Salvar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value || !value.trim()) {
                        return 'Informe o nome da unidade';
                    }
                    return null;
                }
            });
            if (!isConfirmed || !nomeUnidade || !nomeUnidade.trim()) {
                return;
            }
            const nome = nomeUnidade.trim();
            const resultado = await callGoogleScript('cadastrarUnidade', { nome });
            if (resultado.success) {
                estado.unidades.push({
                    id: resultado.id,
                    nome,
                    status: 'ativa',
                    dataCadastro: new Date()
                });
                atualizarSeletoresUnidade();
                renderizarTabelaUnidades();
                await Swal.fire({
                    title: 'Sucesso!',
                    text: 'Unidade cadastrada com sucesso',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                notificarErroPadrao(resultado);
            }
        }
        // Abrir modal para cadastro/edição de armário
        function abrirModalArmario(armario) {
            if (armario.status === 'livre') {
                elementos.modalTitle.textContent = `Cadastrar Armário ${armario.numero}`;
                elementos.armarioForm.reset();
                elementos.nomeVisitanteLabel.textContent =
                    armario.tipo === 'visitante' ? 'Nome do Visitante' : 'Nome do Acompanhante';
                document.getElementById('nome-visitante').placeholder =
                    armario.tipo === 'visitante' ? 'Nome do visitante' : 'Nome do acompanhante';
                const exigeHoraPrevista = armario.tipo === 'visitante';
                elementos.horaPrevistaGroup.style.display = exigeHoraPrevista ? 'block' : 'none';
                elementos.horaPrevistaInput.required = exigeHoraPrevista;
                elementos.horaPrevistaInput.disabled = !exigeHoraPrevista;
                if (exigeHoraPrevista) {
                    elementos.horaPrevistaInput.value = calcularHoraPrevistaSaida();
                    elementos.horaPrevistaInput.readOnly = true;
                } else {
                    elementos.horaPrevistaInput.value = '';
                    elementos.horaPrevistaInput.readOnly = false;
                }
                const whatsappInput = document.getElementById('whatsapp-contato');
                if (whatsappInput) {
                    whatsappInput.placeholder = armario.tipo === 'visitante'
                        ? 'WhatsApp do visitante'
                        : 'WhatsApp do acompanhante';
                }
                elementos.armarioForm.dataset.modo = 'cadastro';
                elementos.armarioForm.dataset.id = armario.idPlanilha || '';
                elementos.armarioForm.dataset.idPlanilha = armario.idPlanilha || '';
                elementos.armarioForm.dataset.armarioId = armario.id;
                elementos.armarioForm.dataset.tipo = armario.tipo;
                elementos.armarioForm.dataset.numero = armario.numero;
                elementos.armarioModal.style.display = 'flex';
            } else {
                const termoStatusNormalizado = normalizarTexto(armario.termoStatus);
                const termoStatusTexto = formatarStatusTermo(armario.termoStatus);
                const termoPendente = termoStatusNormalizado === 'pendente';
                const termoEmAndamento = termoStatusNormalizado === 'em andamento';
                const termoAviso = armario.tipo === 'acompanhante'
                    ? (termoEmAndamento
                        ? '<br><small>Finalize o termo durante a liberação do armário.</small>'
                        : termoPendente
                            ? '<br><small>Preencha o termo para ocupar este armário.</small>'
                            : '')
                    : '';
                const termoHtml = armario.tipo === 'acompanhante'
                    ? `<div class="info-box" style="margin-top:12px;">Termo de responsabilidade: <strong>${termoStatusTexto}</strong>${termoAviso}</div>`
                    : '';
                Swal.fire({
                    title: `Armário ${armario.numero}`,
                    html: `
                        <p><strong>Status:</strong> ${formatarStatusArmario(armario.status)}</p>
                        <p class="armario-unidade">
                            <span class="label">Unidade</span>
                            <span class="value">${armario.unidade || '-'}</span>
                        </p>
                        <p><strong>${armario.tipo === 'acompanhante' ? 'Acompanhante' : 'Visitante'}:</strong> ${armario.nomeVisitante}</p>
                        <p><strong>Paciente:</strong> ${armario.nomePaciente}</p>
                        <p><strong>Leito:</strong> ${armario.leito}</p>
                        <p><strong>Volumes:</strong> ${armario.volumes}</p>
                        ${armario.whatsapp ? `<p><strong>WhatsApp:</strong> ${armario.whatsapp}</p>` : ''}
                        <p><strong>Início:</strong> ${armario.horaInicio}</p>
                        ${armario.horaPrevista ? `<p><strong>Previsão de saída:</strong> ${armario.horaPrevista}</p>` : ''}
                        ${termoHtml}
                        ${armario.tipo === 'acompanhante' && termoPendente ? `<div style="margin-top:16px;"><button id="btn-aplicar-termo" class="swal2-confirm swal2-styled" style="background-color:#2c6e8f;">Aplicar termo agora</button></div>` : ''}
                    `,
                    icon: 'info',
                    showCancelButton: true,
                    showDenyButton: armario.tipo === 'acompanhante',
                    confirmButtonText: 'Liberar Armário',
                    denyButtonText: 'Movimentações',
                    cancelButtonText: 'Fechar',
                    confirmButtonColor: '#28a745',
                    reverseButtons: true,
                    didOpen: () => {
                        const confirmButton = Swal.getConfirmButton();
                        if (confirmButton) {
                            const aplicarLoadingConfirmacao = () => {
                                confirmButton.classList.add('swal-button-loading');
                                confirmButton.innerHTML = `
                                    <span class="swal-button-spinner" aria-hidden="true"></span>
                                    <span class="swal-button-text">Preparando liberação...</span>
                                `;
                            };
                            confirmButton.addEventListener('click', aplicarLoadingConfirmacao, { once: true });
                        }
                        if (armario.tipo === 'acompanhante' && (termoPendente || termoEmAndamento)) {
                            const btn = Swal.getHtmlContainer().querySelector('#btn-aplicar-termo');
                            if (btn) {
                                btn.addEventListener('click', async () => {
                                    const finalizar = iniciarLoadingBotao(btn);
                                    try {
                                        Swal.close();
                                        await abrirTermoWizard(armario.id);
                                    } finally {
                                        finalizar();
                                    }
                                });
                            }
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (normalizarTexto(armario.tipo) === 'visitante') {
                            confirmarLiberacaoVisitante(armario.id);
                        } else {
                            confirmarLiberacaoAcompanhante(armario.id);
                        }
                    } else if (result.isDenied) {
                        abrirMovimentacoes(armario.id);
                    }
                });
            }
        }
        // Abrir modal para novo armário
        async function abrirModalNovoArmario(tipo) {
            // Buscar armários livres do tipo especificado
            await carregarArmarios({ forcarAtualizacao: true });
            if (!estado.armariosCarregados) {
                mostrarErro('Erro ao buscar armários');
                return;
            }
            const tipoNormalizado = normalizarTexto(tipo);
            const armarioLivre = estado.armarios
                .filter(a => normalizarTexto(a.tipo) === tipoNormalizado)
                .find(a => a.status === 'livre');
            if (armarioLivre) {
                abrirModalArmario(armarioLivre);
            } else {
                await Swal.fire({
                    title: 'Sem armários disponíveis',
                    text: `Não há armários ${tipo === 'visitante' ? 'de visitantes' : 'de acompanhantes'} disponíveis no momento.`,
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
            }
        }
        // Abrir modal para novo armário físico
        async function abrirModalNovoArmarioFisico() {
            if (!estado.unidades.length) {
                await Swal.fire({
                    title: 'Nenhuma unidade cadastrada',
                    text: 'Cadastre uma unidade antes de adicionar novos armários.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }
            const opcoesUnidades = estado.unidades.map(unidade => {
                const nomeLimpo = (unidade.nome || '').trim();
                const selecionada = normalizarTexto(estado.unidadeAtual) === normalizarTexto(nomeLimpo) ? 'selected' : '';
                return `<option value="${nomeLimpo}" ${selecionada}>${nomeLimpo}</option>`;
            }).join('');
            const resultado = await Swal.fire({
                title: 'Cadastro de Armários Físicos',
                html: `
                    <div class="swal-form-grid">
                        <div class="swal-form-section">
                            <div class="swal-form-section-title"><i class="fas fa-info-circle"></i>Informações gerais</div>
                            <div class="swal-form-fields">
                                <div class="swal-form-group">
                                    <label for="tipo-armario">Tipo de armário</label>
                                    <select id="tipo-armario" class="swal2-input">
                                        <option value="visitante">Visitante</option>
                                        <option value="acompanhante">Acompanhante</option>
                                    </select>
                                </div>
                                <div class="swal-form-group">
                                    <label for="unidade-armario">Unidade responsável</label>
                                    <select id="unidade-armario" class="swal2-input">
                                        ${opcoesUnidades}
                                    </select>
                                </div>
                                <div class="swal-form-group">
                                    <label for="localizacao-armario">Localização física</label>
                                    <input type="text" id="localizacao-armario" class="swal2-input" placeholder="Ex.: Bloco A - Térreo ou Sala 102">
                                </div>
                            </div>
                        </div>
                        <div class="swal-form-section">
                            <div class="swal-form-section-title"><i class="fas fa-list-ol"></i>Numeração dos armários</div>
                            <div class="swal-form-fields two-columns">
                                <div class="swal-form-group">
                                    <label for="quantidade-armarios">Quantidade a cadastrar</label>
                                    <input type="number" id="quantidade-armarios" class="swal2-input" min="1" value="1" placeholder="Quantidade de armários">
                                </div>
                                <div class="swal-form-group">
                                    <label for="numero-armario">Número único</label>
                                    <input type="text" id="numero-armario" class="swal2-input" placeholder="Informe apenas se cadastrar 1 armário">
                                </div>
                                <div class="swal-form-group">
                                    <label for="prefixo-armario">Prefixo</label>
                                    <input type="text" id="prefixo-armario" class="swal2-input" placeholder="Ex.: UIB-V (usado para lotes)">
                                </div>
                                <div class="swal-form-group">
                                    <label for="inicio-armario">Início da numeração</label>
                                    <input type="number" id="inicio-armario" class="swal2-input" min="1" value="1" placeholder="Primeiro número do lote">
                                </div>
                            </div>
                            <div class="swal-form-hint">
                                Para cadastrar apenas um armário, preencha <strong>Número único</strong>. Para criar vários de uma vez, informe a <strong>Quantidade</strong>, o <strong>Prefixo</strong> e o <strong>Início da numeração</strong>.
                            </div>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Cadastrar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const popup = Swal.getPopup();
                    const tipo = popup.querySelector('#tipo-armario').value;
                    const unidade = popup.querySelector('#unidade-armario').value;
                    const localizacao = popup.querySelector('#localizacao-armario').value.trim();
                    const quantidadeValor = parseInt(popup.querySelector('#quantidade-armarios').value, 10);
                    const numero = popup.querySelector('#numero-armario').value.trim();
                    const prefixo = popup.querySelector('#prefixo-armario').value.trim();
                    const inicioValor = parseInt(popup.querySelector('#inicio-armario').value, 10);
                    if (!unidade) {
                        Swal.showValidationMessage('Selecione a unidade');
                        return false;
                    }
                    if (!localizacao) {
                        Swal.showValidationMessage('Informe a localização dos armários');
                        return false;
                    }
                    const quantidade = Number.isNaN(quantidadeValor) ? 1 : Math.max(1, quantidadeValor);
                    const numeroInicial = Number.isNaN(inicioValor) ? 1 : Math.max(1, inicioValor);
                    if (quantidade > 1 && !prefixo) {
                        Swal.showValidationMessage('Informe um prefixo para gerar vários armários');
                        return false;
                    }
                    if (quantidade === 1 && !numero && !prefixo) {
                        Swal.showValidationMessage('Informe o número ou um prefixo para gerar a numeração');
                        return false;
                    }
                    return { tipo, unidade, localizacao, quantidade, numero, prefixo, numeroInicial };
                }
            });
            if (!resultado.isConfirmed || !resultado.value) {
                return;
            }
            const dados = resultado.value;
            const cadastroResultado = await callGoogleScript('cadastrarArmarioFisico', dados);
            if (cadastroResultado.success) {
                // Recarregar dados
                await carregarArmarios({ forcarAtualizacao: true });
                await carregarEstatisticas();
                atualizarInterface();
                carregarDadosTabelas();
                await Swal.fire({
                    title: 'Sucesso!',
                    text: `${cadastroResultado.numeros.length} armário(s) cadastrados: ${cadastroResultado.numeros.join(', ')}`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                notificarErroPadrao(cadastroResultado);
            }
        }
        // Abrir modal para novo usuário
        function abrirModalNovoUsuario() {
            if (!perfilAtualEhAdmin()) {
                mostrarErro('Apenas administradores podem cadastrar usuários.');
                return;
            }
            elementos.usuarioForm.reset();
            elementos.usuarioForm.dataset.id = '';
            if (elementos.usuarioModalTitle) {
                elementos.usuarioModalTitle.textContent = 'Cadastrar Usuário';
            }
            if (elementos.usuarioStatus) {
                elementos.usuarioStatus.value = 'ativo';
            }
            if (elementos.usuarioUnidades) {
                renderizarOpcoesUnidadesFormulario();
            }
            elementos.usuarioModal.style.display = 'flex';
        }
        // Fechar modais
        function fecharModalArmario() {
            elementos.armarioModal.style.display = 'none';
        }
        function fecharModalUsuario() {
            elementos.usuarioModal.style.display = 'none';
            if (elementos.usuarioForm) {
                elementos.usuarioForm.dataset.id = '';
            }
        }
        // Salvar armário (cadastro)
        async function salvarArmario() {
            const botaoSalvar = document.getElementById('btn-salvar');
            const finalizarLoading = iniciarLoadingBotao(botaoSalvar);
            try {
                const idPlanilhaBruto = elementos.armarioForm.dataset.idPlanilha || elementos.armarioForm.dataset.id || '';
                const idPlanilha = normalizarIdentificador(idPlanilhaBruto);
                const armarioChave = normalizarIdentificador(elementos.armarioForm.dataset.armarioId || '');
                const tipo = elementos.armarioForm.dataset.tipo || 'visitante';
                const numeroArmario = elementos.armarioForm.dataset.numero || '';
                let volumesInformados = parseInt(document.getElementById('volumes').value, 10);
                if (Number.isNaN(volumesInformados) || volumesInformados < 0) {
                    volumesInformados = 0;
                }
                const dados = {
                    idPlanilha,
                    id: idPlanilha,
                    numero: numeroArmario,
                    nomeVisitante: document.getElementById('nome-visitante').value.trim(),
                    nomePaciente: document.getElementById('nome-paciente').value.trim(),
                    leito: document.getElementById('leito').value.trim(),
                    whatsapp: document.getElementById('whatsapp-contato').value.trim(),
                    volumes: volumesInformados,
                    horaPrevista: tipo === 'visitante' ? document.getElementById('hora-prevista').value : '',
                    tipo: tipo,
                    usuarioResponsavel: obterDescricaoResponsavelAtual()
                };
                if (tipo === 'acompanhante') {
                    termoPreCadastro = {
                        id: idPlanilha,
                        nomeVisitante: dados.nomeVisitante,
                        nomePaciente: dados.nomePaciente,
                        leito: dados.leito,
                        volumes: volumesInformados,
                        whatsapp: dados.whatsapp
                    };
                    termoCadastroArmario = {
                        id: idPlanilha,
                        nomeVisitante: dados.nomeVisitante,
                        nomePaciente: dados.nomePaciente,
                        leito: dados.leito,
                        whatsapp: dados.whatsapp
                    };
                    let ocultarOverlay = () => {};
                    try {
                        ocultarOverlay = mostrarOverlayCarregamento('Preparando termo de responsabilidade...');
                        let chaveArmario = armarioChave;
                        if (!chaveArmario) {
                            const armarioEstado = estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === idPlanilha);
                            chaveArmario = armarioEstado ? armarioEstado.id : '';
                        }
                        await abrirTermoWizard(chaveArmario || idPlanilha);
                        fecharModalArmario();
                    } catch (erroTermo) {
                        termoPreCadastro = null;
                        termoCadastroArmario = null;
                        notificarErroPadrao({ error: erroTermo.message || erroTermo.toString() });
                    } finally {
                        ocultarOverlay();
                    }
                } else {
                    const resultado = await callGoogleScript('cadastrarArmario', dados);
                    if (resultado.success) {
                        fecharModalArmario();

                        let idParaAtualizacao = armarioChave;
                        if (!idParaAtualizacao && idPlanilha) {
                            const armarioEstado = estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === idPlanilha);
                            if (armarioEstado) {
                                idParaAtualizacao = armarioEstado.id;
                            }
                        }

                        if (idParaAtualizacao) {
                            const agora = new Date();
                            const horaInicioLocal = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            const atualizacoesLocais = {
                                status: 'em-uso',
                                nomeVisitante: dados.nomeVisitante,
                                nomePaciente: dados.nomePaciente,
                                leito: dados.leito,
                                volumes: volumesInformados,
                                whatsapp: dados.whatsapp,
                                horaInicio: horaInicioLocal,
                                horaPrevista: dados.horaPrevista || '',
                                dataRegistro: agora.toISOString(),
                                tipo: tipo
                            };
                            const atualizado = atualizarArmarioLocal(idParaAtualizacao, atualizacoesLocais);
                            if (!atualizado) {
                                console.warn('Armário não encontrado no estado local para atualização imediata:', idParaAtualizacao);
                            }
                        }

                        atualizarResumoDashboardLocal();
                        atualizarInterface();
                        carregarDadosTabelas({ recarregarArmarios: false }).catch(erro => {
                            console.error('Erro ao atualizar tabelas localmente após cadastro:', erro);
                        });

                        mostrarSucesso('Armário cadastrado com sucesso');
                        sincronizarDadosArmariosEmSegundoPlano({ recarregarArmariosNasTabelas: true });
                    } else {
                        notificarErroPadrao(resultado);
                    }
                }
            } finally {
                finalizarLoading();
            }
        }
        // Salvar usuário
        async function salvarUsuario() {
            if (!perfilAtualEhAdmin()) {
                mostrarErro('Apenas administradores podem salvar usuários.');
                return;
            }
            const botaoSalvar = document.getElementById('usuario-btn-salvar');
            const finalizarLoading = iniciarLoadingBotao(botaoSalvar);
            const usuarioId = elementos.usuarioForm.dataset.id;
            const dados = {
                id: usuarioId,
                nome: document.getElementById('usuario-nome').value.trim(),
                email: document.getElementById('usuario-email').value.trim(),
                senha: elementos.usuarioSenha ? elementos.usuarioSenha.value.trim() : '',
                perfil: document.getElementById('usuario-perfil').value,
                status: elementos.usuarioStatus ? elementos.usuarioStatus.value : 'ativo',
                acessoVisitantes: document.getElementById('acesso-visitantes').checked,
                acessoAcompanhantes: document.getElementById('acesso-acompanhantes').checked,
                unidades: obterUnidadesSelecionadasFormulario()
            };
            try {
                if (!dados.unidades.length && dados.perfil !== 'admin') {
                    mostrarErro('Selecione ao menos uma unidade para o usuário.');
                    return;
                }
                const acao = usuarioId ? 'atualizarUsuario' : 'cadastrarUsuario';
                const resultado = await callGoogleScript(acao, dados);
                if (resultado.success) {
                    fecharModalUsuario();
                    mostrarSucesso(usuarioId ? 'Usuário atualizado com sucesso' : 'Usuário cadastrado com sucesso');
                    await carregarUsuarios();
                    carregarTabelaUsuarios();
                } else {
                    notificarErroPadrao(resultado);
                }
            } finally {
                finalizarLoading();
            }
        }
        // Liberar armário
        async function liberarArmario(id, tipoPreferencial) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                mostrarErro('Armário não encontrado. Atualize a lista e tente novamente.');
                return;
            }
            const identificadores = montarIdentificadoresArmario(armario);
            const payload = montarPayloadAcaoArmario(armario, {
                tipo: tipoPreferencial || identificadores.tipo
            });
            payload.numero = identificadores.numeroArmario;

            const resultado = await callGoogleScript('liberarArmario', payload);
            if (resultado.success) {
                garantirArmarioLiberadoLocal(id);
                atualizarResumoDashboardLocal();
                atualizarInterface();
                carregarDadosTabelas({ recarregarArmarios: false }).catch(erro => {
                    console.error('Erro ao atualizar tabelas localmente após liberação:', erro);
                });

                mostrarSucesso('Armário liberado com sucesso');
                sincronizarDadosArmariosEmSegundoPlano({ recarregarArmariosNasTabelas: true });
                return;
            }

            const mensagemErro = (resultado.error || '').toString();
            const mensagemNormalizada = mensagemErro.toLowerCase();

            if (mensagemNormalizada.includes('já está livre')) {
                mostrarErro('Este armário já está livre. Atualize a lista para confirmar a situação.');
                return;
            }

            if (mensagemNormalizada.includes('não encontrado')) {
                mostrarErro('Não encontramos este armário. Atualize a lista e tente novamente.');
                return;
            }

            notificarErroPadrao(resultado);
        }
        function formatarStatusArmario(status) {
            switch (status) {
                case 'em-uso':
                    return 'Em uso';
                case 'proximo':
                    return 'Próximo do horário';
                case 'vencido':
                    return 'Vencido';
                default:
                    return 'Livre';
            }
        }
        function formatarStatusTermo(status) {
            const normalizado = normalizarTexto(status);
            if (normalizado === 'finalizado') {
                return 'Finalizado';
            }
            if (normalizado === 'em andamento') {
                return 'Em andamento';
            }
            return 'Pendente';
        }
        function formatarData(valor) {
            if (!valor) return '-';
            if (typeof valor === 'string') {
                const texto = valor.trim();
                if (!texto) return '-';
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(texto)) {
                    return texto;
                }
            }
            try {
                const data = new Date(valor);
                if (Number.isNaN(data.getTime())) {
                    return valor;
                }
                return data.toLocaleDateString('pt-BR');
            } catch {
                return valor;
            }
        }
        function formatarDataHora(valor) {
            if (!valor) return '-';
            try {
                const data = new Date(valor);
                if (Number.isNaN(data.getTime())) {
                    return valor;
                }
                return `${data.toLocaleDateString('pt-BR')} ${data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            } catch {
                return valor;
            }
        }
        function obterArmarioPorId(id) {
            const alvo = normalizarIdentificador(id);
            return estado.armarios.find(a => normalizarIdentificador(a.id) === alvo);
        }
        function usarArmario(id) {
            const armario = obterArmarioPorId(id);
            if (armario) {
                abrirModalArmario(armario);
            }
        }
        function abrirTermoDireto(id) {
            abrirTermoWizard(id);
        }
        async function abrirTermoWizard(id) {
            let armario = obterArmarioPorId(id);
            if (!armario) {
                armario = estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(id));
            }
            if (!armario) return;
            const identificadores = montarIdentificadoresArmario(armario);
            termoArmarioAtual = id;
            elementos.termoArmario.textContent = identificadores?.numeroArmario || armario.numero || '';
            elementos.termoForm.reset();
            elementos.termoForm.querySelectorAll('.wizard-field').forEach(field => field.classList.remove('invalid'));
            limparAssinaturaTermo(true);

            let termoDados = null;
            const preCadastro = termoPreCadastro && identificadores && normalizarIdentificador(termoPreCadastro.id) === identificadores.idPlanilha
                ? termoPreCadastro
                : null;
            try {
                const resposta = await callGoogleScript('getTermo', montarPayloadTermo(armario, { incluirFinalizados: false }));
                if (resposta.success) {
                    termoDados = resposta.data;
                } else if (resposta.error && resposta.error !== 'Termo não encontrado') {
                    notificarErroPadrao(resposta);
                }
            } catch (erro) {
                console.warn('Falha ao carregar termo existente:', erro);
            }

            document.getElementById('termo-paciente').value = termoDados?.paciente || preCadastro?.nomePaciente || armario.nomePaciente || '';
            document.getElementById('termo-prontuario').value = termoDados?.prontuario || '';
            document.getElementById('termo-nascimento').value = termoDados?.nascimento ? termoDados.nascimento.slice(0, 10) : '';
            definirSetorTermo(termoDados?.setor || preCadastro?.setor || '');
            document.getElementById('termo-leito').value = termoDados?.leito || preCadastro?.leito || armario.leito || '';
            document.getElementById('termo-resp-nome').value = termoDados?.acompanhante || preCadastro?.nomeVisitante || armario.nomeVisitante || '';
            document.getElementById('termo-resp-telefone').value = termoDados?.telefone || '';
            document.getElementById('termo-resp-doc').value = termoDados?.documento || '';
            document.getElementById('termo-resp-parentesco').value = termoDados?.parentesco || '';

            if (termoDados?.consciente) {
                const radio = document.querySelector(`input[name="termo-consciente"][value="${termoDados.consciente}"]`);
                if (radio) radio.checked = true;
            } else {
                document.querySelectorAll('input[name="termo-consciente"]').forEach(r => (r.checked = false));
            }

            ['ori1', 'ori2', 'ori3'].forEach(chave => {
                const checkbox = document.getElementById(`termo-${chave}`);
                if (checkbox) {
                    checkbox.checked = termoDados?.orientacoes?.includes(chave) || false;
                }
            });

            prepararVolumesTermo(Array.isArray(termoDados?.volumes) && termoDados.volumes.length ? termoDados.volumes : []);
            mostrarPassoTermo(0);
            elementos.termoModal.style.display = 'flex';
            await aguardarProximoFrame();
            inicializarCanvasAssinatura();
            const assinaturaInicial = termoDados?.assinaturas?.inicial || termoDados?.assinaturaBase64 || '';
            if (assinaturaInicial) {
                restaurarAssinaturaTermo(assinaturaInicial);
            }
        }
        function mostrarPassoTermo(indice) {
            termoSteps.forEach((step, idx) => step.classList.toggle('active', idx === indice));
            termoPassoAtual = indice;
            const passoAtual = termoSteps[indice];
            if (passoAtual?.contains(elementos.termoAssinaturaCanvas)) {
                requestAnimationFrame(() => inicializarCanvasAssinatura());
            }
            const total = termoSteps.length;
            elementos.termoBtnVoltar.disabled = indice === 0;
            elementos.termoBtnAvancar.textContent = indice === total - 1 ? 'Concluir etapa inicial' : 'Avançar';
            const progresso = ((indice + 1) / total) * 100;
            elementos.termoProgress.style.width = `${progresso}%`;
            elementos.termoProgressLabel.textContent = `Passo ${indice + 1} de ${total}`;
        }
        function marcarCampoTermoInvalido(elemento) {
            const field = elemento.closest('.wizard-field') || elemento.closest('.wizard-chip')?.closest('.wizard-field');
            if (field) {
                field.classList.add('invalid');
            }
        }
        function validarPassoTermo(indice) {
            const step = termoSteps[indice];
            if (!step) return true;
            step.querySelectorAll('.wizard-field').forEach(field => field.classList.remove('invalid'));
            const inputs = step.querySelectorAll('input[required], textarea[required], select[required]');
            let valido = true;
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    const radios = step.querySelectorAll(`input[type="radio"][name="${input.name}"]`);
                    const algumMarcado = Array.from(radios).some(radio => radio.checked);
                    if (!algumMarcado) {
                        marcarCampoTermoInvalido(input);
                        valido = false;
                    }
                } else if (input.type === 'checkbox') {
                    if (!input.checked) {
                        marcarCampoTermoInvalido(input);
                        valido = false;
                    }
                } else {
                    if (!input.value.trim()) {
                        marcarCampoTermoInvalido(input);
                        valido = false;
                    }
                }
            });
            if (step.contains(elementos.termoVolumesField) && !validarVolumesTermo()) {
                valido = false;
            }
            if (step.contains(elementos.termoAssinaturaCanvas) && !termoAssinaturaDesenhada) {
                elementos.termoAssinaturaCanvas.closest('.wizard-field')?.classList.add('invalid');
                valido = false;
            }
            return valido;
        }
        function prepararVolumesTermo(volumes = []) {
            if (!elementos.termoVolumesList) return;
            elementos.termoVolumesList.innerHTML = '';
            if (Array.isArray(volumes) && volumes.length) {
                volumes.forEach(volume => adicionarVolumeTermo(volume));
            } else {
                adicionarVolumeTermo();
            }
            atualizarRemocaoVolumesTermo();
            elementos.termoVolumesField?.classList.remove('invalid');
        }
        function criarVolumeItemTermo(dados = {}) {
            const item = document.createElement('div');
            item.className = 'wizard-volume-item';
            const grid = document.createElement('div');
            grid.className = 'wizard-volume-grid';
            const colQtd = document.createElement('div');
            colQtd.className = 'wizard-volume-col';
            const labelQtd = document.createElement('label');
            labelQtd.textContent = 'Quantidade';
            const inputQtd = document.createElement('input');
            inputQtd.type = 'number';
            inputQtd.min = '1';
            inputQtd.placeholder = 'Qtd.';
            inputQtd.className = 'wizard-input termo-volume-qty';
            if (dados.quantidade !== undefined && dados.quantidade !== null && dados.quantidade !== '') {
                inputQtd.value = dados.quantidade;
            }
            const colDesc = document.createElement('div');
            colDesc.className = 'wizard-volume-col';
            const labelDesc = document.createElement('label');
            labelDesc.textContent = 'Descrição';
            const inputDesc = document.createElement('input');
            inputDesc.type = 'text';
            inputDesc.placeholder = 'Ex.: mochila azul';
            inputDesc.className = 'wizard-input termo-volume-desc';
            inputDesc.setAttribute('list', 'termo-itens-sugestoes');
            if (dados.descricao) {
                inputDesc.value = dados.descricao;
            }
            const actions = document.createElement('div');
            actions.className = 'wizard-volume-actions';
            const remover = document.createElement('button');
            remover.type = 'button';
            remover.className = 'btn btn-secondary btn-remove-volume';
            remover.textContent = 'Remover';
            actions.appendChild(remover);
            colQtd.appendChild(labelQtd);
            colQtd.appendChild(inputQtd);
            colDesc.appendChild(labelDesc);
            colDesc.appendChild(inputDesc);
            grid.appendChild(colQtd);
            grid.appendChild(colDesc);
            grid.appendChild(actions);
            item.appendChild(grid);
            return item;
        }
        function adicionarVolumeTermo(dados = {}) {
            if (!elementos.termoVolumesList) return null;
            const item = criarVolumeItemTermo(dados);
            elementos.termoVolumesList.appendChild(item);
            atualizarRemocaoVolumesTermo();
            elementos.termoVolumesField?.classList.remove('invalid');
            return item;
        }
        function removerVolumeTermo(item) {
            if (!item || !elementos.termoVolumesList) return;
            item.remove();
            if (!elementos.termoVolumesList.querySelector('.wizard-volume-item')) {
                adicionarVolumeTermo();
            }
            atualizarRemocaoVolumesTermo();
        }
        function atualizarRemocaoVolumesTermo() {
            if (!elementos.termoVolumesList) return;
            const itens = Array.from(elementos.termoVolumesList.querySelectorAll('.wizard-volume-item'));
            itens.forEach(item => {
                const botao = item.querySelector('.btn-remove-volume');
                if (botao) {
                    botao.style.display = itens.length === 1 ? 'none' : '';
                }
                const campoQtd = item.querySelector('.termo-volume-qty');
                const campoDesc = item.querySelector('.termo-volume-desc');
                if (campoQtd && !campoQtd.hasAttribute('required')) {
                    campoQtd.setAttribute('required', 'required');
                }
                if (campoDesc && !campoDesc.hasAttribute('required')) {
                    campoDesc.setAttribute('required', 'required');
                }
            });
        }
        function obterVolumesTermo() {
            if (!elementos.termoVolumesList) return [];
            return Array.from(elementos.termoVolumesList.querySelectorAll('.wizard-volume-item')).map(item => {
                const quantidadeValor = item.querySelector('.termo-volume-qty')?.value || '';
                const descricaoValor = item.querySelector('.termo-volume-desc')?.value.trim() || '';
                const quantidade = quantidadeValor ? parseInt(quantidadeValor, 10) : 0;
                return {
                    quantidade: Number.isNaN(quantidade) ? 0 : quantidade,
                    descricao: descricaoValor
                };
            });
        }
        function validarVolumesTermo() {
            if (!elementos.termoVolumesField) return true;
            const volumes = obterVolumesTermo();
            const todosValidos = volumes.length > 0 && volumes.every(volume => volume.quantidade > 0 && volume.descricao);
            if (!todosValidos) {
                elementos.termoVolumesField.classList.add('invalid');
                return false;
            }
            elementos.termoVolumesField.classList.remove('invalid');
            return true;
        }
        function limparAssinaturaTermo(silencioso = false) {
            const canvas = elementos.termoAssinaturaCanvas;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            termoAssinaturaDesenhada = false;
            termoDesenhandoAssinatura = false;
            const campo = canvas.closest('.wizard-field');
            if (!campo) return;
            if (silencioso) {
                campo.classList.remove('invalid');
            } else {
                campo.classList.add('invalid');
            }
        }
        function restaurarAssinaturaTermo(base64) {
            if (!base64) return;
            const canvas = elementos.termoAssinaturaCanvas;
            if (!canvas) return;
            const dataUrl = base64.startsWith('data:') ? base64 : `data:image/png;base64,${base64}`;
            restaurarDesenhoCanvas(canvas, dataUrl);
            termoAssinaturaDesenhada = true;
            termoDesenhandoAssinatura = false;
            canvas.closest('.wizard-field')?.classList.remove('invalid');
        }
        function obterPosicaoAssinaturaTermo(evento) {
            const canvas = elementos.termoAssinaturaCanvas;
            if (!canvas) return { x: 0, y: 0 };
            const rect = canvas.getBoundingClientRect();
            return {
                x: evento.clientX - rect.left,
                y: evento.clientY - rect.top
            };
        }
        function iniciarAssinaturaTermo(evento) {
            if (!elementos.termoAssinaturaCanvas) return;
            evento.preventDefault();
            termoDesenhandoAssinatura = true;
            const ctx = elementos.termoAssinaturaCanvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#0b1324';
            const pos = obterPosicaoAssinaturaTermo(evento);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
        function desenharAssinaturaTermo(evento) {
            if (!termoDesenhandoAssinatura || !elementos.termoAssinaturaCanvas) return;
            evento.preventDefault();
            const ctx = elementos.termoAssinaturaCanvas.getContext('2d');
            const pos = obterPosicaoAssinaturaTermo(evento);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            termoAssinaturaDesenhada = true;
            elementos.termoAssinaturaCanvas.closest('.wizard-field')?.classList.remove('invalid');
        }
        function finalizarAssinaturaTermo(evento) {
            if (!termoDesenhandoAssinatura) return;
            evento.preventDefault();
            termoDesenhandoAssinatura = false;
            termoAssinaturaDesenhada = true;
            elementos.termoAssinaturaCanvas?.closest('.wizard-field')?.classList.remove('invalid');
        }
        function navegarPassoTermo(delta) {
            const novoIndice = termoPassoAtual + delta;
            if (novoIndice >= 0 && novoIndice < termoSteps.length) {
                mostrarPassoTermo(novoIndice);
            }
        }
        async function avancarOuAplicarTermo(evento) {
            if (!validarPassoTermo(termoPassoAtual)) {
                return;
            }
            if (termoPassoAtual < termoSteps.length - 1) {
                mostrarPassoTermo(termoPassoAtual + 1);
                return;
            }
            const botao = evento?.currentTarget || elementos.termoBtnAvancar;
            const finalizar = iniciarLoadingBotao(botao);
            try {
                await aplicarTermo();
            } finally {
                finalizar();
            }
        }

        async function aplicarTermo() {
            if (termoArmarioAtual === null) return;
            const armarioAtual = obterArmarioPorId(termoArmarioAtual) || estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(termoArmarioAtual));
            if (!armarioAtual) {
                mostrarErro('Armário não encontrado para registrar o termo.');
                return;
            }
            const identificadores = montarIdentificadoresArmario(armarioAtual);
            // Capturar a assinatura do canvas
            const canvas = elementos.termoAssinaturaCanvas;
            const assinaturaBase64 = canvas ? canvas.toDataURL('image/png').replace('data:image/png;base64,', '') : '';
            const volumes = obterVolumesTermo();
            const descricaoVolumes = volumes.map(v => `${v.quantidade}x ${v.descricao}`).join('; ');
            const dadosTermo = {
                armarioId: identificadores?.idPlanilha || '',
                numeroArmario: identificadores?.numeroArmario || document.getElementById('termo-armario').textContent,
                paciente: document.getElementById('termo-paciente').value.trim(),
                prontuario: document.getElementById('termo-prontuario').value.trim(),
                nascimento: document.getElementById('termo-nascimento').value,
                setor: (elementos.termoSetor?.value || '').toString().trim(),
                leito: document.getElementById('termo-leito').value.trim(),
                consciente: document.querySelector('input[name="termo-consciente"]:checked')?.value || '',
                acompanhante: document.getElementById('termo-resp-nome').value.trim(),
                telefone: document.getElementById('termo-resp-telefone').value.trim(),
                documento: document.getElementById('termo-resp-doc').value.trim(),
                parentesco: document.getElementById('termo-resp-parentesco').value.trim(),
                orientacoes: ['ori1', 'ori2', 'ori3'].filter(chave => document.getElementById(`termo-${chave}`).checked),
                volumes: volumes,
                descricaoVolumes: descricaoVolumes,
                assinaturaBase64: assinaturaBase64
            };
            if (termoCadastroArmario && identificadores && normalizarIdentificador(termoCadastroArmario.id) === identificadores.idPlanilha) {
                dadosTermo.cadastroArmario = {
                    id: identificadores.idPlanilha,
                    nomeVisitante: dadosTermo.acompanhante,
                    nomePaciente: dadosTermo.paciente,
                    leito: dadosTermo.leito,
                    whatsapp: termoCadastroArmario.whatsapp || ''
                };
            }
            dadosTermo.tipo = identificadores?.tipo || 'acompanhante';
            const resultado = await callGoogleScript('salvarTermoCompleto', dadosTermo);
            if (resultado.success) {
                fecharTermoModal();
                await atualizarDadosPosOperacao('Atualizando informações do armário...');
                mostrarSucesso('Etapa inicial do termo registrada. Finalize o termo ao encerrar o armário.');
            } else {
                notificarErroPadrao(resultado);
            }
        }
        function fecharTermoModal() {
            elementos.termoModal.style.display = 'none';
            termoArmarioAtual = null;
            termoPreCadastro = null;
            termoCadastroArmario = null;
            mostrarPassoTermo(0);
            elementos.termoForm.reset();
            elementos.termoForm.querySelectorAll('.wizard-field').forEach(field => field.classList.remove('invalid'));
            prepararVolumesTermo();
            limparAssinaturaTermo(true);
        }
        function criarControladorAssinaturaFinalizacao(canvas, field) {
            if (!canvas) return null;
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const areaAssinatura = canvas.parentElement;
            const areaRect = areaAssinatura ? areaAssinatura.getBoundingClientRect() : rect;
            const larguraDisponivel = Math.max(areaRect.width || 0, rect.width || 0);
            const largura = Math.max(larguraDisponivel, 420);
            const altura = Math.max(areaRect.height || rect.height || 0, 240);
            canvas.width = largura;
            canvas.height = altura;
            canvas.style.width = `${largura}px`;
            canvas.style.height = `${altura}px`;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#0b1324';
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let desenhando = false;
            let assinou = false;

            const obterPosicao = (evento) => {
                const bounds = canvas.getBoundingClientRect();
                return {
                    x: evento.clientX - bounds.left,
                    y: evento.clientY - bounds.top
                };
            };

            const iniciar = (evento) => {
                evento.preventDefault();
                desenhando = true;
                const posicao = obterPosicao(evento);
                ctx.beginPath();
                ctx.moveTo(posicao.x, posicao.y);
                canvas.setPointerCapture?.(evento.pointerId);
                field?.classList.remove('invalid');
            };

            const desenhar = (evento) => {
                if (!desenhando) return;
                evento.preventDefault();
                const posicao = obterPosicao(evento);
                ctx.lineTo(posicao.x, posicao.y);
                ctx.stroke();
                assinou = true;
                field?.classList.remove('invalid');
            };

            const finalizar = (evento) => {
                if (!desenhando) return;
                evento.preventDefault();
                desenhando = false;
                canvas.releasePointerCapture?.(evento.pointerId);
            };

            const limpar = (mostrarErro = true) => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                assinou = false;
                if (mostrarErro) {
                    field?.classList.add('invalid');
                }
            };

            const removerEventos = () => {
                canvas.removeEventListener('pointerdown', iniciar);
                canvas.removeEventListener('pointermove', desenhar);
                canvas.removeEventListener('pointerup', finalizar);
                canvas.removeEventListener('pointerleave', finalizar);
                canvas.removeEventListener('pointercancel', finalizar);
            };

            canvas.addEventListener('pointerdown', iniciar);
            canvas.addEventListener('pointermove', desenhar);
            canvas.addEventListener('pointerup', finalizar);
            canvas.addEventListener('pointerleave', finalizar);
            canvas.addEventListener('pointercancel', finalizar);
            field?.classList.add('invalid');

            return {
                limpar,
                possuiAssinatura: () => assinou,
                obterImagem: () => canvas.toDataURL('image/png'),
                destruir: removerEventos
            };
        }
        async function coletarAssinaturaEncerramento(nomeAcompanhante) {
            const nomeTratado = (nomeAcompanhante || '').toString().trim();
            const textoAssinante = nomeTratado ? `<strong>${nomeTratado}</strong>` : 'o acompanhante';
            let controlador = null;
            let botaoLimpar = null;
            let limparHandler = null;

            const resultado = await Swal.fire({
                title: 'Assinatura de encerramento',
                html: `
                    <div class="final-signature-dialog">
                        <p>Solicite que ${textoAssinante} assine abaixo para concluir o encerramento.</p>
                        <div class="wizard-field" id="final-signature-field">
                            <label class="wizard-required" for="final-signature-canvas">Assinatura do acompanhante</label>
                            <div class="wizard-signature-area">
                                <canvas id="final-signature-canvas" class="wizard-signature-canvas" aria-label="Área para assinatura de encerramento"></canvas>
                                <div class="wizard-signature-actions">
                                    <button type="button" class="btn btn-secondary" id="final-signature-clear">Limpar assinatura</button>
                                </div>
                                <div class="wizard-signature-hint">A assinatura será anexada ao termo de responsabilidade.</div>
                            </div>
                            <div class="wizard-error">Colha a assinatura para finalizar o armário.</div>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                width: '720px',
                customClass: {
                    popup: 'swal2-final-signature'
                },
                confirmButtonText: 'Finalizar encerramento',
                cancelButtonText: 'Cancelar',
                didOpen: () => {
                    const canvas = document.getElementById('final-signature-canvas');
                    const field = document.getElementById('final-signature-field');
                    botaoLimpar = document.getElementById('final-signature-clear');
                    const inicializar = () => {
                        if (!canvas) {
                            return;
                        }
                        controlador = criarControladorAssinaturaFinalizacao(canvas, field);
                        if (botaoLimpar) {
                            limparHandler = (evento) => {
                                evento.preventDefault();
                                controlador?.limpar();
                            };
                            botaoLimpar.addEventListener('click', limparHandler);
                        }
                    };
                    if (typeof requestAnimationFrame === 'function') {
                        requestAnimationFrame(inicializar);
                    } else {
                        setTimeout(inicializar, 0);
                    }
                },
                willClose: () => {
                    if (botaoLimpar && limparHandler) {
                        botaoLimpar.removeEventListener('click', limparHandler);
                    }
                    if (controlador) {
                        controlador.destruir();
                        controlador = null;
                    }
                },
                preConfirm: () => {
                    const field = document.getElementById('final-signature-field');
                    if (!controlador || !controlador.possuiAssinatura()) {
                        field?.classList.add('invalid');
                        Swal.showValidationMessage('Colha a assinatura para finalizar o armário.');
                        return false;
                    }
                    const imagem = controlador.obterImagem();
                    return imagem.replace('data:image/png;base64,', '');
                }
            });

            return resultado.isConfirmed ? resultado.value : null;
        }
        async function abrirMovimentacoes(id) {
            const armario = obterArmarioPorId(id);
            if (!armario) return;
            movimentacaoArmarioAtual = id;
            elementos.movimentacaoModalTitle.textContent = `Movimentações - Armário ${armario.numero}`;
            elementos.movimentacaoForm.reset();
            atualizarResponsavelMovimentacaoInfo();
            const padraoLocal = obterDataHoraLocalPadrao();
            elementos.movData.value = padraoLocal.data;
            elementos.movHora.value = padraoLocal.hora;
            elementos.movimentacaoModal.style.display = 'flex';
            mostrarLoadingMovimentacoes();
            await renderizarMovimentacoes(id);
        }

        function fecharMovimentacaoModal() {
            elementos.movimentacaoModal.style.display = 'none';
            movimentacaoArmarioAtual = null;
        }
        function mostrarLoadingMovimentacoes() {
            if (!elementos.movimentacoesList) return;
            elementos.movimentacoesList.innerHTML = `
                <div class="loading-state">
                    <span class="loading-spinner"></span>
                    Carregando movimentações...
                </div>
            `;
        }
        function formatarTituloMovimento(tipo) {
            const mapa = {
                entrada: 'Entrada de pertences',
                saida: 'Saída de pertences',
                conferencia: 'Conferência'
            };
            return mapa[tipo] || tipo;
        }
        async function renderizarMovimentacoes(id) {
            if (!elementos.movimentacoesList) return;
            const armario = obterArmarioPorId(id) || estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(id));
            if (!armario) {
                elementos.movimentacoesList.innerHTML = '';
                const erro = document.createElement('div');
                erro.className = 'info-box';
                erro.textContent = 'Armário não encontrado para carregar movimentações.';
                elementos.movimentacoesList.appendChild(erro);
                return;
            }
            const parametros = montarPayloadTermo(armario);
            const resultado = await callGoogleScript('getMovimentacoes', parametros);
            if (!resultado.success) {
                elementos.movimentacoesList.innerHTML = '';
                const erro = document.createElement('div');
                erro.className = 'info-box';
                erro.textContent = 'Não foi possível carregar as movimentações.';
                elementos.movimentacoesList.appendChild(erro);
                notificarErroPadrao(resultado);
                return;
            }
            const lista = resultado.data;
            elementos.movimentacoesList.innerHTML = '';
            if (!lista.length) {
                const vazio = document.createElement('div');
                vazio.className = 'info-box';
                vazio.textContent = 'Nenhuma movimentação registrada até o momento.';
                elementos.movimentacoesList.appendChild(vazio);
                return;
            }
            lista.forEach(item => {
                const bloco = document.createElement('div');
                bloco.className = 'movimentacao-item';
                const responsavelTexto = item.responsavel ? item.responsavel : 'Não informado';
                bloco.innerHTML = `
                    <div class="movimentacao-header">
                        <span>${formatarTituloMovimento(item.tipo)}</span>
                        <span>${formatarData(item.data)} ${item.hora}</span>
                    </div>
                    <div class="movimentacao-meta">
                        <span><strong>Descrição:</strong> ${item.descricao}</span>
                        <span><strong>Responsável:</strong> ${responsavelTexto}</span>
                    </div>
                `;
                elementos.movimentacoesList.appendChild(bloco);
            });
        }

        async function salvarMovimentacao() {
            if (!movimentacaoArmarioAtual) return;
            if (movimentacaoEmProgresso) return;
            movimentacaoEmProgresso = true;
            try {
                const armario = obterArmarioPorId(movimentacaoArmarioAtual) || estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(movimentacaoArmarioAtual));
                if (!armario) {
                    mostrarErro('Armário não encontrado para registrar movimentação.');
                    return;
                }
                const responsavelRegistro = obterDescricaoResponsavelAtual();
                if (!responsavelRegistro) {
                    mostrarErro('Não foi possível identificar o usuário responsável. Faça login novamente para registrar movimentações.');
                    return;
                }
                const identificadores = montarIdentificadoresArmario(armario);
                const tipoSelecionado = normalizarTexto(elementos.movTipo.value);
                const dados = {
                    armarioId: identificadores?.idPlanilha || '',
                    numeroArmario: identificadores?.numeroArmario || '',
                    tipo: tipoSelecionado || identificadores?.tipo || '',
                    tipoArmario: identificadores?.tipo || '',
                    descricao: elementos.movDescricao.value.trim(),
                    responsavel: responsavelRegistro,
                    data: elementos.movData.value,
                    hora: elementos.movHora.value
                };
                const resultado = await callGoogleScript('salvarMovimentacao', dados);
                if (resultado.success) {
                    await renderizarMovimentacoes(movimentacaoArmarioAtual);
                    mostrarSucesso('Movimentação registrada com sucesso');
                    elementos.movimentacaoForm.reset();
                    elementos.movTipo.value = '';
                    const padraoLocal = obterDataHoraLocalPadrao();
                    elementos.movData.value = padraoLocal.data;
                    elementos.movHora.value = padraoLocal.hora;
                } else {
                    notificarErroPadrao(resultado);
                }
            } finally {
                movimentacaoEmProgresso = false;
            }
        }
        async function tratarAcaoTermo(evento) {
            const elementoAcao = evento.target.closest('[data-action]');
            if (!elementoAcao) return;
            const acao = elementoAcao.dataset.action;
            const id = extrairIdDataset(elementoAcao);
            if (!id) return;

            let finalizarLoading = () => {};
            if (elementoAcao.tagName === 'BUTTON') {
                finalizarLoading = iniciarLoadingBotao(elementoAcao);
            }

            try {
                switch (acao) {
                    case 'ver':
                        await exibirResumoTermo(id);
                        break;
                    case 'mov':
                        await abrirMovimentacoes(id);
                        break;
                    case 'encerrar':
                        await confirmarLiberacaoAcompanhante(id);
                        break;
                    case 'ver-pdf':
                        evento.preventDefault();
                        await verPDFTermo(id);
                        break;
                    case 'aplicar':
                        await abrirTermoWizard(id);
                        break;
                    case 'continuar':
                        await abrirTermoWizard(id);
                        break;
                    default:
                        break;
                }
            } finally {
                finalizarLoading();
            }
        }

        async function exibirResumoTermo(id) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                mostrarErro('Armário não encontrado');
                return;
            }
            // Buscar detalhes do termo
            const resultado = await callGoogleScript('getTermo', montarPayloadTermo(armario, { incluirFinalizados: true }));
            if (!resultado.success) {
                mostrarErro('Termo não encontrado');
                return;
            }
            const termo = resultado.data;
            const metodoFinalNormalizado = normalizarTexto(termo.metodoFinal);
            let metodoEncerramentoHtml = '';
            if (termo.metodoFinal) {
                let descricaoMetodo = 'Assinatura digital';
                if (metodoFinalNormalizado === 'cpf') {
                    descricaoMetodo = `Confirmação por CPF (${termo.cpfConfirmacao || ''})`;
                } else if (metodoFinalNormalizado === 'manual') {
                    descricaoMetodo = 'Finalização manual (sem assinatura digital)';
                }
                metodoEncerramentoHtml = `<p><strong>Método de encerramento:</strong> ${descricaoMetodo}</p>`;
            }

            const html = `
                <p><strong>Paciente:</strong> ${termo.paciente}</p>
                <p><strong>Prontuário:</strong> ${termo.prontuario}</p>
                <p><strong>Setor:</strong> ${termo.setor}</p>
                <p><strong>Leito:</strong> ${termo.leito}</p>
                <p><strong>Acompanhante:</strong> ${termo.acompanhante}</p>
                ${termo.telefone ? `<p><strong>Telefone:</strong> ${termo.telefone}</p>` : ''}
                ${termo.documento ? `<p><strong>Documento:</strong> ${termo.documento}</p>` : ''}
                ${termo.parentesco ? `<p><strong>Parentesco:</strong> ${termo.parentesco}</p>` : ''}
                <p><strong>Volumes:</strong> ${termo.descricaoVolumes}</p>
                <p><strong>Aplicado em:</strong> ${formatarDataHora(termo.aplicadoEm)}</p>
                ${termo.finalizadoEm ? `<p><strong>Finalizado em:</strong> ${formatarDataHora(termo.finalizadoEm)}</p>` : '<p><strong>Status:</strong> Em andamento</p>'}
                ${metodoEncerramentoHtml}
            `;
            Swal.fire({
                title: `Termo - Armário ${armario.numero}`,
                html,
                icon: 'info',
                confirmButtonText: 'Fechar'
            });
        }
        async function verPDFTermo(id) {
            const armario = obterArmarioPorId(id) || estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(id));
            if (!armario) {
                mostrarErro('Armário não encontrado');
                return;
            }
            const resultado = await callGoogleScript('getTermo', montarPayloadTermo(armario, { incluirFinalizados: true }));
            if (resultado.success && resultado.data.pdfUrl) {
                window.open(resultado.data.pdfUrl, '_blank');
            } else {
                mostrarErro('PDF não disponível para este termo');
            }
        }
        async function confirmarLiberacaoVisitante(id) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                mostrarErro('Armário não encontrado para liberação.');
                return;
            }
            const resumoHtml = `
                <div class="info-box" style="text-align:left;">
                    <p><strong>Visitante:</strong> ${armario.nomeVisitante || '-'}</p>
                    <p><strong>Paciente:</strong> ${armario.nomePaciente || '-'}</p>
                    <p><strong>Leito:</strong> ${armario.leito || '-'}</p>
                    <p><strong>Volumes:</strong> ${armario.volumes || '-'}</p>
                    <p><strong>Início:</strong> ${armario.horaInicio || '-'}</p>
                    ${armario.horaPrevista ? `<p><strong>Previsão de saída:</strong> ${armario.horaPrevista}</p>` : ''}
                    ${armario.whatsapp ? `<p><strong>WhatsApp:</strong> ${armario.whatsapp}</p>` : ''}
                </div>
            `;
            const resultado = await Swal.fire({
                title: `Encerrar armário ${armario.numero}?`,
                html: `${resumoHtml}<p style="margin-top:12px; color:#4b5563;">Confirme que as informações estão corretas para finalizar o armário do visitante.</p>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Confirmo a liberação',
                cancelButtonText: 'Cancelar',
                focusConfirm: false
            });
            if (!resultado.isConfirmed) {
                return;
            }
            await liberarArmario(id, 'visitante');
        }
        async function confirmarLiberacaoAcompanhante(id) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                mostrarErro('Armário não encontrado para liberação.');
                return;
            }
            const identificadores = montarIdentificadoresArmario(armario);

            const finalizarPreparacao = mostrarOverlayCarregamento('Preparando liberação do armário...');
            let termoDados = null;
            try {
                const respostaTermo = await callGoogleScript('getTermo', montarPayloadTermo(armario, { incluirFinalizados: true }));
                if (respostaTermo.success && respostaTermo.data) {
                    termoDados = respostaTermo.data;
                } else if (respostaTermo.error && respostaTermo.error !== 'Termo não encontrado') {
                    mostrarErro('Não foi possível carregar as informações do termo. Atualize a lista e tente novamente.');
                    return;
                }
            } catch (erroBuscaTermo) {
                console.error('Erro ao buscar termo para liberação:', erroBuscaTermo);
                mostrarErro('Não foi possível carregar as informações do termo. Tente novamente.');
                return;
            } finally {
                finalizarPreparacao();
            }

            if (termoDados) {
                armario.nomeVisitante = termoDados.acompanhante || armario.nomeVisitante;
                armario.nomePaciente = termoDados.paciente || armario.nomePaciente;
                armario.leito = termoDados.leito || armario.leito;
                if (termoDados.telefone) {
                    armario.whatsapp = termoDados.telefone;
                }
            }

            const paciente = termoDados?.paciente || armario.nomePaciente || '-';
            const prontuario = (termoDados?.prontuario || '').toString().trim();
            const setor = (termoDados?.setor || '').toString().trim();
            const leito = termoDados?.leito || armario.leito || '';
            const acompanhante = termoDados?.acompanhante || armario.nomeVisitante || '-';
            const telefone = (termoDados?.telefone || armario.whatsapp || '').toString().trim();
            const documento = (termoDados?.documento || '').toString().trim();
            const parentesco = (termoDados?.parentesco || '').toString().trim();
            const inicioUso = (armario.horaInicio || '').toString().trim();
            const aplicadoEmBruto = termoDados?.aplicadoEm ? formatarDataHora(termoDados.aplicadoEm) : '';
            const aplicadoEm = aplicadoEmBruto && aplicadoEmBruto !== '-' ? aplicadoEmBruto : '';
            const setorLeito = [setor, leito].map(valor => (valor || '').toString().trim()).filter(Boolean).join(' • ');
            const volumesResumo = (() => {
                if (termoDados?.descricaoVolumes) {
                    return termoDados.descricaoVolumes;
                }
                if (Array.isArray(termoDados?.volumes) && termoDados.volumes.length) {
                    return termoDados.volumes
                        .map(volume => {
                            const quantidadeNumero = Number(volume.quantidade);
                            const quantidadeTexto = Number.isFinite(quantidadeNumero) && quantidadeNumero > 0
                                ? `${quantidadeNumero}x`
                                : '';
                            const descricaoTexto = (volume.descricao || '').toString().trim();
                            return [quantidadeTexto, descricaoTexto].filter(Boolean).join(' ');
                        })
                        .filter(Boolean)
                        .join('; ');
                }
                const valorBruto = armario.volumes;
                if (valorBruto !== undefined && valorBruto !== null && valorBruto !== '') {
                    const numero = Number(valorBruto);
                    if (!Number.isNaN(numero)) {
                        return numero > 0 ? `${numero} volume(s)` : 'Nenhum volume informado';
                    }
                    return valorBruto;
                }
                return 'Não informado';
            })();

            const resumoHtml = `
                <div class="info-box" style="text-align:left;">
                    <p><strong>Acompanhante:</strong> ${acompanhante}</p>
                    <p><strong>Paciente:</strong> ${paciente}</p>
                    ${prontuario ? `<p><strong>Prontuário:</strong> ${prontuario}</p>` : ''}
                    ${setorLeito ? `<p><strong>Setor/Leito:</strong> ${setorLeito}</p>` : ''}
                    <p><strong>Volumes declarados:</strong> ${volumesResumo}</p>
                    ${inicioUso ? `<p><strong>Início:</strong> ${inicioUso}</p>` : ''}
                    ${aplicadoEm ? `<p><strong>Aplicado em:</strong> ${aplicadoEm}</p>` : ''}
                    ${telefone ? `<p><strong>Contato:</strong> ${telefone}</p>` : ''}
                    ${documento ? `<p><strong>Documento:</strong> ${documento}</p>` : ''}
                    ${parentesco ? `<p><strong>Parentesco:</strong> ${parentesco}</p>` : ''}
                </div>
            `;

            const resultadoConfirmacao = await Swal.fire({
                title: `Encerrar armário ${armario.numero}?`,
                html: `${resumoHtml}<p style="margin-top:12px; color:#4b5563;">Confirme que as informações estão corretas para finalizar o armário do acompanhante.</p>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Confirmo a liberação',
                cancelButtonText: 'Cancelar',
                focusConfirm: false
            });

            if (!resultadoConfirmacao.isConfirmed) {
                return;
            }

            const assinaturaFinalBase64 = await coletarAssinaturaEncerramento(acompanhante);
            if (!assinaturaFinalBase64) {
                await Swal.fire({
                    title: 'Liberação cancelada',
                    text: 'A assinatura de encerramento não foi coletada. O armário permanecerá ativo.',
                    icon: 'info',
                    confirmButtonText: 'Entendi'
                });
                return;
            }

            const metodo = 'assinatura';
            const confirmacao = '';
            let mensagemSucesso = 'Termo finalizado e armário liberado com sucesso';
            const usuarioResponsavel = obterDescricaoResponsavelAtual();

            const progressoHtml = `
                <div class="liberacao-progress" aria-label="Progresso da liberação do armário">
                    <div class="liberacao-step is-active" data-step="termo">
                        <div class="liberacao-step-icon" aria-hidden="true">
                            <span class="liberacao-step-spinner"></span>
                            <i class="fas fa-check"></i>
                            <i class="fas fa-circle-exclamation"></i>
                        </div>
                        <div>
                            <div class="liberacao-step-title">Finalizando termo</div>
                            <div class="liberacao-step-subtitle">Registrando o encerramento com segurança.</div>
                        </div>
                    </div>
                    <div class="liberacao-step" data-step="armario">
                        <div class="liberacao-step-icon" aria-hidden="true">
                            <span class="liberacao-step-spinner"></span>
                            <i class="fas fa-check"></i>
                            <i class="fas fa-circle-exclamation"></i>
                        </div>
                        <div>
                            <div class="liberacao-step-title">Liberando armário</div>
                            <div class="liberacao-step-subtitle">Atualizando a disponibilidade para o próximo uso.</div>
                        </div>
                    </div>
                </div>
            `;

            const atualizarEtapa = (etapa, estado) => {
                const container = Swal.getHtmlContainer();
                if (!container) return;
                const elemento = container.querySelector(`[data-step="${etapa}"]`);
                if (!elemento) return;
                elemento.classList.remove('is-active', 'is-complete', 'is-error');
                switch (estado) {
                    case 'ativa':
                        elemento.classList.add('is-active');
                        break;
                    case 'concluida':
                        elemento.classList.add('is-complete');
                        break;
                    case 'erro':
                        elemento.classList.add('is-error');
                        break;
                    default:
                        break;
                }
            };
            const aguardarTransicao = (tempo = 25) => new Promise(resolve => setTimeout(resolve, tempo));

            Swal.fire({
                title: 'Concluindo a liberação do armário...',
                html: progressoHtml,
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    const container = Swal.getHtmlContainer();
                    if (container) {
                        container.setAttribute('aria-live', 'assertive');
                    }
                    atualizarEtapa('termo', 'ativa');
                }
            });

            let etapaAtual = 'termo';

            try {
                const resultadoFinalizacao = await callGoogleScript('finalizarTermo', {
                    armarioId: identificadores?.idPlanilha || '',
                    numeroArmario: identificadores?.numeroArmario || '',
                    metodo,
                    assinaturaFinal: assinaturaFinalBase64,
                    confirmacao,
                    usuarioResponsavel,
                    tipo: identificadores?.tipo || ''
                });

                if (!resultadoFinalizacao.success) {
                    const mensagemErro = (resultadoFinalizacao.error || '').toString();
                    const erroNormalizado = mensagemErro.toLowerCase();
                    const erroSemAcento = erroNormalizado.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    const termoNaoEncontrado = erroNormalizado.includes('termo não localizado')
                        || erroSemAcento.includes('termo nao localizado');

                    if (!termoNaoEncontrado) {
                        atualizarEtapa('termo', 'erro');
                        await aguardarTransicao();
                        Swal.close();
                        notificarErroPadrao(resultadoFinalizacao, 'Não foi possível finalizar o termo.');
                        return;
                    }

                    mensagemSucesso = 'Armário liberado com sucesso. Termo não localizado para finalização.';
                }

                atualizarEtapa('termo', 'concluida');
                etapaAtual = 'armario';
                atualizarEtapa('armario', 'ativa');

                const resultadoLiberacao = await callGoogleScript('liberarArmario', {
                    id: identificadores?.idPlanilha || '',
                    tipo: 'acompanhante',
                    numero: identificadores?.numeroArmario || ''
                });

                if (!resultadoLiberacao.success) {
                    atualizarEtapa('armario', 'erro');
                    await aguardarTransicao();
                    Swal.close();
                    notificarErroPadrao(resultadoLiberacao);
                    return;
                }

                atualizarEtapa('armario', 'concluida');
                await aguardarTransicao();
                Swal.close();

                await atualizarDadosPosOperacao('Atualizando status do armário...', () => {
                    garantirArmarioLiberadoLocal(id, metodo, confirmacao);
                    atualizarResumoDashboardLocal();
                });
                mostrarSucesso(mensagemSucesso);
            } catch (erro) {
                console.error('Erro ao liberar armário de acompanhante:', erro);
                atualizarEtapa(etapaAtual, 'erro');
                await aguardarTransicao();
                Swal.close();
                mostrarErro('Não foi possível concluir a liberação. Tente novamente.');
            }
        }
        // Atualizar painel de notificações
        function atualizarPainelNotificacoes() {
            const notificationList = elementos.notificationPanel.querySelector('.notification-list');
            notificationList.innerHTML = '';
           
            estado.notificacoes.forEach(notificacao => {
                const item = document.createElement('div');
                item.className = 'notification-item';
               
                item.innerHTML = `
                    <div class="notification-icon ${notificacao.tipo}">
                        <i class="fas ${notificacao.tipo === 'danger' ? 'fa-exclamation' : 'fa-clock'}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notificacao.titulo}</div>
                        <div class="notification-time">${notificacao.tempo}</div>
                    </div>
                `;
               
                notificationList.appendChild(item);
            });
        }
       
        // Funções globais para uso nos eventos HTML
        window.abrirModalArmario = abrirModalArmario;
        window.liberarArmario = liberarArmario;
        window.usarArmario = usarArmario;
        window.abrirTermoDireto = abrirTermoDireto;
        window.abrirMovimentacoes = abrirMovimentacoes;
    </script>
</body>
</html>
